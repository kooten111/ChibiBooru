<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tag Manager - {{ app_name }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components-bundle.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/page-layout.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tag-manager.css') + '?v=3' }}">
</head>
<body>
    {% include 'header.html' %}

    <div class="page-container page-container-full">
        <!-- Page Header -->
        <div class="page-header" style="padding: var(--spacing-lg); margin-bottom: 0;">
            <div class="page-header-left">
                <h1 class="page-title">
                    <span class="page-title-icon">üè∑Ô∏è</span>
                    Tag Manager
                </h1>
            </div>
            <div class="page-header-center">
                <div class="tab-nav mode-tabs">
                    <button class="tab-btn mode-tab active" data-mode="tags">Tags</button>
                    <button class="tab-btn mode-tab" data-mode="images">Images</button>
                    <button class="tab-btn mode-tab" data-mode="stats">Statistics</button>
                </div>
            </div>
            <div class="page-header-right">
                <button class="action-btn action-btn-secondary" id="helpBtn" title="Keyboard shortcuts (?)">?</button>
            </div>
        </div>

        <!-- Working Set Bar -->
        <div class="working-set-bar" id="workingSetBar" style="padding: 0 var(--spacing-lg); margin-bottom: var(--spacing-md);">
            <div class="working-set-info">
                <span class="page-header-stat-value" id="workingSetCount">0</span>
                <span>images in working set</span>
            </div>
            <div class="working-set-thumbnails" id="workingSetThumbnails">
                <!-- Thumbnails populated by JS -->
            </div>
            <div class="page-actions">
                <button class="action-btn action-btn-primary" id="addTagsBtn">+ Tags</button>
                <button class="action-btn action-btn-danger" id="removeTagsBtn">- Tags</button>
                <button class="action-btn action-btn-secondary" id="clearWorkingSetBtn">Clear</button>
            </div>
        </div>

        <!-- Three-panel layout -->
        <div class="panel-layout tag-manager-layout" style="padding: 0 var(--spacing-lg) var(--spacing-lg);">
            <!-- Left Panel (Filters) -->
            <aside class="panel panel-left" id="leftPanel">
                <!-- Tags Mode Filters -->
                <div class="panel-content mode-content" data-mode="tags">
                    <div class="panel-section">
                        <h3 class="panel-section-title">Filters</h3>
                        <div class="filter-group">
                            <input type="text" id="tagSearchInput" class="filter-input" placeholder="Search tags...">
                        </div>
                    </div>

                    <div class="panel-section">
                        <h4 class="panel-section-title">Status</h4>
                        <div class="filter-radio-group">
                            <label class="filter-radio-label">
                                <input type="radio" name="tagStatus" value="all" checked>
                                <span>All</span>
                            </label>
                            <label class="filter-radio-label">
                                <input type="radio" name="tagStatus" value="uncategorized">
                                <span>Uncategorized</span>
                            </label>
                            <label class="filter-radio-label">
                                <input type="radio" name="tagStatus" value="needs_extended">
                                <span>Needs Extended</span>
                            </label>
                            <label class="filter-radio-label">
                                <input type="radio" name="tagStatus" value="orphaned">
                                <span>Orphaned</span>
                            </label>
                            <label class="filter-radio-label">
                                <input type="radio" name="tagStatus" value="low_usage">
                                <span>Low Usage (&lt;5)</span>
                            </label>
                        </div>
                    </div>

                    <div class="panel-section">
                        <h4 class="panel-section-title">Base Category</h4>
                        <div class="filter-checkbox-group">
                            <label class="filter-checkbox-label">
                                <input type="checkbox" name="baseCategory" value="character">
                                <span>Character</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" name="baseCategory" value="copyright">
                                <span>Copyright</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" name="baseCategory" value="artist">
                                <span>Artist</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" name="baseCategory" value="general">
                                <span>General</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" name="baseCategory" value="meta">
                                <span>Meta</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" name="baseCategory" value="species">
                                <span>Species</span>
                            </label>
                        </div>
                    </div>

                    <div class="panel-section">
                        <h4 class="panel-section-title">Sort By</h4>
                        <select id="tagSortSelect" class="filter-select">
                            <option value="count_desc">Count (High to Low)</option>
                            <option value="count_asc">Count (Low to High)</option>
                            <option value="alpha_asc">Name (A to Z)</option>
                            <option value="alpha_desc">Name (Z to A)</option>
                        </select>
                    </div>
                </div>

                <!-- Images Mode Filters -->
                <div class="panel-content mode-content" data-mode="images" style="display: none;">
                    <div class="panel-section">
                        <h3 class="panel-section-title">Find Images</h3>
                        <div class="filter-group">
                            <input type="text" id="imageSearchInput" class="filter-input" placeholder="Search images...">
                        </div>
                        <button class="action-btn action-btn-primary" id="imageSearchBtn" style="width: 100%;">Search</button>
                    </div>

                    <div class="panel-section">
                        <h4 class="panel-section-title">Search Behavior</h4>
                        <div class="filter-radio-group">
                            <label class="filter-radio-label">
                                <input type="radio" name="searchMode" value="replace" checked>
                                <span>Replace Results</span>
                            </label>
                            <label class="filter-radio-label">
                                <input type="radio" name="searchMode" value="add">
                                <span>Add to Working Set</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Stats Mode has no filters -->
                <div class="panel-content mode-content" data-mode="stats" style="display: none;">
                    <div class="panel-section">
                        <h3 class="panel-section-title">Statistics</h3>
                        <p class="empty-state-subtext">View comprehensive tag and image statistics.</p>
                    </div>
                </div>
            </aside>

            <!-- Center Panel (Content) -->
            <main class="panel panel-center" id="centerPanel">
                <!-- Tags Mode Content -->
                <div class="panel-content mode-content" data-mode="tags">
                    <div class="panel-header">
                        <h3 class="panel-title">Tags</h3>
                        <span class="page-header-stat" id="tagResultCount">Loading...</span>
                    </div>
                    <div class="tag-list-container">
                        <div class="empty-state" id="tagLoadingState">
                            <div class="empty-state-icon">‚è≥</div>
                            <div class="empty-state-text">Loading tags...</div>
                        </div>
                        <table class="tag-table" id="tagTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th width="40"><input type="checkbox" id="selectAllTags"></th>
                                    <th>Tag Name</th>
                                    <th>Base Category</th>
                                    <th>Extended Category</th>
                                    <th width="80">Count</th>
                                    <th width="80">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tagTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination-controls" id="tagPagination" style="display: none;">
                        <button class="action-btn action-btn-secondary" id="tagPrevBtn" disabled>Previous</button>
                        <span class="page-header-stat" id="tagPageInfo">Page 1</span>
                        <button class="action-btn action-btn-secondary" id="tagNextBtn">Next</button>
                        <select id="tagPerPageSelect" class="filter-select" style="width: auto;">
                            <option value="25">25 per page</option>
                            <option value="50" selected>50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                </div>

                <!-- Images Mode Content -->
                <div class="panel-content mode-content" data-mode="images" style="display: none;">
                    <div class="panel-header">
                        <h3 class="panel-title">Image Search Results</h3>
                        <div class="page-actions">
                            <button class="action-btn action-btn-secondary" id="selectAllImages">Select All</button>
                            <button class="action-btn action-btn-primary" id="addSelectedToWorkingSet">Add Selected</button>
                        </div>
                    </div>
                    <div class="image-grid-container">
                        <div class="empty-state" id="imageInfoState">
                            <div class="empty-state-icon">üîç</div>
                            <div class="empty-state-text">Search for images to begin</div>
                        </div>
                        <div class="image-grid" id="imageGrid">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="pagination-controls" id="imagePagination" style="display: none;">
                        <button class="action-btn action-btn-secondary" id="imagePrevBtn" disabled>Previous</button>
                        <span class="page-header-stat" id="imagePageInfo">Page 1</span>
                        <button class="action-btn action-btn-secondary" id="imageNextBtn">Next</button>
                    </div>
                </div>

                <!-- Stats Mode Content -->
                <div class="panel-content mode-content" data-mode="stats" style="display: none;">
                    <div class="stats-container" id="statsContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚è≥</div>
                            <div class="empty-state-text">Loading statistics...</div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right Panel (Detail) -->
            <aside class="panel panel-right" id="rightPanel">
                <!-- Tags Mode Detail -->
                <div class="panel-content mode-content" data-mode="tags">
                    <div class="panel-section">
                        <h3 class="panel-section-title">Tag Detail</h3>
                        <div class="empty-state" id="tagDetailEmpty">
                            <div class="empty-state-icon">üìã</div>
                            <div class="empty-state-text">Select a tag to view details</div>
                        </div>
                        <div class="detail-content" id="tagDetailContent" style="display: none;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Images Mode Detail (Bulk Tag Editor) -->
                <div class="panel-content mode-content" data-mode="images" style="display: none;">
                    <div class="panel-section">
                        <h3 class="panel-section-title">Bulk Tag Editor</h3>
                        <div class="bulk-editor-content" id="bulkEditorContent">
                            <div class="panel-section">
                                <h4 class="panel-section-title">Working Set</h4>
                                <div class="working-set-summary" id="workingSetSummary">
                                    <span class="mini-stat-value">0</span> images
                                </div>
                            </div>

                            <div class="panel-section">
                                <h4 class="panel-section-title">Current Tags</h4>
                                <div class="current-tags" id="currentTagsAll">
                                    <div class="panel-section-title" style="font-size: var(--font-size-xs);">On ALL images:</div>
                                    <div class="tag-chips" id="allTagsChips">
                                        <span class="empty-state-subtext">No common tags</span>
                                    </div>
                                </div>
                                <div class="current-tags" id="currentTagsSome" style="margin-top: var(--spacing-sm);">
                                    <div class="panel-section-title" style="font-size: var(--font-size-xs);">On SOME images:</div>
                                    <div class="tag-chips" id="someTagsChips">
                                        <span class="empty-state-subtext">No tags</span>
                                    </div>
                                </div>
                            </div>

                            <div class="panel-section">
                                <h4 class="panel-section-title">Add Tags</h4>
                                <input type="text" id="addTagInput" class="filter-input" placeholder="Enter tag name...">
                                <div class="tag-queue" id="addTagQueue"></div>
                                <button class="action-btn action-btn-primary" id="applyAddTagsBtn" style="width: 100%; margin-top: var(--spacing-sm);">Apply Add</button>
                            </div>

                            <div class="panel-section">
                                <h4 class="panel-section-title">Remove Tags</h4>
                                <div class="tag-queue" id="removeTagQueue"></div>
                                <button class="action-btn action-btn-danger" id="applyRemoveTagsBtn" style="width: 100%; margin-top: var(--spacing-sm);">Apply Remove</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Mode has no right panel -->
                <div class="panel-content mode-content" data-mode="stats" style="display: none;">
                    <!-- Empty -->
                </div>
            </aside>
        </div>
    </div>

    <!-- Page Footer -->
    <div class="page-footer">
        <div class="page-footer-left">
            <span class="page-footer-item" id="statusText">Ready</span>
        </div>
        <div class="page-footer-shortcuts">
            <span class="shortcut"><span class="shortcut-key">?</span> Shortcuts</span>
            <span class="shortcut"><span class="shortcut-key">1-3</span> Mode</span>
            <span class="shortcut"><span class="shortcut-key">/</span> Search</span>
        </div>
    </div>

    <!-- Bulk Operations Bar (appears when tags selected) -->
    <div class="bulk-operations-bar" id="bulkOperationsBar" style="display: none;">
        <span class="page-header-stat" id="bulkSelectionCount">0 selected</span>
        <select class="filter-select" id="bulkBaseCategorySelect" style="width: auto;">
            <option value="">Set Base Category...</option>
            <option value="general">General</option>
            <option value="character">Character</option>
            <option value="copyright">Copyright</option>
            <option value="artist">Artist</option>
            <option value="meta">Meta</option>
            <option value="species">Species</option>
        </select>
        <select class="filter-select" id="bulkExtendedCategorySelect" style="width: auto;">
            <option value="">Set Extended Category...</option>
            <option value="00_Subject_Count">00 Subject Count</option>
            <option value="01_Body_Physique">01 Body Physique</option>
            <option value="02_Body_Hair">02 Body Hair</option>
            <option value="03_Body_Face">03 Body Face</option>
            <option value="04_Body_Genitalia">04 Body Genitalia</option>
            <option value="05_Attire_Main">05 Attire Main</option>
            <option value="06_Attire_Inner">06 Attire Inner</option>
            <option value="07_Attire_Legwear">07 Attire Legwear</option>
            <option value="08_Attire_Acc">08 Attire Accessories</option>
            <option value="09_Action">09 Action</option>
            <option value="10_Pose">10 Pose</option>
            <option value="11_Expression">11 Expression</option>
            <option value="12_Sexual_Act">12 Sexual Act</option>
            <option value="13_Object">13 Object</option>
            <option value="14_Setting">14 Setting</option>
            <option value="15_Framing">15 Framing</option>
            <option value="16_Focus">16 Focus</option>
            <option value="17_Style_Art">17 Style Art</option>
            <option value="18_Style_Tech">18 Style Tech</option>
            <option value="19_Meta_Attributes">19 Meta Attributes</option>
            <option value="20_Meta_Text">20 Meta Text</option>
            <option value="21_Status">21 Status</option>
        </select>
        <button class="action-btn action-btn-primary" id="bulkCategorizeBtn">Apply</button>
        <button class="action-btn action-btn-secondary" id="bulkMergeBtn">Merge</button>
        <button class="action-btn action-btn-danger" id="bulkDeleteBtn">Delete</button>
        <button class="action-btn action-btn-secondary" id="bulkCancelBtn">Cancel</button>
    </div>

    <!-- Rename Tag Modal -->
    <div class="modal" id="renameModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('renameModal')">&times;</span>
            <h3>Rename Tag</h3>
            <div class="filter-group">
                <label class="filter-label">Current Name:</label>
                <div class="current-name" id="renameCurrentName"></div>
            </div>
            <div class="filter-group">
                <label class="filter-label">New Name:</label>
                <input type="text" id="renameNewName" class="filter-input">
            </div>
            <div class="filter-group">
                <label class="filter-checkbox-label">
                    <input type="checkbox" id="renameCreateAlias">
                    <span>Create alias from old name</span>
                </label>
            </div>
            <div class="page-actions" style="margin-top: var(--spacing-lg);">
                <button class="action-btn action-btn-secondary" onclick="closeModal('renameModal')">Cancel</button>
                <button class="action-btn action-btn-primary" id="confirmRenameBtn">Rename</button>
            </div>
        </div>
    </div>

    <!-- Merge Tags Modal -->
    <div class="modal" id="mergeModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('mergeModal')">&times;</span>
            <h3>Merge Tags</h3>
            <div class="filter-group">
                <label class="filter-label">Tags to merge:</label>
                <div id="mergeTagsList"></div>
            </div>
            <div class="filter-group">
                <label class="filter-label">Target tag:</label>
                <select id="mergeTargetSelect" class="filter-select">
                    <!-- Populated by JS -->
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-checkbox-label">
                    <input type="checkbox" id="mergeCreateAliases" checked>
                    <span>Create aliases from merged names</span>
                </label>
            </div>
            <div class="page-actions" style="margin-top: var(--spacing-lg);">
                <button class="action-btn action-btn-secondary" onclick="closeModal('mergeModal')">Cancel</button>
                <button class="action-btn action-btn-primary" id="confirmMergeBtn">Merge</button>
            </div>
        </div>
    </div>

    <!-- Delete Tag Modal -->
    <div class="modal" id="deleteModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('deleteModal')">&times;</span>
            <h3>Delete Tag(s)</h3>
            <div class="warning-message" style="padding: var(--spacing-md); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                <strong>Warning:</strong> This action cannot be undone.
            </div>
            <div class="filter-group">
                <label class="filter-label">Tags to delete:</label>
                <div id="deleteTagsList"></div>
            </div>
            <div class="filter-group">
                <label class="filter-checkbox-label">
                    <input type="checkbox" id="deleteRemoveFromImages" checked>
                    <span>Remove from all images</span>
                </label>
            </div>
            <div class="page-actions" style="margin-top: var(--spacing-lg);">
                <button class="action-btn action-btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="action-btn action-btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal" id="helpModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('helpModal')">&times;</span>
            <h3>Keyboard Shortcuts</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                <div class="panel-section">
                    <h4 class="panel-section-title">Global</h4>
                    <div class="page-footer-shortcuts" style="flex-direction: column; align-items: flex-start; gap: var(--spacing-xs);">
                        <span class="shortcut"><span class="shortcut-key">1</span> Tags mode</span>
                        <span class="shortcut"><span class="shortcut-key">2</span> Images mode</span>
                        <span class="shortcut"><span class="shortcut-key">3</span> Stats mode</span>
                        <span class="shortcut"><span class="shortcut-key">/</span> Focus search</span>
                        <span class="shortcut"><span class="shortcut-key">Esc</span> Close/clear</span>
                        <span class="shortcut"><span class="shortcut-key">?</span> Show shortcuts</span>
                    </div>
                </div>
                <div class="panel-section">
                    <h4 class="panel-section-title">Tag Mode</h4>
                    <div class="page-footer-shortcuts" style="flex-direction: column; align-items: flex-start; gap: var(--spacing-xs);">
                        <span class="shortcut"><span class="shortcut-key">j/k</span> Navigate</span>
                        <span class="shortcut"><span class="shortcut-key">Space</span> Toggle select</span>
                        <span class="shortcut"><span class="shortcut-key">Enter</span> Open detail</span>
                        <span class="shortcut"><span class="shortcut-key">e</span> Edit tag</span>
                        <span class="shortcut"><span class="shortcut-key">d</span> Delete tag(s)</span>
                        <span class="shortcut"><span class="shortcut-key">m</span> Merge tags</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/system-panel.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pages/tag-manager.js') + '?v=3' }}"></script>
    <script type="module">
        import { showNotification } from "{{ url_for('static', filename='js/utils/notifications.js') }}";
        window.showNotification = showNotification;
        window.closeModal = function (modalId) {
            document.getElementById(modalId).style.display = 'none';
        };
    </script>
</body>
</html>
