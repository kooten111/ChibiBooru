<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Categorize Tags - {{ app_name }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tag-categorization.css') + '?v=2' }}">
</head>
<body>
    <div class="categorize-container">
        <a href="{{ url_for('main.home') }}" class="back-link">‚Üê Back to Home</a>

        <div class="categorize-header">
            <div class="categorize-title">Categorize Tags</div>
            <div class="categorize-progress" id="categorizeProgress">Loading...</div>
        </div>

        <div class="stats-summary" id="statsSummary" style="display: none;">
            <div class="stat-box">
                <div class="stat-label">Total Tags</div>
                <div class="stat-value" id="statTotal">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Categorized</div>
                <div class="stat-value" id="statCategorized">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Uncategorized</div>
                <div class="stat-value" id="statUncategorized">0</div>
            </div>
        </div>

        <div class="categorize-layout">
            <div class="left-sidebar">
                <div class="categorization-guide">
                    <div class="guide-header">Category Guide</div>
                    <div class="guide-content">
                        <div class="guide-section">
                            <h3>Group 1: Identity</h3>
                            <ul>
                                <li><strong>00_Subject_Count:</strong> Count & gender</li>
                                <li><strong>01_Body_Physique:</strong> Permanent body traits</li>
                                <li><strong>02_Body_Hair:</strong> Head hair only</li>
                                <li><strong>03_Body_Face:</strong> Eyes & face marks</li>
                                <li><strong>04_Body_Genitalia:</strong> NSFW anatomy</li>
                            </ul>
                        </div>

                        <div class="guide-section">
                            <h3>Group 2: Context</h3>
                            <ul>
                                <li><strong>05_Attire_Main:</strong> Main clothing</li>
                                <li><strong>06_Attire_Inner:</strong> Underwear/swimwear</li>
                                <li><strong>07_Attire_Legwear:</strong> Socks & hosiery</li>
                                <li><strong>08_Attire_Acc:</strong> Accessories</li>
                                <li><strong>21_Status:</strong> State of being</li>
                                <li><strong>09_Action:</strong> Active verbs</li>
                                <li><strong>10_Pose:</strong> Body position</li>
                                <li><strong>11_Expression:</strong> Emotion</li>
                                <li><strong>12_Sexual_Act:</strong> NSFW interaction</li>
                                <li><strong>13_Object:</strong> Props</li>
                                <li><strong>14_Setting:</strong> Location</li>
                            </ul>
                        </div>

                        <div class="guide-section">
                            <h3>Group 3: Technical/Meta</h3>
                            <ul>
                                <li><strong>15_Framing:</strong> Camera angle</li>
                                <li><strong>16_Focus:</strong> Part focus</li>
                                <li><strong>17_Style_Art:</strong> Art style</li>
                                <li><strong>18_Style_Tech:</strong> Visual effects</li>
                                <li><strong>19_Meta_Attributes:</strong> Metadata</li>
                                <li><strong>20_Meta_Text:</strong> Text & UI</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tag-display" id="tagDisplay">
                <div class="loading-state" id="loadingState">
                    Loading tags...
                </div>
            </div>

            <div class="right-sidebar">
                <div class="import-export-section">
                    <div class="import-export-header">Import/Export</div>
                    <div class="import-export-buttons">
                        <button class="import-export-btn export-btn" onclick="exportCategorizations()">
                            <span class="btn-icon">‚¨á</span> Export
                        </button>
                        <button class="import-export-btn import-btn" onclick="document.getElementById('importFileInput').click()">
                            <span class="btn-icon">‚¨Ü</span> Import
                        </button>
                        <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                    </div>
                </div>

                <div class="edit-tag-section">
                    <div class="edit-tag-header">Edit Tag</div>
                    <div class="edit-tag-controls">
                        <input type="text" id="editTagInput" placeholder="Tag name..." class="edit-tag-input">
                        <button onclick="loadTagForEdit()" class="edit-tag-btn">Load</button>
                    </div>
                    <div id="editTagDisplay" class="edit-tag-display"></div>
                </div>

                <div class="tag-queue-sidebar">
                    <div class="queue-header">Next Tags</div>
                    <div class="queue-list" id="queueList">
                        <div class="queue-loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="custom-modal" style="display: none;">
        <div class="custom-modal-overlay" onclick="closeExportModal()"></div>
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h2>Export Tag Categorizations</h2>
                <button class="custom-modal-close" onclick="closeExportModal()">√ó</button>
            </div>
            <div class="custom-modal-body">
                <p>Choose which tags to export:</p>
                <div class="export-options">
                    <label class="export-option">
                        <input type="radio" name="exportType" value="categorized" checked>
                        <div class="option-content">
                            <strong>Categorized Tags Only</strong>
                            <span>Export only tags that have been categorized</span>
                        </div>
                    </label>
                    <label class="export-option">
                        <input type="radio" name="exportType" value="all">
                        <div class="option-content">
                            <strong>All Tags</strong>
                            <span>Export all tags (including uncategorized)</span>
                        </div>
                    </label>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeExportModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmExport()">Export</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="custom-modal" style="display: none;">
        <div class="custom-modal-overlay" onclick="closeImportModal()"></div>
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h2>Import Tag Categorizations</h2>
                <button class="custom-modal-close" onclick="closeImportModal()">√ó</button>
            </div>
            <div class="custom-modal-body">
                <p>Choose how to import the categorizations:</p>
                <div class="import-options">
                    <label class="import-option">
                        <input type="radio" name="importMode" value="merge" checked>
                        <div class="option-content">
                            <strong>Merge (Recommended)</strong>
                            <span>Keep existing categorizations, only categorize uncategorized tags</span>
                        </div>
                    </label>
                    <label class="import-option">
                        <input type="radio" name="importMode" value="update">
                        <div class="option-content">
                            <strong>Update</strong>
                            <span>Only update already categorized tags, leave uncategorized tags as-is</span>
                        </div>
                    </label>
                    <label class="import-option import-option-danger">
                        <input type="radio" name="importMode" value="overwrite">
                        <div class="option-content">
                            <strong>Overwrite (Dangerous)</strong>
                            <span>Replace ALL categorizations - this will overwrite existing work!</span>
                        </div>
                    </label>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeImportModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmImport()">Import</button>
            </div>
        </div>
    </div>

    <script>
        let currentTags = [];
        let currentIndex = 0;
        let availableCategories = [];
        let extendedCategories = []; // Full category data with shortcuts

        async function loadTags() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('tagDisplay').innerHTML = '<div class="loading-state">Loading tags...</div>';

            try {
                const response = await fetch('/api/tag_categorize/tags?limit=100');
                const data = await response.json();

                currentTags = data.tags || [];
                availableCategories = data.categories || [];
                extendedCategories = data.extended_categories || [];
                currentIndex = 0;

                // Load stats first to check actual uncategorized count
                await loadStats();

                // Check if there are truly no uncategorized tags (not just empty batch)
                const uncategorizedCount = parseInt(document.getElementById('statUncategorized').textContent) || 0;

                if (uncategorizedCount === 0) {
                    document.getElementById('tagDisplay').innerHTML =
                        '<div class="no-tags-state">All tags are categorized! üéâ</div>';
                } else {
                    displayCurrentTag();
                }
            } catch (error) {
                console.error('Error loading tags:', error);
                document.getElementById('tagDisplay').innerHTML =
                    '<div class="no-tags-state">Error loading tags: ' + error.message + '</div>';
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/tag_categorize/stats');
                const data = await response.json();

                // Use meaningful counts (tags actually used in images) instead of total counts
                const meaningfulTotal = (data.meaningful_categorized || 0) + (data.meaningful_uncategorized || 0);

                document.getElementById('statTotal').textContent = meaningfulTotal;
                document.getElementById('statCategorized').textContent = data.meaningful_categorized || 0;
                document.getElementById('statUncategorized').textContent = data.meaningful_uncategorized || 0;
                document.getElementById('statsSummary').style.display = 'grid';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function updateQueueList() {
            const queueList = document.getElementById('queueList');
            if (currentTags.length === 0) {
                queueList.innerHTML = '<div class="queue-empty">No more tags</div>';
                return;
            }

            // Show 25 tags: keep 3 previous tags visible + current + 21 upcoming
            const startIndex = Math.max(0, currentIndex - 3);
            const endIndex = Math.min(currentTags.length, startIndex + 25);
            const visibleTags = currentTags.slice(startIndex, endIndex);

            queueList.innerHTML = visibleTags.map((tag, idx) => {
                const actualIndex = startIndex + idx;
                const isActive = actualIndex === currentIndex;
                return `<div class="queue-item ${isActive ? 'queue-item-active' : ''}"
                             onclick="jumpToTag(${actualIndex})"
                             title="${tag.name} (${tag.usage_count} uses)">
                    <div class="queue-item-number">${actualIndex + 1}</div>
                    <div class="queue-item-name">${tag.name}</div>
                    <div class="queue-item-count">${tag.usage_count}</div>
                </div>`;
            }).join('');

            // Auto-scroll to active item
            setTimeout(() => {
                const activeItem = queueList.querySelector('.queue-item-active');
                if (activeItem) {
                    activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 50);
        }

        function jumpToTag(index) {
            if (index >= 0 && index < currentTags.length) {
                currentIndex = index;
                displayCurrentTag();
            }
        }

        function displayCurrentTag() {
            // Check actual uncategorized count from stats
            const uncategorizedCount = parseInt(document.getElementById('statUncategorized').textContent) || 0;

            if (currentTags.length === 0 && uncategorizedCount === 0) {
                document.getElementById('tagDisplay').innerHTML =
                    '<div class="no-tags-state">All tags are categorized! üéâ</div>';
                document.getElementById('queueList').innerHTML = '<div class="queue-empty">No more tags</div>';
                return;
            }

            if (currentTags.length === 0) {
                document.getElementById('tagDisplay').innerHTML =
                    '<div class="no-tags-state">No tags in current batch. Try refreshing the page.</div>';
                document.getElementById('queueList').innerHTML = '<div class="queue-empty">No more tags</div>';
                return;
            }

            const tag = currentTags[currentIndex];
            const progress = `Tag ${currentIndex + 1} / ${currentTags.length}`;
            document.getElementById('categorizeProgress').textContent = progress;

            // Update queue list
            updateQueueList();

            const sampleImages = tag.sample_images || [];
            const imageGallery = sampleImages.length > 0
                ? `<div class="sample-images">
                    ${sampleImages.map(filepath => {
                        const isVideo = filepath.endsWith('.mp4') || filepath.endsWith('.webm');
                        const videoType = filepath.endsWith('.webm') ? 'video/webm' : 'video/mp4';
                        return isVideo
                            ? `<video controls loop preload="metadata"><source src="/static/images/${filepath}" type="${videoType}"></video>`
                            : `<img src="/static/images/${filepath}" alt="Sample image">`;
                    }).join('')}
                  </div>`
                : '<div class="no-samples">No sample images available</div>';

            document.getElementById('tagDisplay').innerHTML = `
                <div class="tag-info">
                    <div class="tag-name">${tag.name}</div>
                    <div class="tag-usage">Used in ${tag.usage_count} image${tag.usage_count !== 1 ? 's' : ''}</div>
                    ${imageGallery}

                    <div class="category-buttons">
                        ${extendedCategories.map(catData => {
                            const [catKey, catName, shortcut, description] = catData;
                            const cssClass = catKey.replace(/_/g, '-').toLowerCase();
                            return `<button class="category-btn category-btn-${cssClass}"
                                    onclick="setCategory('${catKey}')"
                                    title="${description}">
                                ${catName}<br><small>(${shortcut})</small>
                            </button>`;
                        }).join('')}
                    </div>

                    <div class="navigation-buttons">
                        <button class="nav-btn" onclick="previousTag()" ${currentIndex === 0 ? 'disabled' : ''}>
                            ‚Üê Previous (P)
                        </button>
                        <button class="nav-btn" onclick="showSuggestion()">
                            Suggest (?)
                        </button>
                        <button class="nav-btn" onclick="skipTag()">
                            Skip (K)
                        </button>
                        <button class="nav-btn nav-btn-primary" onclick="nextTag()" ${currentIndex >= currentTags.length - 1 ? 'disabled' : ''}>
                            Next (N / ‚Üí)
                        </button>
                    </div>
                </div>
            `;
        }

        async function showSuggestion() {
            const tag = currentTags[currentIndex];

            try {
                const response = await fetch(`/api/tag_categorize/tag_details?tag_name=${encodeURIComponent(tag.name)}`);
                const data = await response.json();

                if (data.suggested_category) {
                    showNotification(`Suggested: ${data.suggested_category}`, 'info');

                    // Auto-select the suggested category
                    if (confirm(`Categorize "${tag.name}" as "${data.suggested_category}"?`)) {
                        await setCategory(data.suggested_category);
                    }
                } else {
                    showNotification('No suggestion available', 'info');
                }
            } catch (error) {
                console.error('Error getting suggestion:', error);
                showNotification('Error getting suggestion: ' + error.message, 'error');
            }
        }

        async function setCategory(category) {
            const tag = currentTags[currentIndex];

            try {
                const response = await fetch('/api/tag_categorize/set', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tag_name: tag.name,
                        category: category
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`"${tag.name}" ‚Üí ${category}`, 'success');
                    // Remove the tag from the list
                    currentTags.splice(currentIndex, 1);

                    // Update stats
                    await loadStats();

                    // Display next tag (or stay at same index since we removed one)
                    if (currentIndex >= currentTags.length) {
                        currentIndex = currentTags.length - 1;
                    }
                    displayCurrentTag();
                } else {
                    showNotification('Error: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error setting category:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function nextTag() {
            if (currentIndex < currentTags.length - 1) {
                currentIndex++;
                displayCurrentTag();
            } else {
                showNotification('No more tags', 'info');
            }
        }

        function previousTag() {
            if (currentIndex > 0) {
                currentIndex--;
                displayCurrentTag();
            }
        }

        function skipTag() {
            nextTag();
        }

        async function loadTagForEdit() {
            const tagName = document.getElementById('editTagInput').value.trim();
            if (!tagName) {
                showNotification('Please enter a tag name', 'error');
                return;
            }

            const editDisplay = document.getElementById('editTagDisplay');
            editDisplay.innerHTML = '<div class="loading-state">Loading tag...</div>';

            try {
                const response = await fetch(`/api/tag_categorize/tag_details?tag_name=${encodeURIComponent(tagName)}`);
                const data = await response.json();

                if (!data || data.error) {
                    editDisplay.innerHTML = `<div class="no-tags-state">Tag "${tagName}" not found</div>`;
                    return;
                }

                const tag = data;
                editDisplay.innerHTML = `
                    <div class="edit-tag-info">
                        <div class="edit-tag-name">${tag.name}</div>
                        <div class="edit-tag-meta">
                            <span>Current Category: <strong>${tag.category || 'Uncategorized'}</strong></span>
                            <span>Usage Count: ${tag.usage_count || 0}</span>
                        </div>
                        <div class="category-buttons">
                            ${extendedCategories.map(catData => {
                                const [catKey, catName, shortcut, description] = catData;
                                const cssClass = catKey.replace(/_/g, '-').toLowerCase();
                                return `<button class="category-btn category-btn-${cssClass}"
                                        onclick="updateTagCategory('${tag.name}', '${catKey}')"
                                        title="${description}">
                                    ${catName}
                                </button>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading tag:', error);
                editDisplay.innerHTML = `<div class="no-tags-state">Error loading tag: ${error.message}</div>`;
            }
        }

        async function updateTagCategory(tagName, category) {
            try {
                const response = await fetch('/api/tag_categorize/set', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tag_name: tagName,
                        category: category
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`"${tagName}" updated to ${category}`, 'success');
                    document.getElementById('editTagInput').value = '';
                    document.getElementById('editTagDisplay').innerHTML = '';
                    await loadStats();
                } else {
                    showNotification('Error: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error updating category:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Allow Enter key to load tag
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('editTagInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadTagForEdit();
                }
            });
        });

        // Export modal functions
        function exportCategorizations() {
            document.getElementById('exportModal').style.display = 'flex';
        }

        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        async function confirmExport() {
            const exportType = document.querySelector('input[name="exportType"]:checked').value;
            const categorizedOnly = exportType === 'categorized';

            closeExportModal();

            try {
                const url = `/api/tag_categorize/export?categorized_only=${categorizedOnly}`;

                showNotification('Exporting tag categorizations...', 'info');

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Export failed: ${response.statusText}`);
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `tag_categorizations_${new Date().toISOString()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);

                showNotification('Export completed successfully!', 'success');
            } catch (error) {
                console.error('Error exporting:', error);
                showNotification('Error exporting: ' + error.message, 'error');
            }
        }

        // Import modal functions
        let importFileData = null;

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            importFileData = null;
        }

        async function confirmImport() {
            const mode = document.querySelector('input[name="importMode"]:checked').value;

            closeImportModal();

            if (!importFileData) {
                showNotification('No import data available', 'error');
                return;
            }

            try {
                showNotification('Importing tag categorizations...', 'info');

                const response = await fetch(`/api/tag_categorize/import?mode=${mode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(importFileData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`Import completed! Updated: ${result.updated}, Skipped: ${result.skipped}`, 'success');

                    // Reload tags and stats
                    await loadStats();
                    await loadTags();
                } else {
                    showNotification('Error importing: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error importing:', error);
                showNotification('Error importing: ' + error.message, 'error');
            } finally {
                importFileData = null;
            }
        }

        // Handle import file selection
        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                // Store the data and show the modal
                importFileData = data;
                document.getElementById('importModal').style.display = 'flex';
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('Error reading file: ' + error.message, 'error');
            } finally {
                // Reset file input
                event.target.value = '';
            }
        }

        // Load tags on page load
        loadTags();
    </script>
    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script type="module">
        import { showNotification } from "{{ url_for('static', filename='js/utils/notifications.js') }}";
        window.showNotification = showNotification;
    </script>
</body>
</html>
