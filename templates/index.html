<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HomeBooru</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shared.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/stats-tabs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/system-panel.css') }}">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1><a href="{{ url_for('main.home') }}">HomeBooru</a></h1>
            <div class="search-bar">
                <form action="{{ url_for('main.home') }}" method="get" id="searchForm">
                    <div class="autocomplete-container">
                        <input type="text" name="query" id="searchInput" placeholder="Search tags..." value="{{ query or '' }}" autocomplete="off">
                        <div class="autocomplete-suggestions" id="autocompleteSuggestions"></div>
                    </div>
                    <button type="submit">Search</button>
                </form>
            </div>
        </div>
    </div>

    {% if stats and not query %}
    <div class="stats-tabs-wrapper">
        <div class="stats-tabs-bar">
            <button class="stat-tab-button" data-tab="overview-panel">
                <span class="icon">ğŸ“Š</span>
                <span>Overview</span>
            </button>
            
            {% if stats.source_breakdown %}
            <button class="stat-tab-button" data-tab="sources-panel">
                <span class="icon">ğŸŒ</span>
                <span>Sources</span>
            </button>
            {% endif %}
            
            {% if stats.top_tags %}
            <button class="stat-tab-button" data-tab="top-tags-panel">
                <span class="icon">ğŸ†</span>
                <span>Top Tags</span>
            </button>
            {% endif %}
            
            {% if stats.category_counts %}
            <button class="stat-tab-button" data-tab="categories-panel">
                <span class="icon">ğŸ·ï¸</span>
                <span>Categories</span>
            </button>
            {% endif %}
            
            {% if random_tags %}
            <button class="stat-tab-button" data-tab="explore-panel">
                <span class="icon">ğŸ²</span>
                <span>Explore</span>
            </button>
            {% endif %}
            
            <button class="stat-tab-button" data-tab="system-panel">
                <span class="icon">âš™ï¸</span>
                <span>System</span>
            </button>
        </div>
        
        <div class="stats-panels-container" id="statsPanelsContainer">
            <div class="stat-panel panel" id="overview-panel">
                <h3><span>ğŸ“Š</span> Collection Overview</h3>
                <div class="stats-grid">
                    <a href="{{ url_for('main.home') }}" style="text-decoration: none; color: inherit;">
                        <div class="stat-card">
                            <div class="stat-card-number">{{ stats.total }}</div>
                            <div class="stat-card-label">Total Images</div>
                        </div>
                    </a>
                    <a href="{{ url_for('main.home', query='metadata:found') }}" style="text-decoration: none; color: inherit;">
                        <div class="stat-card success">
                            <div class="stat-card-number">{{ stats.with_metadata }}</div>
                            <div class="stat-card-label">With Metadata</div>
                        </div>
                    </a>
                    <a href="{{ url_for('main.home', query='metadata:missing') }}" style="text-decoration: none; color: inherit;">
                        <div class="stat-card warning">
                            <div class="stat-card-number">{{ stats.without_metadata }}</div>
                            <div class="stat-card-label">Missing Metadata</div>
                        </div>
                    </a>
                    <div class="stat-card">
                        <div class="stat-card-number">{{ stats.total_tags }}</div>
                        <div class="stat-card-label">Unique Tags</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-number">{{ stats.avg_tags_per_image }}</div>
                        <div class="stat-card-label">Avg Tags/Image</div>
                    </div>
                    {% if stats.saucenao_used > 0 %}
                    <div class="stat-card">
                        <div class="stat-card-number">{{ stats.saucenao_used }}</div>
                        <div class="stat-card-label">SauceNao Lookups</div>
                    </div>
                    {% endif %}
                    {% if stats.camie_used > 0 %}
                    <a href="{{ url_for('main.home', query='source:camie_tagger') }}" style="text-decoration: none; color: inherit;">
                        <div class="stat-card">
                            <div class="stat-card-number">{{ stats.camie_used }}</div>
                            <div class="stat-card-label">AI Tagged</div>
                        </div>
                    </a>
                    {% endif %}
                </div>
            </div>

            {% if stats.source_breakdown %}
            <div class="stat-panel panel" id="sources-panel">
                <h3><span>ğŸŒ</span> Source Breakdown</h3>
                <div class="source-breakdown">
                    {% for source, count in stats.source_breakdown.items() %}
                    <a href="{{ url_for('main.home', query='source:' + source) }}" class="source-badge" style="text-decoration: none;">
                        <span class="source-name">{{ source }}</span>
                        <span class="source-count">{{ count }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if stats.top_tags %}
            <div class="stat-panel panel" id="top-tags-panel">
                <h3><span>ğŸ†</span> Most Popular Tags</h3>
                <div class="top-tags-list">
                    {% for tag, count in stats.top_tags %}
                    <a href="{{ url_for('main.home', query=tag) }}" class="top-tag-item">
                        <span>{{ tag }}</span>
                        <span class="top-tag-count">
                            {% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >= 1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}
                        </span>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if stats.category_counts %}
            <div class="stat-panel panel" id="categories-panel">
                <h3><span>ğŸ·ï¸</span> Tag Categories</h3>
                <div class="category-breakdown">
                    {% for category, count in stats.category_counts.items() %}
                    {% if count > 0 %}
                    <a href="{{ url_for('main.home', query='category:' + category) }}" style="text-decoration: none; color: inherit;">
                        <div class="category-card {{ category }}">
                            <div class="category-number">{{ count }}</div>
                            <div class="category-label">{{ category }}</div>
                        </div>
                    </a>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if random_tags %}
            <div class="stat-panel panel" id="explore-panel">
                <h3><span>ğŸ²</span> Explore Random Tags</h3>
                <div class="source-breakdown">
                    {% for tag, count in random_tags %}
                    <a href="{{ url_for('main.home', query=tag) }}" class="source-badge" style="text-decoration: none;">
                        <span class="source-name">{{ tag }}</span>
                        <span class="source-count">
                            {% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >= 1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}
                        </span>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="stat-panel panel" id="system-panel">
                <h3><span>âš™ï¸</span> System Control</h3>
                
                <div id="secretSection"></div>
                
                <div class="system-status" id="systemStatus">
                    <div class="status-loading">Loading status...</div>
                </div>
                
                <div class="system-actions" id="systemActionsSection">
                    <h4>Actions</h4>
                    <div class="system-buttons">
                        <button class="btn btn-primary" onclick="systemScanImages(event)">
                            ğŸ” Scan & Process New Images
                        </button>
                        <button class="btn btn-primary" onclick="systemRebuildTags(event)">
                            ğŸ”„ Rebuild Tags from Metadata
                        </button>
                        <button class="btn btn-primary" onclick="systemGenerateThumbnails(event)">
                            ğŸ–¼ï¸ Generate Thumbnails
                        </button>
                        <button class="btn btn-danger" onclick="systemDeduplicate(event)">
                            ğŸ—‘ï¸ Deduplicate Images
                        </button>
                        <button class="btn btn-success" onclick="systemReloadData(event)">
                            â†» Reload Data
                        </button>
                    </div>
                    
                    <h4>Monitor Control</h4>
                    <div class="system-buttons">
                        <button id="monitorToggleBtn" class="btn btn-success">
                            â–¶ï¸ Start Monitor
                        </button>
                    </div>
                    
                    <h4>Activity Log</h4>
                    <div class="system-logs" id="systemLogs">
                        <div class="log-entry info">No recent activity</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="container">
        {% if query and total_results is defined %}
        <div class="results-info">
            Found {{ total_results }} result{% if total_results != 1 %}s{% endif %}
        </div>
        {% endif %}

        <div class="gallery">
            {% for image in images %}
            <div class="thumbnail">
                <a href="{{ url_for('main.show_image', filepath=image.path) }}">
                    <img src="{{ url_for('static', filename=image.thumb) }}" alt="Image" loading="lazy">
                    {% if show_similarity and image.similarity %}
                    <div style="position: absolute; top: 5px; right: 5px; background-color: rgba(0,0,0,0.8); color: #87ceeb; padding: 4px 8px; border-radius: 3px; font-size: 0.85em; font-weight: bold;">
                        {{ "%.0f"|format(image.similarity * 100) }}%
                    </div>
                    {% endif %}
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='js/stats-tabs.js') }}"></script>
    <script src="{{ url_for('static', filename='js/infinite-scroll.js') }}"></script>
    <script src="{{ url_for('static', filename='js/system-panel.js') }}"></script>
</body>
</html>