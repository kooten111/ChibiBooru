<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Character Management - {{ app_name }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components-bundle.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rating.css') + '?v=2' }}">
</head>

<body>
    {% include 'header.html' %}

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner">‚è≥</div>
            <div id="loadingMessage">Processing...</div>
        </div>
    </div>

    <div class="rate-container">
        <div class="page-header">
            <h1>Character Management</h1>
            <p>Train and manage the automatic character inference system</p>
        </div>

        <!-- Model Status Section -->
        <div class="section">
            <h2>Model Status</h2>
            <div class="model-status" id="modelStatus">
                <div class="stat-box">
                    <div class="stat-label">Status</div>
                    <div class="stat-value small" id="trainedStatus">Loading...</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Last Trained</div>
                    <div class="stat-value small" id="lastTrained">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Training Samples</div>
                    <div class="stat-value" id="trainingSamples">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Unique Characters</div>
                    <div class="stat-value" id="uniqueCharacters">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Unique Tags</div>
                    <div class="stat-value" id="uniqueTags">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Untagged Images</div>
                    <div class="stat-value" id="untaggedCount">-</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="section">
            <h2>Actions</h2>
            <div class="action-buttons">
                <button class="action-btn action-btn-success" onclick="trainModel()">
                    üéì Train Model
                </button>
                <button class="action-btn action-btn-primary" onclick="inferCharacters()">
                    üîÆ Infer All Characters
                </button>
                <button class="action-btn action-btn-warning" onclick="clearAI()">
                    üóëÔ∏è Clear AI Characters
                </button>
                <button class="action-btn action-btn-danger" onclick="retrainAll()">
                    ‚ôªÔ∏è Retrain & Reapply All
                </button>
            </div>

            <div class="log-output" id="actionLog" style="margin-top: 20px; display: none;">
                <strong>Action Log:</strong>
                <pre id="actionLogContent"></pre>
            </div>
        </div>

        <!-- Character Distribution Section -->
        <div class="section">
            <h2>Character Distribution</h2>
            <div style="margin-bottom: 15px;">
                <input type="text" id="characterSearch" placeholder="Search characters..." 
                    style="width: 100%; max-width: 400px; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-panel);">
            </div>
            <div class="distribution-grid" id="characterGrid" style="max-height: 400px; overflow-y: auto;">
                <!-- Will be populated by JavaScript -->
            </div>
            <button class="action-btn action-btn-primary" onclick="scrollToExplorer()" style="margin-top: 20px;">
                üîç Explore Predictions
            </button>
        </div>

        <!-- Configuration Section -->
        <div class="section">
            <h2>Configuration</h2>
            <div class="config-grid" id="configGrid">
                <!-- Will be populated by JavaScript -->
            </div>
            <button class="action-btn action-btn-primary" onclick="saveConfig()" style="margin-top: 20px;">
                üíæ Save Configuration
            </button>
        </div>

        <!-- Prediction Explorer Section -->
        <div class="section">
            <h2>Prediction Explorer</h2>
            <div style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <div>
                    <label for="imageFilter" style="margin-right: 10px;">Filter:</label>
                    <select id="imageFilter" onchange="loadImages()"
                        style="padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-panel);">
                        <option value="untagged">‚ùì Untagged Only</option>
                        <option value="ai_predicted">ü§ñ AI-Inferred Only</option>
                        <option value="all">üìã All with Characters</option>
                    </select>
                </div>
                <div>
                    <label for="imageLimit" style="margin-right: 10px;">Limit:</label>
                    <input type="number" id="imageLimit" value="50" min="10" max="500" step="10" onchange="loadImages()"
                        style="width: 80px; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-panel);">
                </div>
                <button onclick="loadImages()" class="action-btn action-btn-primary">
                    üîÑ Refresh
                </button>
                <div style="margin-left: auto;">
                    <span id="imageCount" style="color: #888; font-size: 0.9em;">0 images loaded</span>
                </div>
            </div>

            <div id="imagesContainer"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Prediction Detail Modal -->
    <div id="predictionModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>Character Predictions</h2>
                <button class="close-modal" onclick="closePredictionModal()">√ó</button>
            </div>
            <div class="modal-body" id="predictionModalBody">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/system-panel.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pages/character-manage.js') }}"></script>
    <script type="module">
        import { showNotification } from "{{ url_for('static', filename='js/utils/notifications.js') }}";
        window.showNotification = showNotification;
    </script>
</body>

</html>
