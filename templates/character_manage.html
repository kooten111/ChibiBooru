<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Character Management - {{ app_name }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components-bundle.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/page-layout.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/character-manage.css') + '?v=2' }}">
</head>
<body>
    {% include 'header.html' %}

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner">‚è≥</div>
            <div class="loading-message" id="loadingMessage">Processing...</div>
        </div>
    </div>

    <div class="page-container page-container-full">
        <!-- Page Header -->
        <div class="page-header" style="padding: var(--spacing-lg); margin-bottom: 0;">
            <div class="page-header-left">
                <h1 class="page-title">
                    <span class="page-title-icon">üß†</span>
                    Character Management
                </h1>
                <span class="page-status-badge" id="modelBadge">Loading...</span>
            </div>
            <div class="page-header-stats">
                <div class="page-header-stat">
                    <span class="page-header-stat-value" id="characterCount">0</span>
                    <span>characters</span>
                </div>
                <div class="page-header-stat">
                    <span class="page-header-stat-value" id="untaggedCount">0</span>
                    <span>untagged</span>
                </div>
            </div>
            <div class="page-header-right">
                <button class="action-btn action-btn-success" onclick="trainModel()">Train</button>
                <button class="action-btn action-btn-primary" onclick="inferCharacters()">Infer All</button>
                <button class="action-btn action-btn-warning" onclick="clearAI()">Clear AI</button>
                <button class="action-btn action-btn-danger" onclick="retrainAll()">Full Retrain</button>
            </div>
        </div>

        <!-- Three-panel layout -->
        <div class="panel-layout" style="padding: 0 var(--spacing-lg) var(--spacing-lg);">
            <!-- Left Panel - Character List -->
            <aside class="panel panel-left">
                <div class="panel-section">
                    <div class="filter-group">
                        <input type="text" id="characterSearch" class="filter-input" placeholder="Search characters...">
                    </div>

                    <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                        <select class="filter-select" id="sourceFilter" style="flex: 1;">
                            <option value="all">All Sources</option>
                            <option value="user">User</option>
                            <option value="ai">AI</option>
                            <option value="booru">Booru</option>
                        </select>

                        <select class="filter-select" id="sortBy" style="flex: 1;">
                            <option value="total">Total</option>
                            <option value="samples">Samples</option>
                            <option value="name">Name</option>
                        </select>

                        <button class="action-btn action-btn-secondary" id="sortDirection" title="Toggle sort direction" style="padding: var(--spacing-sm);">‚Üì</button>
                    </div>

                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value" id="shownCount">0</div>
                            <div class="mini-stat-label">Shown</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value" id="totalSamples">0</div>
                            <div class="mini-stat-label">Samples</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value" id="untaggedMiniCount">0</div>
                            <div class="mini-stat-label">Untagged</div>
                        </div>
                    </div>
                </div>

                <div class="list-container" id="characterList" style="max-height: calc(100vh - 400px);">
                    <!-- Populated by JavaScript -->
                </div>
            </aside>

            <!-- Center Panel - Main Content -->
            <main class="panel panel-center">
                <div class="tab-nav">
                    <button class="tab-btn" data-tab="images">Character Images</button>
                    <button class="tab-btn active" data-tab="prediction">Prediction Preview</button>
                    <button class="tab-btn" data-tab="insights">Model Insights</button>
                </div>

                <div class="character-tab-content">
                    <!-- Images Tab -->
                    <div class="tab-pane character-tab-pane" id="imagesPane">
                        <div class="image-grid" id="characterImagesGrid">
                            <div class="empty-state">
                                <div class="empty-state-icon">üëà</div>
                                <div class="empty-state-text">Select a character</div>
                                <div class="empty-state-subtext">Choose a character from the list to view their images</div>
                            </div>
                        </div>
                    </div>

                    <!-- Prediction Tab -->
                    <div class="tab-pane character-tab-pane active" id="predictionPane">
                        <div class="panel-section">
                            <div style="display: flex; gap: var(--spacing-md); align-items: flex-end;">
                                <div class="filter-group" style="flex: 1; margin-bottom: 0;">
                                    <label class="filter-label">Image ID</label>
                                    <input type="number" id="predictionImageId" class="filter-input" placeholder="Enter image ID">
                                </div>
                                <button class="action-btn action-btn-primary" onclick="predictImageById()">Predict</button>
                            </div>
                        </div>

                        <div class="character-prediction-results" id="predictionResults">
                            <div class="empty-state">
                                <div class="empty-state-icon">üîÆ</div>
                                <div class="empty-state-text">No predictions yet</div>
                                <div class="empty-state-subtext">Enter an image ID and click Predict</div>
                            </div>
                        </div>
                    </div>

                    <!-- Insights Tab -->
                    <div class="tab-pane character-tab-pane" id="insightsPane">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-card-value" id="trainingSamples">-</div>
                                <div class="stat-card-label">Training Samples</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-value" id="uniqueCharacters">-</div>
                                <div class="stat-card-label">Unique Characters</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-value" id="uniqueTags">-</div>
                                <div class="stat-card-label">Unique Tags</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-value" id="lastTrained" style="font-size: var(--font-size-sm);">Never</div>
                                <div class="stat-card-label">Last Trained</div>
                            </div>
                        </div>

                        <div class="panel-section" style="margin-top: var(--spacing-lg);">
                            <h3 class="panel-section-title">Character Distribution</h3>
                            <div id="distributionChart" class="distribution-grid">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right Panel - Details/Weights/Config -->
            <aside class="panel panel-right">
                <div class="tab-nav" style="margin-bottom: var(--spacing-md);">
                    <button class="tab-btn character-right-tab-btn active" data-tab="details">Details</button>
                    <button class="tab-btn character-right-tab-btn" data-tab="weights">Weights</button>
                    <button class="tab-btn character-right-tab-btn" data-tab="config">Config</button>
                </div>

                <!-- Details Pane -->
                <div class="character-right-pane active" id="detailsPane">
                    <div class="panel-section">
                        <h3 class="panel-section-title">Character Info</h3>
                        <div id="characterInfo">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ÑπÔ∏è</div>
                                <div class="empty-state-text">No selection</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weights Pane -->
                <div class="character-right-pane" id="weightsPane">
                    <div class="panel-section">
                        <h3 class="panel-section-title">Tag Weights</h3>
                        <div id="tagWeights">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚öñÔ∏è</div>
                                <div class="empty-state-text">No selection</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Config Pane -->
                <div class="character-right-pane" id="configPane">
                    <div class="panel-section">
                        <h3 class="panel-section-title">Model Configuration</h3>
                        <div class="character-config-grid" id="configGrid">
                            <!-- Populated by JavaScript -->
                        </div>
                        <button class="action-btn action-btn-primary" onclick="saveConfig()" style="width: 100%; margin-top: var(--spacing-md);">
                            Save Configuration
                        </button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Page Footer -->
    <div class="page-footer">
        <div class="page-footer-left">
            <span class="page-footer-item">
                <span>Last trained:</span>
                <span id="footerLastTrained">Never</span>
            </span>
            <span class="page-footer-item">
                <span>Tags in model:</span>
                <span id="footerTagsCount">0</span>
            </span>
        </div>
        <div class="page-footer-shortcuts">
            <span class="shortcut"><span class="shortcut-key">?</span> Help</span>
        </div>
    </div>

    <!-- Action Log -->
    <div class="log-output" id="actionLog" style="position: fixed; bottom: 60px; right: 20px; max-width: 400px; max-height: 300px; overflow-y: auto; display: none; z-index: 1000; background: var(--bg-panel-dark); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--spacing-lg); box-shadow: var(--shadow-lg);">
        <strong>Action Log:</strong>
        <pre id="actionLogContent" style="margin-top: var(--spacing-sm); white-space: pre-wrap;"></pre>
    </div>

    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/system-panel.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pages/character-manage.js') + '?v=2' }}"></script>
    <script type="module">
        import { showNotification } from "{{ url_for('static', filename='js/utils/notifications.js') }}";
        window.showNotification = showNotification;
    </script>
</body>
</html>
