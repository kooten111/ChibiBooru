<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Character Management - {{ app_name }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components-bundle.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rating.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/character-manage.css') + '?v=1' }}">
</head>

<body>
    {% include 'header.html' %}

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner">‚è≥</div>
            <div id="loadingMessage">Processing...</div>
        </div>
    </div>

    <div class="character-manage-container">
        <!-- Left Panel - Character List -->
        <div class="character-left-panel">
            <div class="character-left-panel-header">
                <div class="character-search-box">
                    <span class="character-search-icon">üîç</span>
                    <input type="text" id="characterSearch" placeholder="Search characters...">
                </div>
                
                <div class="character-filters">
                    <select class="character-filter-select" id="sourceFilter">
                        <option value="all">All Sources</option>
                        <option value="user">üë• User</option>
                        <option value="ai">ü§ñ AI</option>
                        <option value="booru">üìö Booru</option>
                    </select>
                    
                    <select class="character-filter-select" id="sortBy">
                        <option value="total">Total</option>
                        <option value="samples">Samples</option>
                        <option value="name">Name</option>
                    </select>
                    
                    <button class="character-sort-toggle" id="sortDirection" title="Toggle sort direction">‚Üì</button>
                </div>
                
                <div class="character-mini-stats">
                    <div class="character-mini-stat">
                        <div class="character-mini-stat-value" id="shownCount">0</div>
                        <div>Shown</div>
                    </div>
                    <div class="character-mini-stat">
                        <div class="character-mini-stat-value" id="totalSamples">0</div>
                        <div>Samples</div>
                    </div>
                    <div class="character-mini-stat">
                        <div class="character-mini-stat-value" id="untaggedMiniCount">0</div>
                        <div>Untagged</div>
                    </div>
                </div>
            </div>
            
            <div class="character-list-container" id="characterList">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        
        <!-- Center Panel - Main Content -->
        <div class="character-center-panel">
            <div class="character-center-header">
                <div class="character-page-title">
                    <h1>üß† Character Management</h1>
                    <div class="character-model-badge" id="modelBadge">Loading...</div>
                </div>
                
                <div class="character-header-stats">
                    <div class="character-header-stat">
                        <span>üë•</span>
                        <span class="character-header-stat-value" id="characterCount">0</span>
                        <span>characters</span>
                    </div>
                    <div class="character-header-stat">
                        <span>‚ùì</span>
                        <span class="character-header-stat-value" id="untaggedCount">0</span>
                        <span>untagged</span>
                    </div>
                </div>
                
                <div class="character-action-buttons">
                    <button class="action-btn action-btn-success" onclick="trainModel()">‚ú® Train</button>
                    <button class="action-btn action-btn-primary" onclick="inferCharacters()">‚ö° Infer All</button>
                    <button class="action-btn action-btn-warning" onclick="clearAI()">üóëÔ∏è Clear AI</button>
                    <button class="action-btn action-btn-danger" onclick="retrainAll()">‚ôªÔ∏è Full Retrain</button>
                </div>
            </div>
            
            <div class="character-tab-nav">
                <button class="character-tab-btn active" data-tab="images">üì∏ Character Images</button>
                <button class="character-tab-btn" data-tab="prediction">üîÆ Prediction Preview</button>
                <button class="character-tab-btn" data-tab="insights">üìä Model Insights</button>
            </div>
            
            <div class="character-tab-content">
                <!-- Images Tab -->
                <div class="character-tab-pane active" id="imagesPane">
                    <div class="character-images-grid" id="characterImagesGrid">
                        <div class="character-empty-state">
                            <div class="character-empty-state-icon">üëà</div>
                            <div class="character-empty-state-text">Select a character</div>
                            <div class="character-empty-state-subtext">Choose a character from the list to view their images</div>
                        </div>
                    </div>
                </div>
                
                <!-- Prediction Tab -->
                <div class="character-tab-pane" id="predictionPane">
                    <div class="character-prediction-form">
                        <div class="character-prediction-input-group">
                            <div style="flex: 1;">
                                <label for="predictionImageId">Image ID</label>
                                <input type="number" id="predictionImageId" placeholder="Enter image ID">
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="action-btn action-btn-primary" onclick="predictImageById()">üîÆ Predict</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="character-prediction-results" id="predictionResults">
                        <div class="character-empty-state">
                            <div class="character-empty-state-icon">üîÆ</div>
                            <div class="character-empty-state-text">No predictions yet</div>
                            <div class="character-empty-state-subtext">Enter an image ID and click Predict</div>
                        </div>
                    </div>
                </div>
                
                <!-- Insights Tab -->
                <div class="character-tab-pane" id="insightsPane">
                    <div class="character-insights-stats">
                        <div class="character-stat-card">
                            <div class="character-stat-card-label">Training Samples</div>
                            <div class="character-stat-card-value" id="trainingSamples">-</div>
                        </div>
                        <div class="character-stat-card">
                            <div class="character-stat-card-label">Unique Characters</div>
                            <div class="character-stat-card-value" id="uniqueCharacters">-</div>
                        </div>
                        <div class="character-stat-card">
                            <div class="character-stat-card-label">Unique Tags</div>
                            <div class="character-stat-card-value" id="uniqueTags">-</div>
                        </div>
                        <div class="character-stat-card">
                            <div class="character-stat-card-label">Last Trained</div>
                            <div class="character-stat-card-value" id="lastTrained" style="font-size: var(--font-size-sm);">Never</div>
                        </div>
                    </div>
                    
                    <div class="character-distribution-chart">
                        <h3>Character Distribution</h3>
                        <div id="distributionChart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel - Details/Weights/Config -->
        <div class="character-right-panel">
            <div class="character-right-panel-tabs">
                <button class="character-right-tab-btn active" data-tab="details">‚ÑπÔ∏è Details</button>
                <button class="character-right-tab-btn" data-tab="weights">‚öñÔ∏è Weights</button>
                <button class="character-right-tab-btn" data-tab="config">‚öôÔ∏è Config</button>
            </div>
            
            <div class="character-right-panel-content">
                <!-- Details Pane -->
                <div class="character-right-pane active" id="detailsPane">
                    <div class="character-detail-section">
                        <h3>Character Info</h3>
                        <div id="characterInfo">
                            <div class="character-empty-state">
                                <div class="character-empty-state-icon">‚ÑπÔ∏è</div>
                                <div class="character-empty-state-text">No selection</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Weights Pane -->
                <div class="character-right-pane" id="weightsPane">
                    <div class="character-detail-section">
                        <h3>Tag Weights</h3>
                        <div id="tagWeights">
                            <div class="character-empty-state">
                                <div class="character-empty-state-icon">‚öñÔ∏è</div>
                                <div class="character-empty-state-text">No selection</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Config Pane -->
                <div class="character-right-pane" id="configPane">
                    <div class="character-detail-section">
                        <h3>Model Configuration</h3>
                        <div class="character-config-grid" id="configGrid">
                            <!-- Populated by JavaScript -->
                        </div>
                        <button class="action-btn action-btn-primary character-config-save" onclick="saveConfig()">
                            üíæ Save Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer Status Bar -->
    <div class="character-footer-status">
        <div class="character-footer-status-item">
            <span>Last trained:</span>
            <span id="footerLastTrained">Never</span>
        </div>
        <div class="character-footer-status-item">
            <span>Tags in model:</span>
            <span id="footerTagsCount">0</span>
        </div>
        <div class="character-footer-shortcuts">
            <div class="character-shortcut">
                <span class="character-shortcut-key">?</span>
                <span>Help</span>
            </div>
        </div>
    </div>
    
    <div class="log-output" id="actionLog" style="position: fixed; bottom: 60px; right: 20px; max-width: 400px; max-height: 300px; overflow-y: auto; display: none; z-index: 1000; background: var(--bg-panel-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; box-shadow: var(--shadow-lg);">
        <strong>Action Log:</strong>
        <pre id="actionLogContent" style="margin-top: 10px; white-space: pre-wrap;"></pre>
    </div>

    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/system-panel.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pages/character-manage.js') }}"></script>
    <script type="module">
        import { showNotification } from "{{ url_for('static', filename='js/utils/notifications.js') }}";
        window.showNotification = showNotification;
    </script>
</body>

</html>
