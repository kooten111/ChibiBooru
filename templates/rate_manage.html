<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Rating Inference - {{ app_name }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components-bundle.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap"
        rel="stylesheet">

</head>

<body class="gallery-page">
    {% include 'header.html' %}

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="panel" style="text-align: center; min-width: 300px;">
            <div style="font-size: 2em; margin-bottom: 1rem;">‚è≥</div>
            <div id="processingMessage" style="font-size: 1.2em; margin-bottom: 0.5rem;">Processing...</div>
            <div id="processingProgress" style="color: var(--text-muted);"></div>
        </div>
    </div>

    <div class="container">
        <!-- Header Bar -->
        <div class="header-content"
            style="flex-direction: column; align-items: flex-start; gap: 1rem; margin-bottom: 2rem;">
            <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                <h1>
                    <span>üß†</span>
                    Rating Inference
                </h1>
                <div id="statusBadges">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <div class="action-buttons" style="display: flex; gap: 1rem;">
                <button class="btn btn-success" onclick="trainModel()">
                    <span>üéì</span> Train Model
                </button>
                <button class="btn btn-primary" onclick="inferAll()">
                    <span>üîÆ</span> Infer All
                </button>
                <button class="btn btn-warning" onclick="clearAI()">
                    <span>üóëÔ∏è</span> Clear AI
                </button>
            </div>
        </div>

        <!-- Three-panel layout -->
        <div class="manage-grid" id="rateLayout">
            <!-- Left Sidebar -->
            <aside class="panel" id="sidebar" style="height: fit-content;">
                <h3>Quick Stats</h3>

                <div class="stat-card">
                    <div class="label">Training Samples</div>
                    <div class="value" id="trainingSamples">-</div>
                </div>

                <div class="stat-card">
                    <div class="label">Unique Tags</div>
                    <div class="value" id="uniqueTags">-</div>
                </div>

                <div class="stat-card">
                    <div class="label">Tag Pairs</div>
                    <div class="value" id="tagPairs">-</div>
                </div>

                <div class="stat-card">
                    <div class="label">Unrated Images</div>
                    <div class="value" id="unratedCount">-</div>
                </div>

                <div style="margin-top: 2rem;">
                    <h3>Distribution</h3>
                    <div id="ratingDistribution">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main>
                <!-- Tabs -->
                <div class="tabs-header">
                    <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">
                        üìä Dashboard
                    </button>
                    <button class="tab-btn" data-tab="review" onclick="switchTab('review')">
                        üîç Review Queue
                    </button>
                    <button class="tab-btn" data-tab="insights" onclick="switchTab('insights')">
                        üí° Model Insights
                    </button>
                </div>

                <!-- Dashboard Tab -->
                <div class="tab-pane active" id="tab-dashboard">
                    <div class="panel" style="margin-bottom: 2rem;">
                        <h2 style="color: var(--primary-blue); margin-top: 0;">Model Status</h2>

                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                            <div class="stat-card">
                                <div class="label">Model Status</div>
                                <div class="value" id="modelStatus">Not Trained</div>
                                <div style="margin-top: 0.5rem; font-size: 0.85em; color: var(--text-muted);"
                                    id="lastTrained">
                                    Never trained
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="label">Pending Corrections</div>
                                <div class="value" id="pendingCorrections">0</div>
                                <div style="margin-top: 0.5rem; font-size: 0.85em; color: var(--text-muted);">
                                    User corrections since last training
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="label">Model Health</div>
                                <div class="value" id="modelHealth">Unknown</div>
                                <div style="margin-top: 0.5rem; font-size: 0.85em; color: var(--text-muted);"
                                    id="modelHealthDesc">
                                    Checking...
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3 style="margin-top: 0;">Recent Activity</h3>
                        <div id="recentActivity"
                            style="padding: 1rem; border: 1px dashed var(--border-color); border-radius: var(--radius-md);">
                            <p style="color: var(--text-muted); margin: 0;">No recent activity</p>
                        </div>
                    </div>
                </div>

                <!-- Review Queue Tab -->
                <div class="tab-pane" id="tab-review">
                    <div class="panel">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="margin: 0; color: var(--primary-blue);">AI-Inferred Images</h2>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <select id="reviewFilter" onchange="loadReviewImages()"
                                    style="padding: 0.5rem; border-radius: 0.5rem; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-primary);">
                                    <option value="ai_predicted">AI-Inferred</option>
                                    <option value="unrated">Unrated</option>
                                    <option value="all">All</option>
                                </select>
                                <button class="btn btn-secondary btn-small" onclick="loadReviewImages()">
                                    <span>üîÑ</span> Refresh
                                </button>
                            </div>
                        </div>

                        <div class="image-grid-thumbs" id="reviewImageGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Model Insights Tab -->
                <div class="tab-pane" id="tab-insights">
                    <div class="panel">
                        <h2 style="margin-top: 0; color: var(--primary-blue);">Model Insights</h2>

                        <div style="margin-bottom: 2rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">
                                Select Rating:
                            </label>
                            <select id="insightRating" onchange="loadInsights()"
                                style="padding: 0.75rem; border-radius: 0.75rem; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-primary); width: 100%; max-width: 300px;">
                                <option value="rating:general">General</option>
                                <option value="rating:sensitive">Sensitive</option>
                                <option value="rating:questionable">Questionable</option>
                                <option value="rating:explicit">Explicit</option>
                            </select>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <h3>Top Weighted Tags</h3>
                                <div id="topTags" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <div>
                                <h3>Top Tag Pairs</h3>
                                <div id="topPairs" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right Details Panel -->
            <aside class="panel" id="titleDetailsPanel" style="height: fit-content;">
                <h3>Configuration</h3>

                <div id="configPanel">
                    <div
                        style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                        <h4 style="margin-top: 0; color: var(--text-primary);">Training Parameters</h4>

                        <div style="margin-bottom: 1rem;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; font-size: 0.85em; color: var(--text-muted);">
                                Max Tag Pairs
                            </label>
                            <input type="number" id="max_pair_count" min="100" max="1000000" step="100"
                                style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-primary);"
                                placeholder="5000">
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; font-size: 0.85em; color: var(--text-muted);">
                                Min Tag Frequency
                            </label>
                            <input type="number" id="min_tag_frequency" min="1" max="1000" step="1"
                                style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-primary);"
                                placeholder="50">
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; font-size: 0.85em; color: var(--text-muted);">
                                Min Pair Co-occurrence
                            </label>
                            <input type="number" id="min_pair_cooccurrence" min="1" max="1000" step="1"
                                style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-primary);"
                                placeholder="10">
                        </div>
                    </div>

                    <h4 style="margin-top: 0; color: var(--text-primary);">Inference Thresholds</h4>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: block; margin-bottom: 0.5rem; font-size: 0.85em; color: var(--text-muted);">
                            General Threshold
                        </label>
                        <input type="range" id="threshold_general" min="0" max="1" step="0.05" value="0.5"
                            oninput="updateConfigValue('threshold_general', this.value)"
                            style="width: 100%; accent-color: var(--primary-blue);">
                        <div style="text-align: right; color: var(--primary-blue);" id="threshold_general_value">0.5
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: block; margin-bottom: 0.5rem; font-size: 0.85em; color: var(--text-muted);">
                            Sensitive Threshold
                        </label>
                        <input type="range" id="threshold_sensitive" min="0" max="1" step="0.05" value="0.6"
                            oninput="updateConfigValue('threshold_sensitive', this.value)"
                            style="width: 100%; accent-color: var(--primary-blue);">
                        <div style="text-align: right; color: var(--primary-blue);" id="threshold_sensitive_value">0.6
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: block; margin-bottom: 0.5rem; font-size: 0.85em; color: var(--text-muted);">
                            Questionable Threshold
                        </label>
                        <input type="range" id="threshold_questionable" min="0" max="1" step="0.05" value="0.7"
                            oninput="updateConfigValue('threshold_questionable', this.value)"
                            style="width: 100%; accent-color: var(--primary-blue);">
                        <div style="text-align: right; color: var(--primary-blue);" id="threshold_questionable_value">
                            0.7</div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: block; margin-bottom: 0.5rem; font-size: 0.85em; color: var(--text-muted);">
                            Explicit Threshold
                        </label>
                        <input type="range" id="threshold_explicit" min="0" max="1" step="0.05" value="0.8"
                            oninput="updateConfigValue('threshold_explicit', this.value)"
                            style="width: 100%; accent-color: var(--primary-blue);">
                        <div style="text-align: right; color: var(--primary-blue);" id="threshold_explicit_value">0.8
                        </div>
                    </div>

                    <button class="btn btn-primary btn-full-width" onclick="saveConfig()" style="width: 100%;">
                        üíæ Save Configuration
                    </button>
                </div>
            </aside>
        </div>

        <!-- Footer Status Bar -->
        <div
            style="margin-top: 4rem; padding: 1rem; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; color: var(--text-muted);">
            <div class="left">
                <span id="footerStatus">Ready</span>
            </div>
            <div class="right">
                <span>Shortcuts:</span>
                <span><kbd>T</kbd> Train</span>
                <span><kbd>I</kbd> Infer</span>
                <span><kbd>R</kbd> Refresh</span>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pages/rate-manage.js') + '?v=3' }}"></script>
    <script type="module">
        import { showNotification } from "{{ url_for('static', filename='js/utils/notifications.js') }}";
        window.showNotification = showNotification;
    </script>
</body>

</html>