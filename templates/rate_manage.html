<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Rating Inference - {{ app_name }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components-bundle.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/page-layout.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
    <style>
        /* Custom tooltips */
        .tooltip-label {
            position: relative;
            cursor: help;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tooltip-label .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .tooltip-label .tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 130%;
            left: 0;
            background: #1a1a2e;
            color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            line-height: 1.5;
            width: 280px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
            transition: opacity 0.2s, visibility 0.2s;
        }

        .tooltip-label .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 20px;
            border: 8px solid transparent;
            border-top-color: #1a1a2e;
        }

        .tooltip-label:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-highlight {
            color: var(--primary-blue);
            font-weight: 600;
        }
    </style>
</head>

<body class="gallery-page">
    {% include 'header.html' %}

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="processingOverlay">
        <div class="loading-content">
            <div class="loading-spinner">‚è≥</div>
            <div class="loading-message" id="processingMessage">Processing...</div>
            <div class="loading-progress" id="processingProgress"></div>
        </div>
    </div>

    <div class="page-container page-container-full">
        <!-- Page Header -->
        <div class="page-header rate-manage-header">
            <div class="page-header-left">
                <h1 class="page-title">
                    <span class="page-title-icon">üß†</span>
                    Rating Inference
                </h1>
            </div>
            <div class="page-header-center">
                <div id="statusBadges">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            <div class="page-header-right">
                <button class="action-btn action-btn-success" onclick="trainModel()">
                    Train Model
                </button>
                <button class="action-btn action-btn-primary" onclick="inferAll()">
                    Infer All
                </button>
                <button class="action-btn action-btn-warning" onclick="clearAI()">
                    Clear AI
                </button>
            </div>
        </div>

        <!-- Three-panel layout -->
        <div class="panel-layout" id="rateLayout">
            <!-- Left Panel - Stats -->
            <aside class="panel panel-left">
                <div class="panel-header">
                    <h3 class="panel-title">Quick Stats</h3>
                </div>

                <div class="stats-grid stats-grid-single">
                    <div class="stat-card">
                        <div class="stat-card-value" id="trainingSamples">-</div>
                        <div class="stat-card-label">Training Samples</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-value" id="uniqueTags">-</div>
                        <div class="stat-card-label">Unique Tags</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-value" id="tagPairs">-</div>
                        <div class="stat-card-label">Tag Pairs</div>
                    </div>

                    <div class="stat-card info">
                        <div class="stat-card-value" id="unratedCount">-</div>
                        <div class="stat-card-label">Unrated Images</div>
                    </div>
                </div>

                <div class="panel-section panel-section-spaced">
                    <h3 class="panel-section-title">Distribution</h3>
                    <div id="ratingDistribution">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </aside>

            <!-- Center Panel - Main Content -->
            <main class="panel panel-center">
                <!-- Tabs -->
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">
                        Dashboard
                    </button>
                    <button class="tab-btn" data-tab="review" onclick="switchTab('review')">
                        Review Queue
                    </button>
                    <button class="tab-btn" data-tab="insights" onclick="switchTab('insights')">
                        Model Insights
                    </button>
                </div>

                <!-- Dashboard Tab -->
                <div class="tab-pane active" id="tab-dashboard">
                    <div class="panel-section">
                        <h3 class="panel-section-title">Model Status</h3>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-card-value" id="modelStatus">Not Trained</div>
                                <div class="stat-card-label">Model Status</div>
                                <div class="empty-state-subtext" id="lastTrained">
                                    Never trained
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-card-value" id="pendingCorrections">0</div>
                                <div class="stat-card-label">Pending Corrections</div>
                                <div class="empty-state-subtext">
                                    User corrections since last training
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-card-value" id="modelHealth">Unknown</div>
                                <div class="stat-card-label">Model Health</div>
                                <div class="empty-state-subtext" id="modelHealthDesc">
                                    Checking...
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel-section">
                        <h3 class="panel-section-title">Recent Activity</h3>
                        <div id="recentActivity" class="empty-state">
                            <div class="empty-state-text">No recent activity</div>
                        </div>
                    </div>
                </div>

                <!-- Review Queue Tab -->
                <div class="tab-pane" id="tab-review">
                    <div class="panel-section">
                        <div class="review-header-controls">
                            <h3 class="panel-section-title">AI-Inferred Images</h3>
                            <div class="review-filter-controls">
                                <select id="reviewFilter" onchange="loadReviewImages()" class="filter-select">
                                    <option value="ai_predicted">AI-Inferred</option>
                                    <option value="unrated">Unrated</option>
                                    <option value="all">All</option>
                                </select>
                                <button class="action-btn action-btn-secondary" onclick="loadReviewImages()">
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <div class="image-grid" id="reviewImageGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Model Insights Tab -->
                <div class="tab-pane" id="tab-insights">
                    <div class="panel-section">
                        <h3 class="panel-section-title">Model Insights</h3>

                        <div class="filter-group filter-group-spaced">
                            <label class="filter-label">Select Rating:</label>
                            <select id="insightRating" onchange="loadInsights()" class="filter-select"
                                style="max-width: 300px;">
                                <option value="rating:general">General</option>
                                <option value="rating:sensitive">Sensitive</option>
                                <option value="rating:questionable">Questionable</option>
                                <option value="rating:explicit">Explicit</option>
                            </select>
                        </div>

                        <div class="insights-grid">
                            <div>
                                <h4 class="panel-section-title">Top Weighted Tags</h4>
                                <div id="topTags" class="list-container">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <div>
                                <h4 class="panel-section-title">Top Tag Pairs</h4>
                                <div id="topPairs" class="list-container">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right Panel - Configuration -->
            <aside class="panel panel-right">
                <div class="panel-header">
                    <h3 class="panel-title">Configuration</h3>
                </div>

                <div id="configPanel">
                    <div class="panel-section">
                        <h4 class="panel-section-title">Training Parameters</h4>

                        <div class="filter-group">
                            <label class="filter-label tooltip-label">
                                Max Tag Pairs
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">
                                    <strong>Max Tag Pairs</strong><br>
                                    Maximum tag pair combinations to store.<br><br>
                                    <span class="tooltip-highlight">Higher values</span> = more RAM but potentially
                                    better accuracy<br>
                                    <span class="tooltip-highlight">Lower values</span> = faster training, less
                                    memory<br><br>
                                    <em>Recommended: 10,000 - 30,000</em>
                                </span>
                            </label>
                            <input type="number" id="max_pair_count" class="filter-input" min="100" max="1000000"
                                step="100" placeholder="25000">
                        </div>

                        <div class="filter-group">
                            <label class="filter-label tooltip-label">
                                Min Tag Frequency
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">
                                    <strong>Min Tag Frequency</strong><br>
                                    Minimum times a tag must appear to be included.<br><br>
                                    <span class="tooltip-highlight">Higher values</span> = smaller model, may miss rare
                                    patterns<br>
                                    <span class="tooltip-highlight">Lower values</span> = includes rare tags, larger
                                    model<br><br>
                                    <em>Recommended: 10 - 50</em>
                                </span>
                            </label>
                            <input type="number" id="min_tag_frequency" class="filter-input" min="1" max="1000" step="1"
                                placeholder="10">
                        </div>

                        <div class="filter-group">
                            <label class="filter-label tooltip-label">
                                Min Pair Co-occurrence
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">
                                    <strong>Min Pair Co-occurrence</strong><br>
                                    Minimum times two tags must appear together.<br><br>
                                    <span class="tooltip-highlight">Higher values</span> = fewer pairs, faster training,
                                    less noise<br>
                                    <span class="tooltip-highlight">Lower values</span> = captures subtle patterns, may
                                    overfit<br><br>
                                    <em>Recommended: 5 - 20</em>
                                </span>
                            </label>
                            <input type="number" id="min_pair_cooccurrence" class="filter-input" min="1" max="1000"
                                step="1" placeholder="10">
                        </div>
                    </div>

                    <div class="panel-section">
                        <h4 class="panel-section-title">Inference Thresholds</h4>

                        <div class="filter-group">
                            <label class="filter-label tooltip-label">
                                General Threshold
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">
                                    <strong>General Threshold</strong><br>
                                    Confidence required to classify as General (safe).<br><br>
                                    <span class="tooltip-highlight">Lower values</span> = more images classified as
                                    General<br>
                                    <span class="tooltip-highlight">Higher values</span> = stricter, may leave more
                                    unrated<br><br>
                                    <em>Recommended: 0.4 - 0.6</em>
                                </span>
                            </label>
                            <input type="range" id="threshold_general" min="0" max="1" step="0.05" value="0.5"
                                oninput="updateConfigValue('threshold_general', this.value)">
                            <div class="threshold-value" id="threshold_general_value">0.5</div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label tooltip-label">
                                Sensitive Threshold
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">
                                    <strong>Sensitive Threshold</strong><br>
                                    Confidence required to classify as Sensitive.<br><br>
                                    <span class="tooltip-highlight">Should be higher than General</span> to avoid
                                    over-flagging safe content.<br><br>
                                    <em>Recommended: 0.5 - 0.7</em>
                                </span>
                            </label>
                            <input type="range" id="threshold_sensitive" min="0" max="1" step="0.05" value="0.6"
                                oninput="updateConfigValue('threshold_sensitive', this.value)">
                            <div class="threshold-value" id="threshold_sensitive_value">0.6</div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label tooltip-label">
                                Questionable Threshold
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">
                                    <strong>Questionable Threshold</strong><br>
                                    Confidence required to classify as Questionable.<br><br>
                                    <span class="tooltip-highlight">Higher = more conservative</span>, fewer false
                                    positives but may miss content.<br><br>
                                    <em>Recommended: 0.6 - 0.8</em>
                                </span>
                            </label>
                            <input type="range" id="threshold_questionable" min="0" max="1" step="0.05" value="0.7"
                                oninput="updateConfigValue('threshold_questionable', this.value)">
                            <div class="threshold-value" id="threshold_questionable_value">0.7</div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label tooltip-label">
                                Explicit Threshold
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">
                                    <strong>Explicit Threshold</strong><br>
                                    Confidence required to classify as Explicit.<br><br>
                                    <span class="tooltip-highlight">Should be highest</span> to avoid incorrectly
                                    flagging safe content as explicit.<br><br>
                                    <em>Recommended: 0.7 - 0.9</em>
                                </span>
                            </label>
                            <input type="range" id="threshold_explicit" min="0" max="1" step="0.05" value="0.8"
                                oninput="updateConfigValue('threshold_explicit', this.value)">
                            <div class="threshold-value" id="threshold_explicit_value">0.8</div>
                        </div>
                    </div>

                    <button class="action-btn action-btn-primary action-btn-full-width" onclick="saveConfig()">
                        Save Configuration
                    </button>
                </div>
            </aside>
        </div>
    </div>

    <!-- Page Footer -->
    <div class="page-footer">
        <div class="page-footer-left">
            <span class="page-footer-item" id="footerStatus">Ready</span>
        </div>
        <div class="page-footer-shortcuts">
            <span class="shortcut"><span class="shortcut-key">T</span> Train</span>
            <span class="shortcut"><span class="shortcut-key">I</span> Infer</span>
            <span class="shortcut"><span class="shortcut-key">R</span> Refresh</span>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pages/rate-manage.js') + '?v=4' }}"></script>
    <script type="module">
        import { showNotification } from "{{ url_for('static', filename='js/utils/notifications.js') }}";
        window.showNotification = showNotification;
    </script>
</body>

</html>