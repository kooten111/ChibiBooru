<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ filepath.split('/')[-1] }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components-bundle.css') + '?v=16' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gallery.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/saucenao-modal.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animation-player.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/upscaler.css') + '?v=1' }}">

    {# Preload main image with high priority - start loading ASAP #}
    {# If upscaled version exists, preload that; otherwise preload original #}
    {% if not (filepath.endswith('.mp4') or filepath.endswith('.webm')) %}
    <link rel="preload"
        href="{% if upscaled_image_url %}{{ upscaled_image_url }}{% else %}/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}{% endif %}"
        as="image" fetchpriority="high">
    {% endif %}

    {# Related images are now preloaded via JavaScript AFTER main image loads #}
    {# This prevents bandwidth competition on initial page load #}
</head>

<body class="image-page"
    data-information-panel-default-collapsed="{{ 'true' if information_panel_default_collapsed else 'false' }}">
    <div id="global-drop-zone" class="global-drop-zone">
        <div class="drop-zone-content">
            <div class="drop-zone-icon">üì§</div>
            <div class="drop-zone-text">Drop images to upload</div>
        </div>
    </div>

    {% include 'header.html' %}

    <div class="container">
        <script type="application/json"
            id="image-page-defaults">{{ {'information_panel_default_collapsed': information_panel_default_collapsed}|tojson }}</script>
        <div class="sidebar-left" id="sidebarLeft">
            <div class="section-content" id="tags-content">
                <div class="tags-list panel">
                    <button class="panel-header mobile-toggle" data-section="tags-panel-content">
                        <span class="section-icon">üè∑Ô∏è</span>
                        <span class="section-title">Tags</span>
                        <span class="text-muted-tiny">
                            {% set tag_count = namespace(n=0) %}
                            {% if categorized_tags %}
                            {% if categorized_tags.artist %}{% set tag_count.n = tag_count.n +
                            categorized_tags.artist|length %}{% endif %}
                            {% if categorized_tags.copyright %}{% set tag_count.n = tag_count.n +
                            categorized_tags.copyright|length %}{% endif %}
                            {% if categorized_tags.character %}{% set tag_count.n = tag_count.n +
                            categorized_tags.character|length %}{% endif %}
                            {% if categorized_tags.species %}{% set tag_count.n = tag_count.n +
                            categorized_tags.species|length %}{% endif %}
                            {% if categorized_tags.meta %}{% set tag_count.n = tag_count.n +
                            categorized_tags.meta|length %}{% endif %}
                            {% endif %}
                            {% if extended_grouped_tags %}
                            {% for cat_key, cat_tags in extended_grouped_tags.items() %}
                            {% set tag_count.n = tag_count.n + cat_tags|length %}
                            {% endfor %}
                            {% elif tags %}
                            {% set tag_count.n = tag_count.n + tags|length %}
                            {% endif %}
                            {{ tag_count.n }} tags
                        </span>
                        <span class="section-arrow">‚ñº</span>
                    </button>
                    <div class="panel-collapsible-content" id="tags-panel-content">
                        {% if categorized_tags %}
                        {% if categorized_tags.artist %}
                        <div class="tag-category artist">
                            <div class="tag-category-title">Artist</div>
                            {% for tag, count in categorized_tags.artist %}
                            <div class="tag-item{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                {% if implied_tag_names and tag in implied_tag_names
                                %}title="Implied by implication rule" {% endif %}>
                                <a href="{{ url_for('main.home', query='artist:' + tag) }}">{% if implied_tag_names and
                                    tag in implied_tag_names %}‚Üí {% endif %}{{ tag }}</a>
                                <span class="tag-count">
                                    {% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >=
                                    1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% if categorized_tags.copyright %}
                        <div class="tag-category copyright">
                            <div class="tag-category-title">Copyright</div>
                            {% for tag, count in categorized_tags.copyright %}
                            <div class="tag-item{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                {% if implied_tag_names and tag in implied_tag_names
                                %}title="Implied by implication rule" {% endif %}>
                                <a href="{{ url_for('main.home', query='copyright:' + tag) }}">{% if implied_tag_names
                                    and tag in implied_tag_names %}‚Üí {% endif %}{{ tag }}</a>
                                <span class="tag-count">
                                    {% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >=
                                    1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% if categorized_tags.character %}
                        <div class="tag-category character">
                            <div class="tag-category-title">Character</div>
                            {% for tag, count in categorized_tags.character %}
                            <div class="tag-item{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                {% if implied_tag_names and tag in implied_tag_names
                                %}title="Implied by implication rule" {% endif %}>
                                <a href="{{ url_for('main.home', query='character:' + tag) }}">{% if implied_tag_names
                                    and tag in implied_tag_names %}‚Üí {% endif %}{{ tag }}</a>
                                <span class="tag-count">
                                    {% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >=
                                    1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% if categorized_tags.species %}
                        <div class="tag-category species">
                            <div class="tag-category-title">Species</div>
                            {% for tag, count in categorized_tags.species %}
                            <div class="tag-item{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                {% if implied_tag_names and tag in implied_tag_names
                                %}title="Implied by implication rule" {% endif %}>
                                <a href="{{ url_for('main.home', query='species:' + tag) }}">{% if implied_tag_names and
                                    tag in implied_tag_names %}‚Üí {% endif %}{{ tag }}</a>
                                <span class="tag-count">
                                    {% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >=
                                    1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% if extended_grouped_tags %}
                        <div class="tag-category general">
                            <div class="tag-category-title">General</div>

                            {# Define extended category order and display names #}
                            {% set extended_category_order = [
                            ('00_Subject_Count', 'Subject Count'),
                            ('01_Body_Physique', 'Body Physique'),
                            ('02_Body_Hair', 'Body Hair'),
                            ('03_Body_Face', 'Body Face'),
                            ('04_Body_Genitalia', 'Body Genitalia'),
                            ('05_Attire_Main', 'Attire Main'),
                            ('06_Attire_Inner', 'Attire Inner'),
                            ('07_Attire_Legwear', 'Attire Legwear'),
                            ('08_Attire_Acc', 'Attire Accessories'),
                            ('09_Action', 'Action'),
                            ('10_Pose', 'Pose'),
                            ('11_Expression', 'Expression'),
                            ('12_Sexual_Act', 'Sexual Act'),
                            ('13_Object', 'Object'),
                            ('14_Setting', 'Setting'),
                            ('15_Framing', 'Framing'),
                            ('16_Focus', 'Focus'),
                            ('17_Style_Art', 'Style Art'),
                            ('18_Style_Tech', 'Style Tech'),
                            ('19_Meta_Attributes', 'Meta Attributes'),
                            ('20_Meta_Text', 'Meta Text'),
                            ('21_Status', 'Status'),
                            (None, 'Uncategorized')
                            ] %}

                            {# Display tags grouped by extended category in order #}
                            {% for cat_key, cat_display_name in extended_category_order %}
                            {% if cat_key in extended_grouped_tags or (cat_key is none and None in
                            extended_grouped_tags) %}
                            <div
                                class="extended-sub-category {{ cat_key|replace('_', '-')|lower if cat_key else 'uncategorized' }}">
                                <div class="extended-category-title">{{ cat_display_name }}</div>
                                {% for tag, count in extended_grouped_tags[cat_key] %}
                                <div class="tag-item{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                    {% if implied_tag_names and tag in implied_tag_names
                                    %}title="Implied by implication rule" {% endif %}>
                                    <a href="{{ url_for('main.home', query=tag) }}">{% if implied_tag_names and tag in
                                        implied_tag_names %}‚Üí {% endif %}{{ tag }}</a>
                                    <span class="tag-count">
                                        {% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >=
                                        1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}
                                    </span>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% elif tags %}
                        <div class="tag-category general">
                            <div class="tag-category-title">General</div>
                            {% for tag, count in tags %}
                            <div class="tag-item{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                {% if implied_tag_names and tag in implied_tag_names
                                %}title="Implied by implication rule" {% endif %}>
                                <a href="{{ url_for('main.home', query=tag) }}">{% if implied_tag_names and tag in
                                    implied_tag_names %}‚Üí {% endif %}{{ tag }}</a>
                                <span class="tag-count">
                                    {% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >=
                                    1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% if categorized_tags.meta or (tag_deltas and (tag_deltas.added or tag_deltas.removed)) %}
                        <div class="tag-category meta">
                            <div class="tag-category-title">Meta</div>
                            {% if categorized_tags.meta %}
                            {% for tag, count in categorized_tags.meta %}
                            <div class="tag-item">
                                <a href="{{ url_for('main.home', query='meta:' + tag) }}">
                                    {# Display friendly names for rating tags #}
                                    {% if tag.startswith('rating:') %}
                                    {% if tag == 'rating:general' %}General
                                    {% elif tag == 'rating:sensitive' %}Sensitive
                                    {% elif tag == 'rating:questionable' %}Questionable
                                    {% elif tag == 'rating:explicit' %}Explicit
                                    {% else %}{{ tag }}
                                    {% endif %}
                                    {% else %}
                                    {{ tag }}
                                    {% endif %}
                                </a>
                                <span class="tag-count">
                                    {% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >=
                                    1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}
                                </span>
                            </div>
                            {% endfor %}
                            {% endif %}

                            {% if tag_deltas and (tag_deltas.added or tag_deltas.removed) %}
                            <div class="tag-category-subtitle mt-10"
                                style="padding-top: 10px; border-top: 1px solid rgba(255, 165, 0, 0.2);">Manual
                                modifications</div>
                            {% if tag_deltas.added %}
                            {% for tag_info in tag_deltas.added %}
                            <div class="tag-item delta-added">
                                <a href="{{ url_for('main.home', query=tag_info.name) }}" class="link-primary">+{{
                                    tag_info.name }}</a>
                            </div>
                            {% endfor %}
                            {% endif %}
                            {% if tag_deltas.removed %}
                            {% for tag_info in tag_deltas.removed %}
                            <div class="tag-item delta-removed">
                                <a href="{{ url_for('main.home', query=tag_info.name) }}" class="link-danger">-{{
                                    tag_info.name }}</a>
                            </div>
                            {% endfor %}
                            {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                        {% else %}
                        <h3>Tags</h3>
                        {% for tag, count in tags %}
                        <div class="tag-item">
                            <a href="{{ url_for('main.home', query=tag) }}">{{ tag }}</a>
                            <span class="tag-count">
                                {% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >= 1000
                                %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}
                            </span>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if image_pools %}
            <div class="section-content" id="pools-content">
                <div class="pool-management panel">
                    <button class="panel-header mobile-toggle collapsed" data-section="pools-panel-content">
                        <span class="section-icon">üìÅ</span>
                        <span class="section-title">Pools</span>
                        <span class="section-arrow">‚ñº</span>
                    </button>
                    <h3 class="desktop-only">Pools</h3>
                    <div class="panel-collapsible-content" id="pools-panel-content">
                        <div id="poolsList" class="pools-list-container">
                            <div class="loading-spinner">Loading pools...</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if metadata %}
            <div class="section-content" id="metadata-content">
                <div class="metadata-info panel">
                    <button
                        class="panel-header mobile-toggle{% if information_panel_default_collapsed %} collapsed{% endif %}"
                        data-section="metadata-panel-content">
                        <span class="section-icon">‚ÑπÔ∏è</span>
                        <span class="section-title">Information</span>
                        <span class="section-arrow">‚ñº</span>
                    </button>
                    <h3 class="desktop-only">Information</h3>
                    <div class="panel-collapsible-content" id="metadata-panel-content">
                        <!-- Quick Stats Grid - Bordered Boxes -->
                        <div class="info-section">
                            <div class="stats-grid stats-grid-bordered">
                                {% if metadata.sources %}
                                {% set first_source = metadata.sources.values()|list|first %}
                                {% set width = first_source.image_width or (first_source.file.width if first_source.file
                                else none) %}
                                {% set height = first_source.image_height or (first_source.file.height if
                                first_source.file else none) %}
                                <div class="stat-box" id="resolution-stat-box" {% if not (data.image_width and
                                    data.image_height) %}style="display: none" {% endif %}>
                                    <div class="stat-label">Resolution</div>
                                    <div class="stat-value" id="metadata-resolution"
                                        data-original-resolution="{% if data.image_width and data.image_height %}{{ data.image_width }}√ó{{ data.image_height }}{% endif %}">
                                        {% if data.image_width and data.image_height %}
                                        {% if data.upscaled_width and data.upscaled_height %}
                                        <span style="opacity: 0.7">{{ data.image_width }}√ó{{ data.image_height }}</span>
                                        ‚ûú <strong>{{ data.upscaled_width }}√ó{{ data.upscaled_height }}</strong>
                                        {% else %}
                                        {{ data.image_width }}√ó{{ data.image_height }}
                                        {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}

                                {% if metadata.sources %}
                                {% set first_source = metadata.sources.values()|list|first %}
                                {% if first_source.rating %}
                                <div class="stat-box">
                                    <div class="stat-label">Rating</div>
                                    <div
                                        class="stat-value rating-value {% if first_source.rating == 'g' %}rating-general{% elif first_source.rating == 's' %}rating-sensitive{% elif first_source.rating == 'q' %}rating-questionable{% elif first_source.rating == 'e' %}rating-explicit{% endif %}">
                                        {% if first_source.rating == 'g' %}General
                                        {% elif first_source.rating == 's' %}Sensitive
                                        {% elif first_source.rating == 'q' %}Questionable
                                        {% elif first_source.rating == 'e' %}Explicit
                                        {% else %}{{ first_source.rating }}{% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}

                                {% if metadata.sources %}
                                {% set first_source = metadata.sources.values()|list|first %}
                                {% set score = first_source.score if first_source.score is defined else none %}
                                <div class="stat-box">
                                    <div class="stat-label">Score</div>
                                    <div class="stat-value">
                                        {% if score is mapping %}
                                        {{ score.total if score.total is defined else (score['total'] if 'total' in
                                        score else score) }}
                                        {% else %}
                                        {{ score if score is not none else '‚Äî' }}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}

                                {% if metadata.sources %}
                                {% set first_source = metadata.sources.values()|list|first %}
                                {% set fav_count = first_source.fav_count if first_source.fav_count is defined else
                                (first_source.favs if first_source.favs is defined else none) %}
                                <div class="stat-box">
                                    <div class="stat-label">Favourites</div>
                                    <div class="stat-value">{{ fav_count if fav_count is not none else '‚Äî' }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- File Info -->
                        <div class="info-section">
                            <div class="file-info-box">
                                <div class="stat-label">File</div>
                                <div class="stat-value"><span>{{ filepath.split('/')[-1] }}</span>{% if metadata.sources
                                    %}{% set first_source = metadata.sources.values()|list|first %}{% set file_size =
                                    first_source.file_size or (first_source.file.size if first_source.file else none)
                                    %}{% if file_size %} <span class="file-size" id="metadata-filesize">{% if
                                        file_size >= 1048576 %}{{
                                        "%.1f"|format(file_size / 1048576.0) }} MB{% elif file_size >= 1024 %}{{
                                        "%.1f"|format(file_size / 1024.0) }} KB{% else %}{{ file_size }} bytes{%
                                        endif
                                        %}</span>{% endif %}{% endif %}</div>
                            </div>
                        </div>

                        <!-- Sources Section -->
                        {% if metadata.sources %}

                        <div class="info-section">
                            <div class="info-row">
                                <div class="info-label">Found On</div>
                                <div class="source-links">
                                    {% for source_name, source_data in metadata.sources.items() %}
                                    {% if source_name == 'danbooru' %}
                                    <a href="https://danbooru.donmai.us/posts/{{ source_data.id }}" target="_blank"
                                        rel="noopener" class="source-link">
                                        <svg fill="currentColor" viewBox="0 0 20 20">
                                            <path
                                                d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                                            <path
                                                d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                                        </svg>
                                        <span>Danbooru #{{ source_data.id }}</span>
                                    </a>
                                    {% elif source_name == 'e621' %}
                                    <a href="https://e621.net/posts/{{ source_data.id }}" target="_blank" rel="noopener"
                                        class="source-link">
                                        <svg fill="currentColor" viewBox="0 0 20 20">
                                            <path
                                                d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                                            <path
                                                d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                                        </svg>
                                        <span>e621 #{{ source_data.id }}</span>
                                    </a>
                                    {% elif source_name == 'gelbooru' %}
                                    <a href="https://gelbooru.com/index.php?page=post&s=view&id={{ source_data.id }}"
                                        target="_blank" rel="noopener" class="source-link">
                                        <svg fill="currentColor" viewBox="0 0 20 20">
                                            <path
                                                d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                                            <path
                                                d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                                        </svg>
                                        <span>Gelbooru #{{ source_data.id }}</span>
                                    </a>
                                    {% elif source_name == 'yandere' %}
                                    <a href="https://yande.re/post/show/{{ source_data.id }}" target="_blank"
                                        rel="noopener" class="source-link">
                                        <svg fill="currentColor" viewBox="0 0 20 20">
                                            <path
                                                d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                                            <path
                                                d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                                        </svg>
                                        <span>Yande.re #{{ source_data.id }}</span>
                                    </a>
                                    {% elif source_name == 'local_tagger' or source_name == 'camie_tagger' %}
                                    <a href="javascript:void(0)" onclick="confirmRetryTagging()"
                                        class="source-link ai-tagged-link"
                                        title="Click to retry tagging from online sources">
                                        <span>ü§ñ</span>
                                        <span>{% if source_data.tagger_name and source_data.tagger_name != 'Unknown'
                                            %}{{ source_data.tagger_name }}{% else %}Not Found{% endif %}</span>
                                        <span class="retry-icon">üîÑ</span>
                                    </a>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- No sources found - show Not Found with retry option -->
                        <div class="info-section">
                            <div class="info-row">
                                <div class="info-label">Found On</div>
                                <div class="source-links">
                                    <a href="javascript:void(0)" onclick="confirmRetryTagging()"
                                        class="source-link unknown-source-link"
                                        title="Click to try finding tags from online sources">
                                        <span>ü§ñ</span>
                                        <span>Not Found</span>
                                        <span class="retry-icon">üîÑ</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if metadata.sources and metadata.sources|length > 1 %}
                        <div class="info-section">
                            <div class="info-row">
                                <div class="info-label">Source</div>
                                <div class="info-value">
                                    <button class="source-toggle-btn" onclick="openSourceModal()">
                                        <span class="current-source-indicator">
                                            {% set active = data.active_source or (metadata.sources.keys()|list|first)
                                            %}
                                            {% if active == 'merged' %}üîÄ Merged ({{ metadata.sources|length }})
                                            {% elif active == 'danbooru' %}üîµ Danbooru
                                            {% elif active == 'e621' %}üü¢ e621
                                            {% elif active == 'gelbooru' %}üü° Gelbooru
                                            {% elif active == 'yandere' %}üî¥ Yande.re
                                            {% elif active == 'local_tagger' or active == 'camie_tagger' %}ü§ñ {{
                                            metadata.sources.get(active, {}).get('tagger_name', 'AI Tagger') }}
                                            {% else %}{{ active|title }}{% endif %}
                                        </span>
                                        <span class="toggle-text">Switch</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <script type="application/json" id="currentSource">{{ data.active_source or '' }}</script>
                        <script type="application/json" id="sourceData">{{ metadata.sources|tojson }}</script>
                        {% endif %}

                        <!-- MD5 Section -->
                        {% if metadata.md5 %}
                        <div class="info-section">
                            <div class="info-row">
                                <div class="info-label">MD5</div>
                                <div class="info-value mono">{{ metadata.md5 }}</div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Utility Actions -->
                        <div class="utility-actions">
                            <button class="utility-link" onclick="copyImageTags(this)">
                                <span class="utility-icon">üìã</span>
                                <span class="utility-text">Copy all tags</span>
                            </button>
                            <a href="{{ url_for('main.show_raw_data', filepath=filepath) }}" class="utility-link">
                                <span class="utility-icon">üìÑ</span>
                                <span class="utility-text">View raw data</span>
                            </a>
                            <button onclick="showSauceNaoFetcher()" class="utility-link">
                                <span class="utility-icon">üîç</span>
                                <span class="utility-text">Fetch from SauceNao</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="main-content">
            <div class="image-and-actions-container">
                <div class="image-view-wrapper">
                    <button class="image-nav-btn image-nav-prev" id="prevBtn" title="Previous image (‚Üê)">‚óÄ</button>
                    <div class="image-view skeleton{% if (data.upscaled_width and data.upscaled_height) or (data.image_width and data.image_height) %} image-skeleton-sized{% endif %}"
                        id="imageViewContainer" data-filepath="{{ filepath }}" 
                        {% if data.upscaled_width and data.upscaled_height %}
                        data-width="{{ data.upscaled_width }}" data-height="{{ data.upscaled_height }}"
                        style="--img-w: {{ data.upscaled_width }}; --img-h: {{ data.upscaled_height }};"
                        {% elif data.image_width and data.image_height %}
                        data-width="{{ data.image_width }}" data-height="{{ data.image_height }}"
                        style="--img-w: {{ data.image_width }}; --img-h: {{ data.image_height }};"
                        {% endif %}
                        {% if filepath.endswith('.zip') %}data-animation-type="zip"
                        data-md5="{{ metadata.md5 if metadata else '' }}" data-fps="24"{% endif %}>
                        {% if filepath.endswith('.mp4') %}
                        <video controls loop preload="auto" autoplay muted poster="/static/{{ thumbnail_path | urlencode_path }}"
                            onloadeddata="this.closest('.image-view').classList.add('has-image')">
                            <source
                                src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                                type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        {% elif filepath.endswith('.webm') %}
                        <video controls loop preload="auto" autoplay muted poster="/static/{{ thumbnail_path | urlencode_path }}"
                            onloadeddata="this.closest('.image-view').classList.add('has-image')">
                            <source
                                src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                                type="video/webm">
                            Your browser does not support the video tag.
                        </video>
                        {% elif filepath.endswith('.zip') %}
                        {# Zip animation - show thumbnail as poster, animation player will take over #}
                        <img src="/static/{{ thumbnail_path | urlencode_path }}" alt="Animation" fetchpriority="high"
                            onload="this.closest('.image-view').classList.add('has-image')" class="animation-poster">
                        <span class="animation-badge">ZIP Animation</span>
                        {% elif filepath.endswith(('.gif', '.webp', '.apng')) %}
                        {# Animated images - play natively with their own embedded FPS #}
                        <img src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                            alt="Animated Image" fetchpriority="high" decoding="async"
                            onload="this.closest('.image-view').classList.add('has-image')">
                        <span class="animation-badge">Animated</span>
                        {% else %}
                        {% if upscaled_image_url %}
                        <img src="{{ upscaled_image_url }}" alt="Upscaled Image" fetchpriority="high"
                            onload="this.closest('.image-view').classList.add('has-image')"
                            onerror="this.src='/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}'; this.onerror = null; this.closest('.image-view').classList.add('has-image');"
                            data-original-src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}">
                        <span class="animation-badge" style="background: rgba(0, 255, 128, 0.8);">Upscaled</span>
                        {% else %}
                        <img src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                            alt="Image" fetchpriority="high"
                            onload="this.closest('.image-view').classList.add('has-image')"
                            onerror="this.closest('.image-view').classList.add('has-image', 'load-error'); console.error('Image failed to load:', this.src);">
                        {% endif %}
                        {% endif %}
                    </div>
                    <button class="image-nav-btn image-nav-next" id="nextBtn" title="Next image (‚Üí)">‚ñ∂</button>
                </div>

                {# Family badge data - parent/child images #}
                {% if family_images %}
                <script type="application/json" id="familyImagesData">{{ family_images | tojson }}</script>
                {% endif %}

                <div class="actions-row">
                    <div class="actions-bar pill">
                        <button class="action-btn favourite" id="favouriteBtn" data-filepath="{{ filepath }}"
                            title="Add to Favourites">
                            <span class="favourite-icon">ü§ç</span>
                        </button>
                        <button class="action-btn primary" onclick="toggleTagEditor()" title="Edit Tags">
                            üìù
                        </button>
                        <button class="action-btn" id="addToPoolBtn" onclick="showAddToPoolModal()" title="Add to Pool">
                            üìÅ
                        </button>
                        <a href="{{ url_for('main.similar', filepath=filepath) }}" class="action-btn"
                            title="Find Similar by Tags">
                            üîç
                        </a>
                        <a href="{{ url_for('main.similar_visual', filepath=filepath) }}" class="action-btn"
                            title="Find Visually Similar">
                            üëÅÔ∏è
                        </a>
                        <a href="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                            download class="action-btn success" title="Download" id="download-btn">
                            üíæ
                        </a>
                        <button id="deleteImageBtn" class="action-btn danger" title="Delete Image">
                            üóëÔ∏è
                        </button>
                    </div>
                    <!-- Family filmstrip will be inserted here by JavaScript -->
                </div>
            </div>
        </div>

        <div class="sidebar-right" id="sidebarRight">
            <div class="section-content" id="sidebar-right-content">
                {# Always show similar images section - data will be lazy-loaded #}
                <script type="application/json"
                    id="similarConfig">{"sources": "{{ similar_sidebar_sources }}", "showChips": {{ similar_sidebar_show_chips|tojson }}}</script>
                <script type="application/json" id="relatedImagesData">{{ related_images|tojson }}</script>
                <div class="related-images-vertical panel" {% if not similar_sidebar_show_chips %}data-hide-chips="true"
                    {% endif %}>
                    <button class="panel-header mobile-toggle" data-section="related-images-content">
                        <span class="section-icon">üîó</span>
                        <span class="section-title">
                            Similar
                            <span class="text-muted-tiny" id="similar-count">
                                (0 images)
                            </span>
                        </span>
                        <span class="section-arrow">‚ñº</span>
                    </button>
                    <h3 class="desktop-only">
                        <span>üîó</span>
                        Similar
                        <span class="text-muted-tiny" id="similar-count-desktop">
                            (0 images)
                        </span>
                    </h3>
                    <div class="panel-collapsible-content" id="related-images-content">
                        <div class="related-grid-vertical">
                            <div class="loading-spinner" style="text-align: center; padding: 20px; color: #888;">
                                Loading similar images...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if metadata.sources and metadata.sources|length > 1 %}
    <div id="sourceModal" class="source-modal">
        <div class="source-modal-content">
            <div class="source-modal-header">
                <h2>üîÑ Switch Metadata Source</h2>
                <button class="source-modal-close" onclick="closeSourceModal()">&times; Close</button>
            </div>
            <div class="source-options">
                {% set active = data.active_source or (metadata.sources.keys()|list|first) %}
                <!-- Merge All Sources Option -->
                <div class="source-option special-option {% if active == 'merged' %}active{% endif %}"
                    onclick="switchSource('merged')">
                    <div class="source-option-header">
                        <span class="source-emoji">üîÄ</span>
                        <span class="source-name">Merge All Sources</span>
                        {% if active == 'merged' %}
                        <span class="active-badge">Active</span>
                        {% endif %}
                    </div>
                    <div class="source-meta">
                        <span class="meta-badge categorized">Combined from {{ metadata.sources|length }} sources</span>
                        <span class="meta-badge count">
                            All tags merged & deduplicated
                        </span>
                    </div>
                </div>
                {% if active == 'merged' %}
                <div class="source-hint">
                    üí° Select any individual source below to switch back to its tags only
                </div>
                {% endif %}
                <!-- Individual Sources -->
                {% for source_name, source_data in metadata.sources.items() %}
                <div class="source-option {% if source_name == active %}active{% endif %}"
                    onclick="switchSource('{{ source_name }}')">
                    <div class="source-option-header">
                        <span class="source-emoji">
                            {% if source_name == 'danbooru' %}üîµ
                            {% elif source_name == 'e621' %}üü¢
                            {% elif source_name == 'gelbooru' %}üü°
                            {% elif source_name == 'yandere' %}üî¥
                            {% elif source_name == 'local_tagger' or source_name == 'camie_tagger' %}ü§ñ
                            {% else %}üì¶{% endif %}
                        </span>
                        <span class="source-name">
                            {% if source_name == 'danbooru' %}Danbooru
                            {% elif source_name == 'e621' %}e621
                            {% elif source_name == 'gelbooru' %}Gelbooru
                            {% elif source_name == 'yandere' %}Yande.re
                            {% elif source_name == 'local_tagger' or source_name == 'camie_tagger' %}{{
                            source_data.tagger_name or 'AI Tagger' }}
                            {% else %}{{ source_name|title }}{% endif %}
                        </span>
                        {% if source_name == active %}
                        <span class="active-badge">Active</span>
                        {% endif %}
                    </div>
                    <div class="source-meta">
                        {% if source_name in ['danbooru', 'e621', 'local_tagger', 'camie_tagger'] %}
                        <span class="meta-badge categorized">Categorized Tags</span>
                        {% else %}
                        <span class="meta-badge general">General Tags Only</span>
                        {% endif %}
                        <span class="meta-badge count">
                            {% if source_name == 'danbooru' %}
                            {% set all_tags = (source_data.tag_string_character or '') + ' ' +
                            (source_data.tag_string_copyright or '') + ' ' + (source_data.tag_string_artist or '') + ' '
                            + (source_data.tag_string_meta or '') + ' ' + (source_data.tag_string_general or '') %}
                            {{ all_tags.split()|length }} tags
                            {% elif source_name == 'e621' %}
                            {% set tag_count = 0 %}
                            {% if source_data.tags %}
                            {% for category_tags in source_data.tags.values() %}
                            {% set tag_count = tag_count + (category_tags|length if category_tags is iterable and
                            category_tags is not string else 0) %}
                            {% endfor %}
                            {% endif %}
                            {{ tag_count }} tags
                            {% elif source_name == 'local_tagger' or source_name == 'camie_tagger' %}
                            {% set tag_count = 0 %}
                            {% if source_data.tags %}
                            {% for category_tags in source_data.tags.values() %}
                            {% set tag_count = tag_count + (category_tags|length if category_tags is iterable and
                            category_tags is not string else 0) %}
                            {% endfor %}
                            {% endif %}
                            {{ tag_count }} tags
                            {% elif source_data.tags %}
                            {{ (source_data.tags.split()|length if source_data.tags is string else
                            source_data.tags|length) }} tags
                            {% else %}
                            0 tags
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <input type="hidden" id="imageFilepath" value="{{ filepath }}">
    <input type="hidden" id="allTags" value="{{ data.all_tags or '' }}">

    <!-- Pool Manager Templates -->
    <template id="pool-error-template">
        <div class="pool-error-message">Failed to load pools</div>
    </template>

    <template id="pool-empty-template">
        <div class="pool-empty-message">No pools available. Create a pool first!</div>
    </template>

    <template id="pool-modal-template">
        <div class="modal-content">
            <span class="close" onclick="closeAddToPoolModal()">&times;</span>
            <h3>Add to Pool</h3>
            <div class="form-group">
                <input type="text" id="poolSearchModal" placeholder="Search pools..."
                    style="width: 100%; padding: 10px; margin-bottom: 15px;">
            </div>
            <div id="poolSelectorList" class="pool-selector-list">
                <div class="loading-spinner">Loading pools...</div>
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn-secondary" onclick="closeAddToPoolModal()">Close</button>
            </div>
        </div>
    </template>

    <!-- Image Page - Retry Tagging Modal Template -->
    <template id="single-image-retry-tagging-template">
        <div class="custom-confirm-overlay">
            <div class="custom-confirm-modal" style="max-width: 500px;">
                <h3 style="margin: 0 0 15px 0; color: #87ceeb;">üîÑ Retry Tagging Options</h3>
                <p style="margin: 0 0 20px 0; color: #d0d0d0; line-height: 1.5;">
                    Choose how to retry tagging for this image:
                </p>
                <div class="retry-options">
                    <button class="retry-option-btn online-only" data-option="online-only">
                        <div class="retry-option-title">üåê Online Sources Only</div>
                        <div class="retry-option-desc">Try Danbooru, e621, and SauceNao. Keep current tags if nothing
                            found.</div>
                    </button>
                    <button class="retry-option-btn with-fallback" data-option="with-fallback">
                        <div class="retry-option-title">ü§ñ With Local AI Fallback</div>
                        <div class="retry-option-desc">Try online sources first, then use local AI tagger if nothing
                            found.</div>
                    </button>
                </div>
                <div class="button-group">
                    <button class="btn-cancel">Cancel</button>
                </div>
            </div>
        </div>
    </template>

    <script>
        // Handle skeleton removal for main image/video - works even if cached
        document.addEventListener('DOMContentLoaded', function () {
            const imageView = document.getElementById('imageViewContainer');
            if (imageView) {
                const mediaElement = imageView.querySelector('img, video');
                if (mediaElement) {
                    // Function to check if media is loaded and remove skeleton
                    function removeSkeleton() {
                        let isLoaded = false;
                        
                        if (mediaElement.tagName === 'IMG') {
                            // Image is loaded if it's complete AND has actual dimensions
                            isLoaded = mediaElement.complete && mediaElement.naturalWidth > 0;
                        } else if (mediaElement.tagName === 'VIDEO') {
                            // Video is loaded when metadata is ready
                            isLoaded = mediaElement.readyState >= 2;
                        }
                        
                        if (isLoaded) {
                            imageView.classList.add('has-image');
                            return true;
                        }
                        return false;
                    }
                    
                    // Check if already loaded (browser cache)
                    if (removeSkeleton()) {
                        return;
                    }
                    
                    // Poll for actual image dimensions since onload might not fire on hard refresh
                    // Check every 100ms for up to 10 seconds
                    let attempts = 0;
                    const maxAttempts = 100; // 100 * 100ms = 10 seconds
                    const pollInterval = setInterval(() => {
                        attempts++;
                        
                        if (removeSkeleton()) {
                            clearInterval(pollInterval);
                        } else if (attempts >= maxAttempts) {
                            // Timeout - force remove skeleton to unblock UI
                            clearInterval(pollInterval);
                            console.warn('Image load timeout, removing skeleton');
                            imageView.classList.add('has-image');
                        }
                    }, 100);
                }
            }
        });
    </script>

    <script src="{{ url_for('static', filename='js/modal.js', v='1.3') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/autocomplete.js', v='2.2') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/tag-editor.js', v='1.7') }}" defer></script>
    <script src="{{ url_for('static', filename='js/image-viewer.js', v='1.3') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/saucenao-fetch.js', v='2.0') }}" defer></script>
    <script src="{{ url_for('static', filename='js/header.js', v='1.3') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/source-selector.js', v='1.3') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/image-page.js', v='3.0') }}" defer></script>
    <script src="{{ url_for('static', filename='js/carousel.js', v='1.3') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/pool-manager.js', v='2.0') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/global-uploader.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/image-preloader.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/animation-player.js', v='1.0') }}" defer></script>
    <script src="{{ url_for('static', filename='js/family-badge.js', v='3.0') }}" defer></script>
    <script src="{{ url_for('static', filename='js/favourites.js', v='1.0') }}" defer></script>
    <script src="{{ url_for('static', filename='js/upscaler.js', v='1.1') }}" defer></script>
    <script src="{{ url_for('static', filename='js/related-images-loader.js', v='1.0') }}" defer></script>
    <script src="{{ url_for('static', filename='js/image-lazy-loader.js', v='1.0') }}" defer></script>
</body>

</html>