<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ filepath.split('/')[-1] }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') + '?v=26' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/saucenao-modal.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animation-player.css') + '?v=1' }}">

    {# Preload main image with high priority - start loading ASAP #}
    {% if not (filepath.endswith('.mp4') or filepath.endswith('.webm')) %}
    <link rel="preload"
        href="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
        as="image" fetchpriority="high">
    {% endif %}

    {# Prefetch related images with lower priority #}
    {% if related_images %}
    {% for related in related_images[:3] %}
    {% if not (related.path.endswith('.mp4') or related.path.endswith('.webm')) %}
    <link rel="prefetch"
        href="/static/{% if not related.path.startswith('images/') %}images/{% endif %}{{ related.path | urlencode_path }}"
        as="image">
    {% endif %}
    {% endfor %}
    {% endif %}
</head>

<body class="image-page">
    <div id="global-drop-zone" class="global-drop-zone">
        <div class="drop-zone-content">
            <div class="drop-zone-icon">üì§</div>
            <div class="drop-zone-text">Drop images to upload</div>
        </div>
    </div>

    {% include 'header.html' %}

    <div class="container">
        <!-- Left Sidebar: Tags -->
        <div class="sidebar-left" id="sidebarLeft">
            <section class="section-content">
                <div class="panel tags-list">
                    <button class="panel-header" onclick="togglePanelCollapse(this)">
                        <span>üè∑Ô∏è Tags</span>
                        <span class="section-arrow">‚ñº</span>
                    </button>
                    <div class="panel-collapsible-content" id="tags-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-size: 0.85em; color: var(--text-muted);">Click tag to search</span>
                            <button class="btn-text-only" onclick="toggleTagEditor()" style="font-size: 11px;">Edit</button>
                        </div>

                                <div id="tags-panel-content">
                            {# Simplified Tag Loop Logic preserved #}
                            {% if categorized_tags %}
                            {% for cat in ['artist', 'copyright', 'character', 'species'] %}
                            {% if categorized_tags[cat] %}
                            <div class="tag-category {{ cat }}">
                                <div class="tag-category-title">{{ cat }}</div>
                                {% for tag, count in categorized_tags[cat] %}
                                <div class="tag-item">
                                    <a href="{{ url_for('main.home', query=cat + ':' + tag) }}" class="tag-link">
                                        <span class="tag-name">{{ tag }}</span>
                                        <span class="tag-count">{{ count }}</span>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% endfor %}

                            {% if extended_grouped_tags %}

                            {# --- Group 1: Identity --- #}
                            {% set group1_cats = [
                            ('00_Subject_Count', 'Subject Count'), ('01_Body_Physique', 'Body Physique'),
                            ('02_Body_Hair', 'Body Hair'), ('03_Body_Face', 'Body Face'),
                            ('04_Body_Genitalia', 'Body Genitalia')
                            ] %}

                            {% set has_group1 = false %}
                            {% for cat_key, _ in group1_cats %}
                            {% if cat_key in extended_grouped_tags %}{% set has_group1 = true %}{% endif %}
                            {% endfor %}

                            {% if has_group1 %}
                            <div class="tag-category general">
                                <div class="tag-category-title" style="border-bottom: 1px solid var(--border-color); padding-bottom:4px; margin-bottom:8px;">
                                    Identity</div>
                                {% for cat_key, cat_display_name in group1_cats %}
                                {% if cat_key in extended_grouped_tags %}
                                <div class="extended-sub-category" style="margin-left: 8px; margin-bottom: 8px;">
                                    <div class="extended-category-title"
                                        style="font-size: 0.8em; color: var(--text-muted); margin-bottom: 2px;">{{
                                        cat_display_name }}</div>
                                    {% for tag, count in extended_grouped_tags[cat_key] %}
                                    <div class="tag-item">
                                        <a href="{{ url_for('main.home', query=tag) }}" class="tag-link">
                                            <span class="tag-name">{{ tag }}</span>
                                            <span class="tag-count">{{ count }}</span>
                                        </a>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}

                            {# --- Group 2: Context --- #}
                            {% set group2_cats = [
                            ('05_Attire_Main', 'Attire Main'), ('06_Attire_Inner', 'Attire Inner'),
                            ('07_Attire_Legwear', 'Attire Legwear'), ('08_Attire_Acc', 'Attire Accessories'),
                            ('21_Status', 'Status'), ('09_Action', 'Action'), ('10_Pose', 'Pose'),
                            ('11_Expression', 'Expression'), ('12_Sexual_Act', 'Sexual Act'),
                            ('13_Object', 'Object'), ('14_Setting', 'Setting')
                            ] %}

                            {% set has_group2 = false %}
                            {% for cat_key, _ in group2_cats %}
                            {% if cat_key in extended_grouped_tags %}{% set has_group2 = true %}{% endif %}
                            {% endfor %}

                            {% if has_group2 %}
                            <div class="tag-category general">
                                <div class="tag-category-title" style="border-bottom: 1px solid var(--border-color); padding-bottom:4px; margin-bottom:8px;">
                                    Context</div>
                                {% for cat_key, cat_display_name in group2_cats %}
                                {% if cat_key in extended_grouped_tags %}
                                <div class="extended-sub-category" style="margin-left: 8px; margin-bottom: 8px;">
                                    <div class="extended-category-title"
                                        style="font-size: 0.8em; color: var(--text-muted); margin-bottom: 2px;">{{
                                        cat_display_name }}</div>
                                    {% for tag, count in extended_grouped_tags[cat_key] %}
                                    <div class="tag-item">
                                        <a href="{{ url_for('main.home', query=tag) }}" class="tag-link">
                                            <span class="tag-name">{{ tag }}</span>
                                            <span class="tag-count">{{ count }}</span>
                                        </a>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}

                            {# --- Group 3: Technical/Meta --- #}
                            {% set group3_cats = [
                            ('15_Framing', 'Framing'), ('16_Focus', 'Focus'), ('17_Style_Art', 'Style Art'),
                            ('18_Style_Tech', 'Style Tech'), ('19_Meta_Attributes', 'Meta Attributes'),
                            ('20_Meta_Text', 'Meta Text')
                            ] %}

                            {% set has_group3 = false %}
                            {% for cat_key, _ in group3_cats %}
                            {% if cat_key in extended_grouped_tags %}{% set has_group3 = true %}{% endif %}
                            {% endfor %}

                            {% if has_group3 %}
                            <div class="tag-category general">
                                <div class="tag-category-title" style="border-bottom: 1px solid var(--border-color); padding-bottom:4px; margin-bottom:8px;">
                                    Technical / Meta</div>
                                {% for cat_key, cat_display_name in group3_cats %}
                                {% if cat_key in extended_grouped_tags %}
                                <div class="extended-sub-category" style="margin-left: 8px; margin-bottom: 8px;">
                                    <div class="extended-category-title"
                                        style="font-size: 0.8em; color: var(--text-muted); margin-bottom: 2px;">{{
                                        cat_display_name }}</div>
                                    {% for tag, count in extended_grouped_tags[cat_key] %}
                                    <div class="tag-item">
                                        <a href="{{ url_for('main.home', query=tag) }}" class="tag-link">
                                            <span class="tag-name">{{ tag }}</span>
                                            <span class="tag-count">{{ count }}</span>
                                        </a>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}

                            {# --- Catch-all --- #}
                            {% if None in extended_grouped_tags %}
                            <div class="tag-category general">
                                <div class="tag-category-title">Other</div>
                                {% for tag, count in extended_grouped_tags[None] %}
                                <div class="tag-item">
                                    <a href="{{ url_for('main.home', query=tag) }}" class="tag-link">
                                        <span class="tag-name">{{ tag }}</span>
                                        <span class="tag-count">{{ count }}</span>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% elif tags %}
                            <div class="tag-category general">
                                <div class="tag-category-title">General</div>
                                {% for tag, count in tags %}
                                <div class="tag-item">
                                    <a href="{{ url_for('main.home', query=tag) }}" class="tag-link">
                                        <span class="tag-name">{{ tag }}</span>
                                        <span class="tag-count">{{ count }}</span>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if categorized_tags.meta %}
                            <div class="tag-category meta">
                                <div class="tag-category-title">Meta</div>
                                {% for tag, count in categorized_tags.meta %}
                                <div class="tag-item">
                                    <a href="{{ url_for('main.home', query='meta:' + tag) }}" class="tag-link">
                                        <span class="tag-name">{{ tag }}</span>
                                        <span class="tag-count">{{ count }}</span>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </section>

            <section class="section-content">
                <div class="panel pool-management">
                    <button class="panel-header" onclick="togglePanelCollapse(this)">
                        <span>üìÅ Pools</span>
                        <span class="section-arrow">‚ñº</span>
                    </button>
                    <div class="panel-collapsible-content" id="pools-content">
                        <div id="poolsList" class="pools-list-container">
                            <div class="loading-spinner">Loading pools...</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Main Content: Image + Actions -->
        <div class="main-content">
            <div class="image-and-actions-container">
                <div class="image-view" id="imageView">
                    <div class="media-container" id="imageViewContainer" data-filepath="{{ filepath }}" {% if
                        filepath.endswith('.zip') %}data-animation-type="zip"
                        data-md5="{{ metadata.md5 if metadata else '' }}" data-fps="10" {% endif %}>

                        {% if filepath.endswith('.mp4') %}
                        <video controls loop preload="metadata"
                            onloadeddata="this.closest('.media-container').style.opacity='1'">
                            <source
                                src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                                type="video/mp4">
                        </video>
                        {% elif filepath.endswith('.webm') %}
                        <video controls loop preload="metadata"
                            onloadeddata="this.closest('.media-container').style.opacity='1'">
                            <source
                                src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                                type="video/webm">
                        </video>
                        {% elif filepath.endswith('.zip') %}
                        <img src="/static/{{ thumbnail_path | urlencode_path }}" alt="Animation" class="animation-poster">
                        <span class="animation-badge">ZIP Animation</span>
                        {% else %}
                        <img src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                            alt="Image">
                        {% endif %}
                    </div>
                </div>

                <!-- Horizontal Actions Bar -->
                <div class="actions-bar">
                    <button class="btn" id="prevBtn" title="Previous (‚Üê)">‚óÄ Previous</button>
                    <button class="btn" id="favouriteBtn" data-filepath="{{ filepath }}" title="Favourite">
                        <span class="favourite-icon">ü§ç</span>
                        <span class="favourite-text">Favourite</span>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleTagEditor()" title="Edit Tags">üìù Edit Tags</button>
                    <button class="btn btn-secondary" onclick="showAddToPoolModal()" title="Add to Pool">üìÅ Add to Pool</button>
                    <a href="{{ url_for('main.similar', filepath=filepath) }}" class="btn btn-secondary"
                        title="Find similar">üîç Find Similar</a>
                    <a href="{{ url_for('main.similar_visual', filepath=filepath) }}" class="btn btn-secondary"
                        title="Visual similar">üëÅÔ∏è Visual Similar</a>
                    <a href="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                        download class="btn btn-success" title="Download">üíæ Download</a>
                    <button class="btn btn-danger" id="deleteImageBtn" onclick="confirmDelete()" title="Delete">üóëÔ∏è Delete</button>
                    <button class="btn" id="nextBtn" title="Next (‚Üí)">Next ‚ñ∂</button>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: Info + Related -->
        <div class="sidebar-right" id="sidebarRight">
            <section class="section-content">
                <div class="panel metadata-info">
                    <button class="panel-header" onclick="togglePanelCollapse(this)">
                        <span>‚ÑπÔ∏è Info</span>
                        <span class="section-arrow">‚ñº</span>
                    </button>
                    <div class="panel-collapsible-content">
                        <div style="display:flex; gap:8px; margin-bottom: 12px;">
                            <button class="btn-text-only" onclick="showSauceNaoFetcher()" style="font-size: 11px;">Check
                                Source</button>
                        </div>

                        <div class="metadata-info-actions" style="margin-bottom: 12px; display: grid; gap: 6px;">
                            <a href="{{ url_for('main.show_raw_data', filepath=filepath) }}" class="btn btn-secondary btn-sm"
                                style="text-align:center; padding: 4px;">View Raw Data</a>
                        </div>

                        {% if metadata %}
                        <div style="font-size: 0.85em; color: var(--text-secondary);">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span>Resolution</span>
                                <span style="color:white;">
                                    {% if metadata.sources %}
                                    {% set first = metadata.sources.values()|list|first %}
                                    {{ first.get('image_width', '?') }} √ó {{ first.get('image_height', '?') }}
                                    {% endif %}
                                </span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span>Size</span>
                                <span style="color:white;">{{ (metadata.sources.values()|list|first).get('file_size') |
                                    filesizeformat
                                    if metadata.sources and (metadata.sources.values()|list|first).get('file_size') else 'N/A'
                                    }}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span>Rating</span>
                                <span style="color:white;">{{ (metadata.sources.values()|list|first).get('rating', '?') | upper
                                    if
                                    metadata.sources else '?' }}</span>
                            </div>

                            {% if metadata.sources %}
                            {% set first_source = metadata.sources.values()|list|first %}
                            {% if first_source.tagger_name %}
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span>Tagger</span>
                                <span style="color: var(--primary-blue);">{{ first_source.tagger_name }}</span>
                            </div>
                            {% endif %}
                            {% endif %}
                            {% if metadata.md5 %}
                            <div
                                style="margin-top:8px; word-break:break-all; font-family:monospace; font-size:10px; color:#666;">
                                {{ metadata.md5 }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </section>

            <section class="section-content">
                <div class="panel related-images-vertical">
                    <button class="panel-header" onclick="togglePanelCollapse(this)">
                        <span>üñºÔ∏è Similar</span>
                        <span class="section-arrow">‚ñº</span>
                    </button>
                    <div class="panel-collapsible-content" id="related-images-content">
                        {% if related_images %}
                        <div class="related-grid">
                            {% for related in related_images %}
                            <a href="/view/{{ related.path | urlencode_path }}" class="related-item related-thumb">
                                <img src="/static/{% if not (related.thumb.startswith('thumbnails/') or related.thumb.startswith('images/')) %}images/{% endif %}{{ related.thumb | urlencode_path }}"
                                    alt="Related" loading="lazy">
                                <span class="related-index">#{{ loop.index }}</span>
                            </a>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Hidden Data Inputs for JS interactivity -->
    <input type="hidden" id="imageFilepath" value="{{ filepath }}">
    <input type="hidden" id="allTags" value="{{ data.all_tags or '' }}">
    
    {% if family_images %}
    <script type="application/json" id="familyImagesData">{{ family_images | tojson }}</script>
    {% endif %}
    {% if metadata and metadata.sources and metadata.sources|length > 1 %}
    <script type="application/json" id="currentSource">{{ data.active_source or '' }}</script>
    <script type="application/json" id="sourceData">{{ metadata.sources|tojson }}</script>
    {% endif %}

    <!-- Modals (Source, Pool, Retry Tagging) - Preserved -->
    {% if metadata.sources and metadata.sources|length > 1 %}
    <div id="sourceModal" class="source-modal">
        <!-- Copied source modal structure -->
        <div class="source-modal-content">
            <div class="source-modal-header">
                <h2>üîÑ Switch Metadata Source</h2>
                <button class="source-modal-close" onclick="closeSourceModal()">&times; Close</button>
            </div>
            <!-- ... Source list items ... -->
            <!-- Simplified for brevity, assume JS handles population or it's static -->
            {# Full logic is needed here for functionality #}
            <div class="source-options">
                {% set active = data.active_source or (metadata.sources.keys()|list|first) %}
                <div class="source-option special-option {% if active == 'merged' %}active{% endif %}"
                    onclick="switchSource('merged')">
                    <div class="source-option-header"><span class="source-name">Merge All Sources</span></div>
                </div>
                {% for source_name, source_data in metadata.sources.items() %}
                <div class="source-option {% if source_name == active %}active{% endif %}"
                    onclick="switchSource('{{ source_name }}')">
                    <div class="source-option-header"><span class="source-name">{{ source_name }}</span></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <template id="pool-modal-template">
        <div class="modal-content">
            <span class="close" onclick="closeAddToPoolModal()">&times;</span>
            <h3>Add to Pool</h3>
            <div class="form-group">
                <input type="text" id="poolSearchModal" placeholder="Search pools..."
                    style="width: 100%; padding: 10px; margin-bottom: 15px;">
            </div>
            <div id="poolSelectorList" class="pool-selector-list">
                <div class="loading-spinner">Loading pools...</div>
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn-secondary" onclick="closeAddToPoolModal()">Close</button>
            </div>
        </div>
    </template>

    <template id="single-image-retry-tagging-template">
        <div class="custom-confirm-overlay">
            <div class="custom-confirm-modal" style="max-width: 500px;">
                <h3 style="margin: 0 0 15px 0; color: #87ceeb;">üîÑ Retry Tagging Options</h3>
                <div class="retry-options">
                    <button class="retry-option-btn online-only" data-option="online-only">
                        <div class="retry-option-title">üåê Online Sources Only</div>
                    </button>
                    <button class="retry-option-btn with-fallback" data-option="with-fallback">
                        <div class="retry-option-title">ü§ñ With Local AI Fallback</div>
                    </button>
                </div>
                <div class="button-group">
                    <button class="btn-cancel">Cancel</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Scripts -->
    <script>
        // Simple panel collapse toggle
        function togglePanelCollapse(element) {
            element.classList.toggle('collapsed');
        }
    </script>
    <script src="{{ url_for('static', filename='js/modal.js', v='1.3') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/autocomplete.js', v='1.g') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/tag-editor.js', v='1.7') }}"></script>
    <script src="{{ url_for('static', filename='js/image-viewer.js', v='2.1') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/saucenao-fetch.js', v='2.0') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js', v='1.3') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/system-panel.js', v='2.0') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/source-selector.js', v='1.3') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/image-page.js', v='3.0') }}"></script>
    <script src="{{ url_for('static', filename='js/carousel.js', v='1.3') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pool-manager.js', v='2.0') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/global-uploader.js') }}"></script>
    <script src="{{ url_for('static', filename='js/image-preloader.js') }}"></script>
    <script src="{{ url_for('static', filename='js/animation-player.js', v='1.0') }}"></script>
    <script src="{{ url_for('static', filename='js/family-badge.js', v='1.0') }}"></script>
    <script src="{{ url_for('static', filename='js/favourites.js', v='1.0') }}"></script>
</body>

</html>