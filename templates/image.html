<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ filepath.split('/')[-1] }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=3' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components-bundle.css') + '?v=19' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gallery.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/saucenao-modal.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animation-player.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/upscaler.css') + '?v=1' }}">

    {# Preload main image with high priority - start loading ASAP #}
    {# If upscaled version exists, preload that; otherwise preload original #}
    {% if not (filepath.endswith('.mp4') or filepath.endswith('.webm')) %}
    <link rel="preload"
        href="{% if upscaled_image_url %}{{ upscaled_image_url }}{% else %}/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}{% endif %}"
        as="image" fetchpriority="high">
    {% endif %}

    {# Related images are now preloaded via JavaScript AFTER main image loads #}
    {# This prevents bandwidth competition on initial page load #}
</head>

<body class="image-page"
    data-information-panel-default-collapsed="{{ 'true' if information_panel_default_collapsed else 'false' }}">
    <div id="global-drop-zone" class="global-drop-zone">
        <div class="drop-zone-content">
            <div class="drop-zone-icon">üì§</div>
            <div class="drop-zone-text">Drop images to upload</div>
        </div>
    </div>

    {% include 'header.html' %}

    <div class="container">
        <script type="application/json"
            id="image-page-defaults">{{ {'information_panel_default_collapsed': information_panel_default_collapsed}|tojson }}</script>
        <div class="sidebar-left" id="sidebarLeft">
            <div class="sidebar-panel">

                {# ‚ïê‚ïê‚ïê TAGS SECTION (fills remaining space) ‚ïê‚ïê‚ïê #}
                <div class="sidebar-section tags-section" id="tags-content">
                    <button class="sec-hdr mobile-toggle" data-section="tags-panel-content">
                        üè∑Ô∏è Tags
                        <span style="color:var(--text-muted);margin-left:4px;font-size:9px;text-transform:none;letter-spacing:0;font-weight:400">
                            {% set tag_count = namespace(n=0) %}
                            {% if categorized_tags %}
                            {% if categorized_tags.artist %}{% set tag_count.n = tag_count.n + categorized_tags.artist|length %}{% endif %}
                            {% if categorized_tags.copyright %}{% set tag_count.n = tag_count.n + categorized_tags.copyright|length %}{% endif %}
                            {% if categorized_tags.character %}{% set tag_count.n = tag_count.n + categorized_tags.character|length %}{% endif %}
                            {% if categorized_tags.species %}{% set tag_count.n = tag_count.n + categorized_tags.species|length %}{% endif %}
                            {% if categorized_tags.meta %}{% set tag_count.n = tag_count.n + categorized_tags.meta|length %}{% endif %}
                            {% endif %}
                            {% if extended_grouped_tags %}
                            {% for cat_key, cat_tags in extended_grouped_tags.items() %}
                            {% set tag_count.n = tag_count.n + cat_tags|length %}
                            {% endfor %}
                            {% elif tags %}
                            {% set tag_count.n = tag_count.n + tags|length %}
                            {% endif %}
                            {{ tag_count.n }}
                        </span>
                        <i class="arrow">‚ñæ</i>
                    </button>
                    <div class="tags-scroll" id="tags-panel-content">
                        {% if categorized_tags %}

                        {# ‚îÄ‚îÄ Artist tags ‚îÄ‚îÄ #}
                        {% if categorized_tags.artist %}
                        <div class="tag-category" data-category="artist">
                            <div class="tag-cat-name">Artist</div>
                            <div class="tag-list">
                                {% for tag, count in categorized_tags.artist %}
                                <a class="tag-chip artist{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                    href="{{ url_for('main.home', query='artist:' + tag) }}"
                                    {% if implied_tag_names and tag in implied_tag_names %}title="Implied by implication rule"{% endif %}>
                                    {% if implied_tag_names and tag in implied_tag_names %}‚ö° {% endif %}{{ tag }}
                                    <span class="cnt">{% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >= 1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}</span>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {# ‚îÄ‚îÄ Copyright tags ‚îÄ‚îÄ #}
                        {% if categorized_tags.copyright %}
                        <div class="tag-category" data-category="copyright">
                            <div class="tag-cat-name">Copyright</div>
                            <div class="tag-list">
                                {% for tag, count in categorized_tags.copyright %}
                                <a class="tag-chip copyright{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                    href="{{ url_for('main.home', query='copyright:' + tag) }}"
                                    {% if implied_tag_names and tag in implied_tag_names %}title="Implied by implication rule"{% endif %}>
                                    {% if implied_tag_names and tag in implied_tag_names %}‚ö° {% endif %}{{ tag }}
                                    <span class="cnt">{% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >= 1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}</span>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {# ‚îÄ‚îÄ Character tags ‚îÄ‚îÄ #}
                        {% if categorized_tags.character %}
                        <div class="tag-category" data-category="character">
                            <div class="tag-cat-name">Character</div>
                            <div class="tag-list">
                                {% for tag, count in categorized_tags.character %}
                                <a class="tag-chip character{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                    href="{{ url_for('main.home', query='character:' + tag) }}"
                                    {% if implied_tag_names and tag in implied_tag_names %}title="Implied by implication rule"{% endif %}>
                                    {% if implied_tag_names and tag in implied_tag_names %}‚ö° {% endif %}{{ tag }}
                                    <span class="cnt">{% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >= 1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}</span>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {# ‚îÄ‚îÄ Species tags ‚îÄ‚îÄ #}
                        {% if categorized_tags.species %}
                        <div class="tag-category" data-category="species">
                            <div class="tag-cat-name">Species</div>
                            <div class="tag-list">
                                {% for tag, count in categorized_tags.species %}
                                <a class="tag-chip species{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                    href="{{ url_for('main.home', query='species:' + tag) }}"
                                    {% if implied_tag_names and tag in implied_tag_names %}title="Implied by implication rule"{% endif %}>
                                    {% if implied_tag_names and tag in implied_tag_names %}‚ö° {% endif %}{{ tag }}
                                    <span class="cnt">{% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >= 1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}</span>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {# ‚îÄ‚îÄ Extended grouped general tags ‚îÄ‚îÄ #}
                        {% if extended_grouped_tags %}

                        {# Extended category key ‚Üí CSS class mapping #}
                        {% set ext_css_map = {
                            '00_Subject_Count': 'ext-subject',
                            '01_Body_Physique': 'ext-physique',
                            '02_Body_Hair': 'ext-hair',
                            '03_Body_Face': 'ext-face',
                            '04_Body_Genitalia': 'ext-genitalia',
                            '05_Attire_Main': 'ext-attire-main',
                            '06_Attire_Inner': 'ext-attire-inner',
                            '07_Attire_Legwear': 'ext-attire-legwear',
                            '08_Attire_Acc': 'ext-attire-acc',
                            '09_Action': 'ext-action',
                            '10_Pose': 'ext-pose',
                            '11_Expression': 'ext-expression',
                            '12_Sexual_Act': 'ext-sexual',
                            '13_Object': 'ext-object',
                            '14_Setting': 'ext-setting',
                            '15_Framing': 'ext-framing',
                            '16_Focus': 'ext-focus',
                            '17_Style_Art': 'ext-style-art',
                            '18_Style_Tech': 'ext-style-tech',
                            '19_Meta_Attributes': 'ext-meta-attr',
                            '20_Meta_Text': 'ext-meta-text',
                            '21_Status': 'ext-status'
                        } %}

                        {% set extended_category_order = [
                            ('00_Subject_Count', 'Subject Count'),
                            ('01_Body_Physique', 'Body Physique'),
                            ('02_Body_Hair', 'Body Hair'),
                            ('03_Body_Face', 'Body Face'),
                            ('04_Body_Genitalia', 'Body Genitalia'),
                            ('05_Attire_Main', 'Attire Main'),
                            ('06_Attire_Inner', 'Attire Inner'),
                            ('07_Attire_Legwear', 'Attire Legwear'),
                            ('08_Attire_Acc', 'Attire Accessories'),
                            ('09_Action', 'Action'),
                            ('10_Pose', 'Pose'),
                            ('11_Expression', 'Expression'),
                            ('12_Sexual_Act', 'Sexual Act'),
                            ('13_Object', 'Object'),
                            ('14_Setting', 'Setting'),
                            ('15_Framing', 'Framing'),
                            ('16_Focus', 'Focus'),
                            ('17_Style_Art', 'Style Art'),
                            ('18_Style_Tech', 'Style Tech'),
                            ('19_Meta_Attributes', 'Meta Attributes'),
                            ('20_Meta_Text', 'Meta Text'),
                            ('21_Status', 'Status'),
                            (None, 'Uncategorized')
                        ] %}

                        {% for cat_key, cat_display_name in extended_category_order %}
                        {% if cat_key in extended_grouped_tags or (cat_key is none and None in extended_grouped_tags) %}
                        <div class="tag-category" data-category="general">
                            <div class="tag-cat-name">{{ cat_display_name }}</div>
                            <div class="tag-list">
                                {% set chip_class = ext_css_map.get(cat_key, 'ext-uncategorized') if cat_key else 'ext-uncategorized' %}
                                {% for tag, count in extended_grouped_tags[cat_key] %}
                                <a class="tag-chip {{ chip_class }}{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                    href="{{ url_for('main.home', query=tag) }}"
                                    {% if implied_tag_names and tag in implied_tag_names %}title="Implied by implication rule"{% endif %}>
                                    {% if implied_tag_names and tag in implied_tag_names %}‚ö° {% endif %}{{ tag }}
                                    <span class="cnt">{% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >= 1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}</span>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}

                        {% elif tags %}
                        {# Fallback: flat general tags #}
                        <div class="tag-category" data-category="general">
                            <div class="tag-cat-name">General</div>
                            <div class="tag-list">
                                {% for tag, count in tags %}
                                <a class="tag-chip general{% if implied_tag_names and tag in implied_tag_names %} implied{% endif %}"
                                    href="{{ url_for('main.home', query=tag) }}"
                                    {% if implied_tag_names and tag in implied_tag_names %}title="Implied by implication rule"{% endif %}>
                                    {% if implied_tag_names and tag in implied_tag_names %}‚ö° {% endif %}{{ tag }}
                                    <span class="cnt">{% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >= 1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}</span>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {# ‚îÄ‚îÄ Meta tags + deltas ‚îÄ‚îÄ #}
                        {% if categorized_tags.meta or (tag_deltas and (tag_deltas.added or tag_deltas.removed)) %}
                        <div class="tag-category" data-category="meta">
                            <div class="tag-cat-name">Meta</div>
                            <div class="tag-list">
                                {% if categorized_tags.meta %}
                                {% for tag, count in categorized_tags.meta %}
                                <a class="tag-chip meta" href="{{ url_for('main.home', query='meta:' + tag) }}">
                                    {% if tag.startswith('rating:') %}
                                    {% if tag == 'rating:general' %}General{% elif tag == 'rating:sensitive' %}Sensitive{% elif tag == 'rating:questionable' %}Questionable{% elif tag == 'rating:explicit' %}Explicit{% else %}{{ tag }}{% endif %}
                                    {% else %}{{ tag }}{% endif %}
                                    <span class="cnt">{% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >= 1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}</span>
                                </a>
                                {% endfor %}
                                {% endif %}
                            </div>

                            {% if tag_deltas and (tag_deltas.added or tag_deltas.removed) %}
                            <div class="tag-category-subtitle">Manual modifications</div>
                            <div class="tag-list">
                                {% if tag_deltas.added %}
                                {% for tag_info in tag_deltas.added %}
                                <a class="tag-chip delta-added" href="{{ url_for('main.home', query=tag_info.name) }}">+{{ tag_info.name }}</a>
                                {% endfor %}
                                {% endif %}
                                {% if tag_deltas.removed %}
                                {% for tag_info in tag_deltas.removed %}
                                <a class="tag-chip delta-removed" href="{{ url_for('main.home', query=tag_info.name) }}">-{{ tag_info.name }}</a>
                                {% endfor %}
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% else %}
                        {# Fallback: no categorized tags at all #}
                        {% for tag, count in tags %}
                        <div class="tag-category" data-category="general">
                            <div class="tag-list">
                                <a class="tag-chip general" href="{{ url_for('main.home', query=tag) }}">
                                    {{ tag }}
                                    <span class="cnt">{% if count >= 1000000 %}{{ "%.1f"|format(count / 1000000.0) }}M{% elif count >= 1000 %}{{ "%.1f"|format(count / 1000.0) }}k{% else %}{{ count }}{% endif %}</span>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>

                {# ‚ïê‚ïê‚ïê ACTIONS SECTION (moved to floating toolbar on image) ‚ïê‚ïê‚ïê #}
                {# Actions are now in .image-toolbar inside .image-view-wrapper #}

                {# ‚ïê‚ïê‚ïê INFORMATION SECTION (collapsible) ‚ïê‚ïê‚ïê #}
                {% if metadata %}
                <div class="sidebar-section" id="metadata-content">
                    <button class="sec-hdr mobile-toggle{% if information_panel_default_collapsed %} collapsed{% endif %}" data-section="metadata-panel-content">
                        ‚ÑπÔ∏è Information <i class="arrow">‚ñæ</i>
                    </button>
                    <div class="sec-body{% if information_panel_default_collapsed %} collapsed{% endif %}" id="metadata-panel-content">

                        {# Rating #}
                        {% if metadata.sources %}
                        {% set first_source = metadata.sources.values()|list|first %}
                        {% if first_source.rating %}
                        <div class="meta-row">
                            <span class="meta-label">Rating</span>
                            <span class="meta-value">
                                <span class="rating-badge {% if first_source.rating == 'g' %}rating-general{% elif first_source.rating == 's' %}rating-sensitive{% elif first_source.rating == 'q' %}rating-questionable{% elif first_source.rating == 'e' %}rating-explicit{% endif %}">
                                    {% if first_source.rating == 'g' %}‚úì General
                                    {% elif first_source.rating == 's' %}‚ö† Sensitive
                                    {% elif first_source.rating == 'q' %}‚ö† Questionable
                                    {% elif first_source.rating == 'e' %}‚úó Explicit
                                    {% else %}{{ first_source.rating }}{% endif %}
                                </span>
                            </span>
                        </div>
                        {% endif %}

                        {# Score #}
                        {% set score = first_source.score if first_source.score is defined else none %}
                        <div class="meta-row">
                            <span class="meta-label">Score</span>
                            <span class="meta-value" style="flex:1; text-align:left; margin-left:12px">
                                {% if score is mapping %}
                                {{ score.total if score.total is defined else (score['total'] if 'total' in score else score) }}
                                {% else %}
                                {{ score if score is not none else '‚Äî' }}
                                {% endif %}
                            </span>
                        </div>

                        {# Resolution #}
                        {% set width = first_source.image_width or (first_source.file.width if first_source.file else none) %}
                        {% set height = first_source.image_height or (first_source.file.height if first_source.file else none) %}
                        {% if data.image_width and data.image_height %}
                        <div class="meta-row" id="resolution-stat-box">
                            <span class="meta-label">Resolution</span>
                            <span class="meta-value" id="metadata-resolution"
                                data-original-resolution="{{ data.image_width }}√ó{{ data.image_height }}">
                                {% if data.upscaled_width and data.upscaled_height %}
                                <span style="opacity: 0.7">{{ data.image_width }}√ó{{ data.image_height }}</span>
                                ‚ûú <strong>{{ data.upscaled_width }}√ó{{ data.upscaled_height }}</strong>
                                {% else %}
                                {{ data.image_width }}√ó{{ data.image_height }}
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}

                        {# File size #}
                        {% set file_size = first_source.file_size or (first_source.file.size if first_source.file else none) %}
                        {% if file_size %}
                        <div class="meta-row">
                            <span class="meta-label">Size</span>
                            <span class="meta-value" id="metadata-filesize">
                                {% if file_size >= 1048576 %}{{ "%.1f"|format(file_size / 1048576.0) }} MB
                                {% elif file_size >= 1024 %}{{ "%.1f"|format(file_size / 1024.0) }} KB
                                {% else %}{{ file_size }} bytes{% endif %}
                            </span>
                        </div>
                        {% endif %}
                        {% endif %}

                        {# Source links #}
                        {% if metadata.sources %}
                        {% set selected_source_name = data.active_source if data.active_source and data.active_source in metadata.sources else (metadata.sources.keys()|list|first) %}
                        {% set selected_source_data = metadata.sources.get(selected_source_name, {}) %}
                        {% set source_ns = namespace(url=none) %}

                        {% if selected_source_data.source is defined and selected_source_data.source is string %}
                        {% for source_token in selected_source_data.source.strip().split() %}
                        {% if source_ns.url is none and (source_token.startswith('http://') or source_token.startswith('https://')) %}
                        {% set source_ns.url = source_token %}
                        {% endif %}
                        {% endfor %}
                        {% endif %}

                        {% if source_ns.url is none and selected_source_data.sources is defined and selected_source_data.sources is iterable %}
                        {% for source_candidate in selected_source_data.sources %}
                        {% if source_ns.url is none and source_candidate is string %}
                        {% set trimmed_source = source_candidate.strip() %}
                        {% if trimmed_source.startswith('http://') or trimmed_source.startswith('https://') %}
                        {% set source_ns.url = trimmed_source %}
                        {% endif %}
                        {% elif source_ns.url is none and source_candidate is mapping and source_candidate.url is defined and source_candidate.url is string %}
                        {% set trimmed_source = source_candidate.url.strip() %}
                        {% if trimmed_source.startswith('http://') or trimmed_source.startswith('https://') %}
                        {% set source_ns.url = trimmed_source %}
                        {% endif %}
                        {% endif %}
                        {% endfor %}
                        {% endif %}

                        <div class="meta-row">
                            <span class="meta-label">Found On</span>
                            <span class="meta-value">
                                <span class="source-links-inline">
                                    {% for source_name, source_data in metadata.sources.items() %}
                                    {% if source_name == 'danbooru' %}
                                    <a href="https://danbooru.donmai.us/posts/{{ source_data.id }}" target="_blank" rel="noopener">Danbooru #{{ source_data.id }}</a>
                                    {% elif source_name == 'e621' %}
                                    <a href="https://e621.net/posts/{{ source_data.id }}" target="_blank" rel="noopener">e621 #{{ source_data.id }}</a>
                                    {% elif source_name == 'gelbooru' %}
                                    <a href="https://gelbooru.com/index.php?page=post&s=view&id={{ source_data.id }}" target="_blank" rel="noopener">Gelbooru #{{ source_data.id }}</a>
                                    {% elif source_name == 'yandere' %}
                                    <a href="https://yande.re/post/show/{{ source_data.id }}" target="_blank" rel="noopener">Yande.re #{{ source_data.id }}</a>
                                    {% elif source_name == 'pixiv' and source_data.pixiv_id %}
                                    <a href="https://www.pixiv.net/en/artworks/{{ source_data.pixiv_id }}" target="_blank" rel="noopener">Pixiv #{{ source_data.pixiv_id }}</a>
                                    {% elif source_name == 'local_tagger' or source_name == 'camie_tagger' %}
                                    <a href="javascript:void(0)" onclick="confirmRetryTagging()" class="ai-tagged-link" title="Click to retry tagging">
                                        ü§ñ {% if source_data.tagger_name and source_data.tagger_name != 'Unknown' %}{{ source_data.tagger_name }}{% else %}Not Found{% endif %} üîÑ
                                    </a>
                                    {% endif %}
                                    {% endfor %}
                                </span>
                            </span>
                        </div>

                        {% if source_ns.url %}
                        <div class="meta-row">
                            <span class="meta-label">Source</span>
                            <span class="meta-value"><a href="{{ source_ns.url }}" target="_blank" rel="noopener">Original Upload</a></span>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="meta-row">
                            <span class="meta-label">Found On</span>
                            <span class="meta-value">
                                <a href="javascript:void(0)" onclick="confirmRetryTagging()" title="Click to try finding tags">
                                    ü§ñ Not Found üîÑ
                                </a>
                            </span>
                        </div>
                        {% endif %}

                        {# Source switcher #}
                        {% if metadata.sources and metadata.sources|length > 1 %}
                        <div class="meta-row">
                            <span class="meta-label">Metadata</span>
                            <span class="meta-value">
                                <button class="source-toggle-btn" onclick="openSourceModal()" style="font-size:10px; padding:2px 6px; cursor:pointer; background:none; border:1px solid var(--border-color); border-radius:4px; color:var(--text-secondary); font-family:inherit;">
                                    {% set active = data.active_source or (metadata.sources.keys()|list|first) %}
                                    {% if active == 'merged' %}üîÄ Merged ({{ metadata.sources|length }})
                                    {% elif active == 'danbooru' %}üîµ Danbooru
                                    {% elif active == 'e621' %}üü¢ e621
                                    {% elif active == 'gelbooru' %}üü° Gelbooru
                                    {% elif active == 'yandere' %}üî¥ Yande.re
                                    {% elif active == 'local_tagger' or active == 'camie_tagger' %}ü§ñ {{ metadata.sources.get(active, {}).get('tagger_name', 'AI Tagger') }}
                                    {% else %}{{ active|title }}{% endif %}
                                    ‚Üï
                                </button>
                            </span>
                        </div>
                        <script type="application/json" id="currentSource">{{ data.active_source or '' }}</script>
                        <script type="application/json" id="sourceData">{{ metadata.sources|tojson }}</script>
                        {% endif %}

                        {# MD5 #}
                        {% if metadata.md5 %}
                        <div class="meta-row">
                            <span class="meta-label">MD5</span>
                            <span class="meta-value"><span class="mono">{{ metadata.md5 }}</span></span>
                        </div>
                        {% endif %}

                        {% if data.id %}
                        <div class="meta-row">
                            <span class="meta-label">Local ID</span>
                            <span class="meta-value"><span class="mono">{{ data.id }}</span></span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {# ‚ïê‚ïê‚ïê POOLS SECTION (collapsible, hidden by default) ‚ïê‚ïê‚ïê #}
                {% if image_pools %}
                <div class="sidebar-section pools-section" id="pools-content">
                    <button class="sec-hdr collapsed mobile-toggle" data-section="pools-panel-content">
                        üìÅ Pools <span style="color:var(--text-muted);margin-left:4px;font-size:9px;text-transform:none;letter-spacing:0;font-weight:400" id="poolCountBadge"></span>
                        <i class="arrow">‚ñæ</i>
                    </button>
                    <div class="sec-body collapsed pools-body" id="pools-panel-content">
                        <div id="poolsList" class="pools-list-container">
                            <div class="loading-spinner">Loading pools...</div>
                        </div>
                    </div>
                </div>
                {% endif %}


            </div>
        </div>

        <div class="main-content">
            <div class="image-and-actions-container">
                <div class="image-view-wrapper">
                    <button class="image-nav-btn image-nav-prev" id="prevBtn" title="Previous image (‚Üê)">‚óÄ</button>
                    <div class="image-view skeleton{% if (data.upscaled_width and data.upscaled_height) or (data.image_width and data.image_height) %} image-skeleton-sized{% endif %}"
                        id="imageViewContainer" data-filepath="{{ filepath }}" 
                        {% if data.upscaled_width and data.upscaled_height %}
                        data-width="{{ data.upscaled_width }}" data-height="{{ data.upscaled_height }}"
                        style="--img-w: {{ data.upscaled_width }}; --img-h: {{ data.upscaled_height }};"
                        {% elif data.image_width and data.image_height %}
                        data-width="{{ data.image_width }}" data-height="{{ data.image_height }}"
                        style="--img-w: {{ data.image_width }}; --img-h: {{ data.image_height }};"
                        {% endif %}
                        {% if filepath.endswith('.zip') %}data-animation-type="zip"
                        data-md5="{{ metadata.md5 if metadata else '' }}" data-fps="24"{% endif %}>
                        {% if filepath.endswith('.mp4') %}
                        <video controls loop preload="auto" autoplay muted poster="/static/{{ thumbnail_path | urlencode_path }}"
                            onloadeddata="this.closest('.image-view').classList.add('has-image')">
                            <source
                                src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                                type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        {% elif filepath.endswith('.webm') %}
                        <video controls loop preload="auto" autoplay muted poster="/static/{{ thumbnail_path | urlencode_path }}"
                            onloadeddata="this.closest('.image-view').classList.add('has-image')">
                            <source
                                src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                                type="video/webm">
                            Your browser does not support the video tag.
                        </video>
                        {% elif filepath.endswith('.zip') %}
                        {# Zip animation - show thumbnail as poster, animation player will take over #}
                        <img src="/static/{{ thumbnail_path | urlencode_path }}" alt="Animation" fetchpriority="high"
                            onload="this.closest('.image-view').classList.add('has-image')" class="animation-poster">
                        <span class="animation-badge">ZIP Animation</span>
                        {% elif filepath.endswith(('.gif', '.webp', '.apng')) %}
                        {# Animated images - play natively with their own embedded FPS #}
                        <img src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                            alt="Animated Image" fetchpriority="high" decoding="async"
                            onload="this.closest('.image-view').classList.add('has-image')">
                        <span class="animation-badge">Animated</span>
                        {% else %}
                        {% if upscaled_image_url %}
                        <img src="{{ upscaled_image_url }}" alt="Upscaled Image" fetchpriority="high"
                            onload="this.closest('.image-view').classList.add('has-image')"
                            onerror="this.src='/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}'; this.onerror = null; this.closest('.image-view').classList.add('has-image');"
                            data-original-src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}">
                        <span class="animation-badge" style="background: rgba(0, 255, 128, 0.8);">Upscaled</span>
                        {% else %}
                        <img src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                            alt="Image" fetchpriority="high"
                            onload="this.closest('.image-view').classList.add('has-image')"
                            onerror="this.closest('.image-view').classList.add('has-image', 'load-error'); console.error('Image failed to load:', this.src);">
                        {% endif %}
                        {% endif %}
                    </div>
                    <button class="image-nav-btn image-nav-next" id="nextBtn" title="Next image (‚Üí)">‚ñ∂</button>

                    {# ‚ïê‚ïê‚ïê FLOATING ACTION TOOLBAR ‚ïê‚ïê‚ïê #}
                    <div class="image-toolbar" id="imageToolbar">
                        <button class="toolbar-btn primary" onclick="toggleTagEditor()" title="Edit Tags and Relations">
                            <span class="toolbar-icon">üìù</span>
                        </button>
                        <button class="toolbar-btn" onclick="showSauceNaoFetcher()" title="Fetch Metadata">
                            <span class="toolbar-icon">üåê</span>
                        </button>
                        <button class="toolbar-btn" id="upscaleBtn" title="Upscale Image (AI 4x)">
                            <span class="toolbar-icon upscale-icon">‚ú®</span>
                        </button>
                        <div class="toolbar-divider"></div>
                        <button class="toolbar-btn favourite" id="favouriteBtn" data-filepath="{{ filepath }}" title="Favourite">
                            <span class="toolbar-icon"><span class="favourite-icon">ü§ç</span></span>
                        </button>
                        <button class="toolbar-btn" id="addToPoolBtn" onclick="showAddToPoolModal()" title="Add to Pool">
                            <span class="toolbar-icon">üìÅ</span>
                        </button>
                        <a href="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                            download class="toolbar-btn" title="Download" id="download-btn">
                            <span class="toolbar-icon">üíæ</span>
                        </a>
                        <div class="toolbar-divider"></div>
                        <a href="{{ url_for('main.show_raw_data', filepath=filepath) }}" class="toolbar-btn" title="Raw Data">
                            <span class="toolbar-icon">üìÑ</span>
                        </a>
                        <button id="deleteImageBtn" class="toolbar-btn danger" title="Delete Image">
                            <span class="toolbar-icon">üóëÔ∏è</span>
                        </button>
                    </div>
                </div>

                {# Family badge data - parent/child images #}
                {% if family_images %}
                <script type="application/json" id="familyImagesData">{{ family_images | tojson }}</script>
                {% endif %}

                <div class="actions-row">
                    {# Action buttons moved to sidebar Actions panel #}
                    <!-- Family filmstrip will be inserted here by JavaScript -->
                </div>
            </div>
        </div>

        <div class="sidebar-right" id="sidebarRight">
            <div class="section-content" id="sidebar-right-content">
                {# Always show similar images section - data will be lazy-loaded #}
                <script type="application/json"
                    id="similarConfig">{"sources": "{{ similar_sidebar_sources }}", "showChips": {{ similar_sidebar_show_chips|tojson }}}</script>
                <script type="application/json" id="relatedImagesData">{{ related_images|tojson }}</script>
                <div class="related-images-vertical panel" {% if not similar_sidebar_show_chips %}data-hide-chips="true"
                    {% endif %}>
                    <button class="panel-header mobile-toggle" data-section="related-images-content">
                        <span class="section-icon">üîó</span>
                        <span class="section-title">
                            Similar
                            <span class="text-muted-tiny" id="similar-count">
                                (0 images)
                            </span>
                        </span>
                        <span class="section-arrow">‚ñº</span>
                    </button>
                    <h3 class="desktop-only">
                        <span>üîó</span>
                        Similar
                        <span class="text-muted-tiny" id="similar-count-desktop">
                            (0 images)
                        </span>
                    </h3>
                    <div class="panel-collapsible-content" id="related-images-content">
                        <div class="related-grid-vertical">
                            <div class="loading-spinner" style="text-align: center; padding: 20px; color: #888;">
                                Loading similar images...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if metadata.sources and metadata.sources|length > 1 %}
    <div id="sourceModal" class="source-modal">
        <div class="source-modal-content">
            <div class="source-modal-header">
                <h2>üîÑ Switch Metadata Source</h2>
                <button class="source-modal-close" onclick="closeSourceModal()">&times; Close</button>
            </div>
            <div class="source-options">
                {% set active = data.active_source or (metadata.sources.keys()|list|first) %}
                <!-- Merge All Sources Option -->
                <div class="source-option special-option {% if active == 'merged' %}active{% endif %}"
                    onclick="switchSource('merged')">
                    <div class="source-option-header">
                        <span class="source-emoji">üîÄ</span>
                        <span class="source-name">Merge All Sources</span>
                        {% if active == 'merged' %}
                        <span class="active-badge">Active</span>
                        {% endif %}
                    </div>
                    <div class="source-meta">
                        <span class="meta-badge categorized">Combined from {{ metadata.sources|length }} sources</span>
                        <span class="meta-badge count">
                            All tags merged & deduplicated
                        </span>
                    </div>
                </div>
                {% if active == 'merged' %}
                <div class="source-hint">
                    üí° Select any individual source below to switch back to its tags only
                </div>
                {% endif %}
                <!-- Individual Sources -->
                {% for source_name, source_data in metadata.sources.items() %}
                <div class="source-option {% if source_name == active %}active{% endif %}"
                    onclick="switchSource('{{ source_name }}')">
                    <div class="source-option-header">
                        <span class="source-emoji">
                            {% if source_name == 'danbooru' %}üîµ
                            {% elif source_name == 'e621' %}üü¢
                            {% elif source_name == 'gelbooru' %}üü°
                            {% elif source_name == 'yandere' %}üî¥
                            {% elif source_name == 'local_tagger' or source_name == 'camie_tagger' %}ü§ñ
                            {% else %}üì¶{% endif %}
                        </span>
                        <span class="source-name">
                            {% if source_name == 'danbooru' %}Danbooru
                            {% elif source_name == 'e621' %}e621
                            {% elif source_name == 'gelbooru' %}Gelbooru
                            {% elif source_name == 'yandere' %}Yande.re
                            {% elif source_name == 'local_tagger' or source_name == 'camie_tagger' %}{{
                            source_data.tagger_name or 'AI Tagger' }}
                            {% else %}{{ source_name|title }}{% endif %}
                        </span>
                        {% if source_name == active %}
                        <span class="active-badge">Active</span>
                        {% endif %}
                    </div>
                    <div class="source-meta">
                        {% if source_name in ['danbooru', 'e621', 'local_tagger', 'camie_tagger'] %}
                        <span class="meta-badge categorized">Categorized Tags</span>
                        {% else %}
                        <span class="meta-badge general">General Tags Only</span>
                        {% endif %}
                        <span class="meta-badge count">
                            {% if source_name == 'danbooru' %}
                            {% set all_tags = (source_data.tag_string_character or '') + ' ' +
                            (source_data.tag_string_copyright or '') + ' ' + (source_data.tag_string_artist or '') + ' '
                            + (source_data.tag_string_meta or '') + ' ' + (source_data.tag_string_general or '') %}
                            {{ all_tags.split()|length }} tags
                            {% elif source_name == 'e621' %}
                            {% set tag_count = 0 %}
                            {% if source_data.tags %}
                            {% for category_tags in source_data.tags.values() %}
                            {% set tag_count = tag_count + (category_tags|length if category_tags is iterable and
                            category_tags is not string else 0) %}
                            {% endfor %}
                            {% endif %}
                            {{ tag_count }} tags
                            {% elif source_name == 'local_tagger' or source_name == 'camie_tagger' %}
                            {% set tag_count = 0 %}
                            {% if source_data.tags %}
                            {% for category_tags in source_data.tags.values() %}
                            {% set tag_count = tag_count + (category_tags|length if category_tags is iterable and
                            category_tags is not string else 0) %}
                            {% endfor %}
                            {% endif %}
                            {{ tag_count }} tags
                            {% elif source_data.tags %}
                            {{ (source_data.tags.split()|length if source_data.tags is string else
                            source_data.tags|length) }} tags
                            {% else %}
                            0 tags
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <input type="hidden" id="imageFilepath" value="{{ filepath }}">
    <input type="hidden" id="imageId" value="{{ data.id or '' }}">
    <input type="hidden" id="allTags" value="{{ data.all_tags or '' }}">
    <script type="application/json" id="manualRelationsData">{{ image_relations|tojson }}</script>

    <!-- Pool Manager Templates -->
    <template id="pool-error-template">
        <div class="pool-error-message">Failed to load pools</div>
    </template>

    <template id="pool-empty-template">
        <div class="pool-empty-message">No pools available. Create a pool first!</div>
    </template>

    <template id="pool-modal-template">
        <div class="modal-content">
            <span class="close" onclick="closeAddToPoolModal()">&times;</span>
            <h3>Add to Pool</h3>
            <div class="form-group">
                <input type="text" id="poolSearchModal" placeholder="Search pools..."
                    style="width: 100%; padding: 10px; margin-bottom: 15px;">
            </div>
            <div id="poolSelectorList" class="pool-selector-list">
                <div class="loading-spinner">Loading pools...</div>
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn-secondary" onclick="closeAddToPoolModal()">Close</button>
            </div>
        </div>
    </template>

    <!-- Image Page - Retry Tagging Modal Template -->
    <template id="single-image-retry-tagging-template">
        <div class="custom-confirm-overlay">
            <div class="custom-confirm-modal" style="max-width: 500px;">
                <h3 style="margin: 0 0 15px 0; color: #87ceeb;">üîÑ Retry Tagging Options</h3>
                <p style="margin: 0 0 20px 0; color: #d0d0d0; line-height: 1.5;">
                    Choose how to retry tagging for this image:
                </p>
                <div class="retry-options">
                    <button class="retry-option-btn online-only" data-option="online-only">
                        <div class="retry-option-title">üåê Online Sources Only</div>
                        <div class="retry-option-desc">Try Danbooru, e621, and SauceNao. Keep current tags if nothing
                            found.</div>
                    </button>
                    <button class="retry-option-btn with-fallback" data-option="with-fallback">
                        <div class="retry-option-title">ü§ñ With Local AI Fallback</div>
                        <div class="retry-option-desc">Try online sources first, then use local AI tagger if nothing
                            found.</div>
                    </button>
                </div>
                <div class="button-group">
                    <button class="btn-cancel">Cancel</button>
                </div>
            </div>
        </div>
    </template>

    <script>
        // Handle skeleton removal for main image/video - works even if cached
        document.addEventListener('DOMContentLoaded', function () {
            const imageView = document.getElementById('imageViewContainer');
            if (imageView) {
                const mediaElement = imageView.querySelector('img, video');
                if (mediaElement) {
                    // Function to check if media is loaded and remove skeleton
                    function removeSkeleton() {
                        let isLoaded = false;
                        
                        if (mediaElement.tagName === 'IMG') {
                            // Image is loaded if it's complete AND has actual dimensions
                            isLoaded = mediaElement.complete && mediaElement.naturalWidth > 0;
                        } else if (mediaElement.tagName === 'VIDEO') {
                            // Video is loaded when metadata is ready
                            isLoaded = mediaElement.readyState >= 2;
                        }
                        
                        if (isLoaded) {
                            imageView.classList.add('has-image');
                            return true;
                        }
                        return false;
                    }
                    
                    // Check if already loaded (browser cache)
                    if (removeSkeleton()) {
                        return;
                    }
                    
                    // Poll for actual image dimensions since onload might not fire on hard refresh
                    // Check every 100ms for up to 10 seconds
                    let attempts = 0;
                    const maxAttempts = 100; // 100 * 100ms = 10 seconds
                    const pollInterval = setInterval(() => {
                        attempts++;
                        
                        if (removeSkeleton()) {
                            clearInterval(pollInterval);
                        } else if (attempts >= maxAttempts) {
                            // Timeout - force remove skeleton to unblock UI
                            clearInterval(pollInterval);
                            console.warn('Image load timeout, removing skeleton');
                            imageView.classList.add('has-image');
                        }
                    }, 100);
                }
            }
        });
    </script>

    <script src="{{ url_for('static', filename='js/modal.js', v='1.3') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/autocomplete.js', v='2.2') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/tag-editor.js', v='1.9') }}" defer></script>
    <script src="{{ url_for('static', filename='js/image-viewer.js', v='1.3') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/saucenao-fetch.js', v='2.0') }}" defer></script>
    <script src="{{ url_for('static', filename='js/header.js', v='1.3') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/source-selector.js', v='1.3') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/image-page.js', v='3.0') }}" defer></script>
    <script src="{{ url_for('static', filename='js/carousel.js', v='1.3') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/pool-manager.js', v='2.0') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/global-uploader.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/image-preloader.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/animation-player.js', v='1.0') }}" defer></script>
    <script src="{{ url_for('static', filename='js/family-badge.js', v='3.3') }}" defer></script>
    <script src="{{ url_for('static', filename='js/favourites.js', v='1.0') }}" defer></script>
    <script src="{{ url_for('static', filename='js/upscaler.js', v='1.1') }}" defer></script>
    <script src="{{ url_for('static', filename='js/related-images-loader.js', v='1.0') }}" defer></script>
    <script src="{{ url_for('static', filename='js/image-lazy-loader.js', v='1.2') }}" defer></script>
</body>

</html>
