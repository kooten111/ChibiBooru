<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ filepath.split('/')[-1] }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') + '?v=26' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/image.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/saucenao-modal.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animation-player.css') + '?v=1' }}">

    {# Preload main image with high priority - start loading ASAP #}
    {% if not (filepath.endswith('.mp4') or filepath.endswith('.webm')) %}
    <link rel="preload"
        href="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
        as="image" fetchpriority="high">
    {% endif %}

    {# Prefetch related images with lower priority #}
    {% if related_images %}
    {% for related in related_images[:3] %}
    {% if not (related.path.endswith('.mp4') or related.path.endswith('.webm')) %}
    <link rel="prefetch"
        href="/static/{% if not related.path.startswith('images/') %}images/{% endif %}{{ related.path | urlencode_path }}"
        as="image">
    {% endif %}
    {% endfor %}
    {% endif %}
</head>

<body class="image-page">
    <div id="global-drop-zone" class="global-drop-zone">
        <div class="drop-zone-content">
            <div class="drop-zone-icon">üì§</div>
            <div class="drop-zone-text">Drop images to upload</div>
        </div>
    </div>

    <!-- Compact Header -->
    <header class="compact-header">
        <div class="header-left">
            <a href="/" class="app-title">ChibiBooru</a>
            <input type="text" placeholder="Search..." class="header-search" id="headerSearchInput">
        </div>
        <div class="header-right">
            <button class="icon-btn" id="toggleLeftBtn" title="Toggle tags panel (Left Bracket [)">
                <span>‚óÇ</span> <!-- PanelLeftClose equivalent -->
            </button>
            <button class="icon-btn" id="toggleRightBtn" title="Toggle info panel (Right Bracket ])">
                <span>‚ñ∏</span> <!-- PanelRightClose equivalent -->
            </button>
            <button class="icon-btn" id="headerFocusBtn" title="Focus mode (F)">
                <span>‚õ∂</span> <!-- Maximize2 equivalent -->
            </button>
        </div>
    </header>

    <div class="image-viewer-container">
        <!-- Left Sidebar: Tags -->
        <aside class="sidebar-panel sidebar-left" id="sidebarLeft">
            <div class="sidebar-content" id="tags-content">
                <div class="tag-section-header">
                    <span class="tag-section-title">üè∑Ô∏è Tags</span>
                    <button class="btn-text-only" onclick="toggleTagEditor()" style="font-size: 11px;">Edit</button>
                </div>

                <!-- Hidden container for original tags list structure used by tag-editor.js to copy from -->
                <div class="tags-list" style="display: none;">
                    <!-- This structure mimics what tag-editor.js expects to crawl -->
                    <!-- We need to ensure the standard classes exist even if hidden or different layout -->
                </div>
                <!-- Actually tag-editor.js crawls .tag-category classes. The new layout uses .tag-category-group.
                     We need to add the class 'tag-category' and the specific category class to the groups -->

                <div id="tags-panel-content">
                    {# Simplified Tag Loop Logic preserved #}
                    {% if categorized_tags %}
                    {% for cat in ['artist', 'copyright', 'character', 'species'] %}
                    {% if categorized_tags[cat] %}
                    <div class="tag-category-group tag-category {{ cat }}">
                        <div class="tag-category-name cat-{{ cat }}">{{ cat }}</div>
                        {% for tag, count in categorized_tags[cat] %}
                        <div class="tag-item"> <!-- Wrapper for editor to find -->
                            <a href="{{ url_for('main.home', query=cat + ':' + tag) }}" class="tag-row">
                                <span class="tag-name">{{ tag }}</span>
                                <span class="tag-count">{{ count }}</span>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endfor %}

                    {% if extended_grouped_tags %}

                    {# --- Group 1: Identity --- #}
                    {% set group1_cats = [
                    ('00_Subject_Count', 'Subject Count'), ('01_Body_Physique', 'Body Physique'),
                    ('02_Body_Hair', 'Body Hair'), ('03_Body_Face', 'Body Face'),
                    ('04_Body_Genitalia', 'Body Genitalia')
                    ] %}

                    {% set has_group1 = false %}
                    {% for cat_key, _ in group1_cats %}
                    {% if cat_key in extended_grouped_tags %}{% set has_group1 = true %}{% endif %}
                    {% endfor %}

                    {% if has_group1 %}
                    <div class="tag-category-group tag-category general">
                        <div class="tag-category-name cat-general"
                            style="border-bottom: 1px solid var(--border-color); padding-bottom:4px; margin-bottom:8px;">
                            Identity</div>
                        {% for cat_key, cat_display_name in group1_cats %}
                        {% if cat_key in extended_grouped_tags %}
                        <div class="extended-sub-category" style="margin-left: 8px; margin-bottom: 8px;">
                            <div class="extended-category-title"
                                style="font-size: 0.8em; color: var(--text-muted); margin-bottom: 2px;">{{
                                cat_display_name }}</div>
                            {% for tag, count in extended_grouped_tags[cat_key] %}
                            <div class="tag-item">
                                <a href="{{ url_for('main.home', query=tag) }}" class="tag-row">
                                    <span class="tag-name">{{ tag }}</span>
                                    <span class="tag-count">{{ count }}</span>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    {# --- Group 2: Context --- #}
                    {% set group2_cats = [
                    ('05_Attire_Main', 'Attire Main'), ('06_Attire_Inner', 'Attire Inner'),
                    ('07_Attire_Legwear', 'Attire Legwear'), ('08_Attire_Acc', 'Attire Accessories'),
                    ('21_Status', 'Status'), ('09_Action', 'Action'), ('10_Pose', 'Pose'),
                    ('11_Expression', 'Expression'), ('12_Sexual_Act', 'Sexual Act'),
                    ('13_Object', 'Object'), ('14_Setting', 'Setting')
                    ] %}

                    {% set has_group2 = false %}
                    {% for cat_key, _ in group2_cats %}
                    {% if cat_key in extended_grouped_tags %}{% set has_group2 = true %}{% endif %}
                    {% endfor %}

                    {% if has_group2 %}
                    <div class="tag-category-group tag-category general">
                        <div class="tag-category-name cat-general"
                            style="border-bottom: 1px solid var(--border-color); padding-bottom:4px; margin-bottom:8px;">
                            Context</div>
                        {% for cat_key, cat_display_name in group2_cats %}
                        {% if cat_key in extended_grouped_tags %}
                        <div class="extended-sub-category" style="margin-left: 8px; margin-bottom: 8px;">
                            <div class="extended-category-title"
                                style="font-size: 0.8em; color: var(--text-muted); margin-bottom: 2px;">{{
                                cat_display_name }}</div>
                            {% for tag, count in extended_grouped_tags[cat_key] %}
                            <div class="tag-item">
                                <a href="{{ url_for('main.home', query=tag) }}" class="tag-row">
                                    <span class="tag-name">{{ tag }}</span>
                                    <span class="tag-count">{{ count }}</span>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    {# --- Group 3: Technical/Meta --- #}
                    {% set group3_cats = [
                    ('15_Framing', 'Framing'), ('16_Focus', 'Focus'), ('17_Style_Art', 'Style Art'),
                    ('18_Style_Tech', 'Style Tech'), ('19_Meta_Attributes', 'Meta Attributes'),
                    ('20_Meta_Text', 'Meta Text')
                    ] %}

                    {% set has_group3 = false %}
                    {% for cat_key, _ in group3_cats %}
                    {% if cat_key in extended_grouped_tags %}{% set has_group3 = true %}{% endif %}
                    {% endfor %}

                    {% if has_group3 %}
                    <div class="tag-category-group tag-category general">
                        <div class="tag-category-name cat-general"
                            style="border-bottom: 1px solid var(--border-color); padding-bottom:4px; margin-bottom:8px;">
                            Technical / Meta</div>
                        {% for cat_key, cat_display_name in group3_cats %}
                        {% if cat_key in extended_grouped_tags %}
                        <div class="extended-sub-category" style="margin-left: 8px; margin-bottom: 8px;">
                            <div class="extended-category-title"
                                style="font-size: 0.8em; color: var(--text-muted); margin-bottom: 2px;">{{
                                cat_display_name }}</div>
                            {% for tag, count in extended_grouped_tags[cat_key] %}
                            <div class="tag-item">
                                <a href="{{ url_for('main.home', query=tag) }}" class="tag-row">
                                    <span class="tag-name">{{ tag }}</span>
                                    <span class="tag-count">{{ count }}</span>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    {# --- Catch-all --- #}
                    {% if None in extended_grouped_tags %}
                    <div class="tag-category-group tag-category general">
                        <div class="tag-category-name cat-general">Other</div>
                        {% for tag, count in extended_grouped_tags[None] %}
                        <div class="tag-item">
                            <a href="{{ url_for('main.home', query=tag) }}" class="tag-row">
                                <span class="tag-name">{{ tag }}</span>
                                <span class="tag-count">{{ count }}</span>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% elif tags %}
                    <div class="tag-category-group">
                        <div class="tag-category-name cat-general">General</div>
                        {% for tag, count in tags %}
                        <a href="{{ url_for('main.home', query=tag) }}" class="tag-row">
                            <span class="tag-name">{{ tag }}</span>
                            <span class="tag-count">{{ count }}</span>
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if categorized_tags.meta %}
                    <div class="tag-category-group">
                        <div class="tag-category-name cat-meta">Meta</div>
                        {% for tag, count in categorized_tags.meta %}
                        <a href="{{ url_for('main.home', query='meta:' + tag) }}" class="tag-row">
                            <span class="tag-name">{{ tag }}</span>
                            <span class="tag-count">{{ count }}</span>
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endif %}
                </div>

                <div id="pools-content">
                    <div class="tag-section-header" style="margin-top: 20px;">
                        <span class="tag-section-title">üìÅ Pools</span>
                    </div>
                    <div id="poolsList" class="pools-list-container">
                        <div class="loading-spinner">Loading pools...</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content: Image + Floating Bar -->
        <main class="main-image-area">
            <div class="image-canvas">
                <div class="media-container" id="imageViewContainer" data-filepath="{{ filepath }}" {% if
                    filepath.endswith('.zip') %}data-animation-type="zip"
                    data-md5="{{ metadata.md5 if metadata else '' }}" data-fps="10" {% endif %}>

                    {% if filepath.endswith('.mp4') %}
                    <video controls loop preload="metadata"
                        onloadeddata="this.closest('.media-container').style.opacity='1'">
                        <source
                            src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                            type="video/mp4">
                    </video>
                    {% elif filepath.endswith('.webm') %}
                    <video controls loop preload="metadata"
                        onloadeddata="this.closest('.media-container').style.opacity='1'">
                        <source
                            src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                            type="video/webm">
                    </video>
                    {% elif filepath.endswith('.zip') %}
                    <img src="/static/{{ thumbnail_path | urlencode_path }}" alt="Animation" class="animation-poster">
                    <span class="animation-badge">ZIP Animation</span>
                    {% else %}
                    <img src="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                        alt="Image">
                    {% endif %}
                </div>
            </div>

            <!-- Floating Action Bar -->
            <div class="floating-bar-container">
                <div class="floating-bar">
                    <button class="action-btn" id="prevBtn" title="Previous (‚Üê)">‚óÄ</button>
                    <div class="bar-divider"></div>
                    <button class="action-btn" id="floatingFavBtn" title="Favourite">ü§ç</button>
                    <button class="action-btn" id="floatingEditTagsBtn" title="Edit Tags">üìù</button>
                    <button class="action-btn" id="floatingAddPoolBtn" title="Add to Pool">üìÅ</button>
                    <button class="action-btn" id="zoomBtn" title="Zoom (Z)">‚äï</button>
                    <button class="action-btn primary" id="focusBtn" title="Focus mode (F)">‚õ∂</button>

                    <a href="{{ url_for('main.similar', filepath=filepath) }}" class="action-btn"
                        title="Find similar">üîç</a>
                    <a href="{{ url_for('main.similar_visual', filepath=filepath) }}" class="action-btn"
                        title="Visual similar">üëÅÔ∏è</a>
                    <a href="/static/{% if not filepath.startswith('images/') %}images/{% endif %}{{ filepath | urlencode_path }}"
                        download class="action-btn success" title="Download">üíæ</a>
                    <button class="action-btn danger" id="floatingDeleteBtn" title="Delete">üóëÔ∏è</button>
                    <div class="bar-divider"></div>
                    <button class="action-btn" id="nextBtn" title="Next (‚Üí)">‚ñ∂</button>
                </div>
            </div>

            <!-- Focus Mode Hints -->
            <button class="focus-exit-btn" id="focusExitBtn" title="Exit focus mode (ESC)">‚úï</button>
            <div class="focus-hint">ESC to exit ‚Ä¢ scroll to zoom ‚Ä¢ drag to pan</div>
        </main>

        <!-- Right Sidebar: Info + Related -->
        <aside class="sidebar-panel sidebar-right" id="sidebarRight">
            <div class="sidebar-content" id="sidebar-right-content">
                <div class="tag-section-header">
                    <span class="tag-section-title">‚ÑπÔ∏è Info</span>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-text-only" onclick="showSauceNaoFetcher()" style="font-size: 11px;">Check
                            Source</button>
                    </div>
                </div>

                <div class="metadata-info-actions" style="margin-bottom: 12px; display: grid; gap: 6px;">
                    <a href="{{ url_for('main.show_raw_data', filepath=filepath) }}" class="btn btn-secondary btn-sm"
                        style="text-align:center; padding: 4px;">View Raw Data</a>
                </div>

                {% if metadata %}
                <div class="metadata-info" style="font-size: 0.85em; color: var(--text-secondary);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span>Resolution</span>
                        <span style="color:white;">
                            {% if metadata.sources %}
                            {% set first = metadata.sources.values()|list|first %}
                            {{ first.get('image_width', '?') }} √ó {{ first.get('image_height', '?') }}
                            {% endif %}
                        </span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span>Size</span>
                        <span style="color:white;">{{ (metadata.sources.values()|list|first).get('file_size') |
                            filesizeformat
                            if metadata.sources and (metadata.sources.values()|list|first).get('file_size') else 'N/A'
                            }}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span>Rating</span>
                        <span style="color:white;">{{ (metadata.sources.values()|list|first).get('rating', '?') | upper
                            if
                            metadata.sources else '?' }}</span>
                    </div>

                    {% if metadata.sources %}
                    {% set first_source = metadata.sources.values()|list|first %}
                    {% if first_source.tagger_name %}
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span>Tagger</span>
                        <span style="color: var(--primary-blue);">{{ first_source.tagger_name }}</span>
                    </div>
                    {% endif %}
                    {% endif %}
                    {% if metadata.md5 %}
                    <div
                        style="margin-top:8px; word-break:break-all; font-family:monospace; font-size:10px; color:#666;">
                        {{ metadata.md5 }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <div class="tag-section-header" style="margin-top: 20px;">
                    <span class="tag-section-title">üñºÔ∏è Similar</span>
                </div>

                {% if related_images %}
                <div class="related-grid-compact">
                    {% for related in related_images %}
                    <a href="/view/{{ related.path | urlencode_path }}" class="related-item">
                        <img src="/static/{% if not (related.thumb.startswith('thumbnails/') or related.thumb.startswith('images/')) %}images/{% endif %}{{ related.thumb | urlencode_path }}"
                            alt="Related" loading="lazy">
                        <span class="related-index">#{{ loop.index }}</span>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </aside>
    </div>

    <!-- Hidden Data Inputs for JS interactivity -->
    <input type="hidden" id="imageFilepath" value="{{ filepath }}">
    <input type="hidden" id="allTags" value="{{ data.all_tags or '' }}">
    {% if family_images %}
    <script type="application/json" id="familyImagesData">{{ family_images | tojson }}</script>
    {% endif %}
    {% if metadata and metadata.sources and metadata.sources|length > 1 %}
    <script type="application/json" id="currentSource">{{ data.active_source or '' }}</script>
    <script type="application/json" id="sourceData">{{ metadata.sources|tojson }}</script>
    {% endif %}

    <!-- Modals (Source, Pool, Retry Tagging) - Preserved -->
    {% if metadata.sources and metadata.sources|length > 1 %}
    <div id="sourceModal" class="source-modal">
        <!-- Copied source modal structure -->
        <div class="source-modal-content">
            <div class="source-modal-header">
                <h2>üîÑ Switch Metadata Source</h2>
                <button class="source-modal-close" onclick="closeSourceModal()">&times; Close</button>
            </div>
            <!-- ... Source list items ... -->
            <!-- Simplified for brevity, assume JS handles population or it's static -->
            {# Full logic is needed here for functionality #}
            <div class="source-options">
                {% set active = data.active_source or (metadata.sources.keys()|list|first) %}
                <div class="source-option special-option {% if active == 'merged' %}active{% endif %}"
                    onclick="switchSource('merged')">
                    <div class="source-option-header"><span class="source-name">Merge All Sources</span></div>
                </div>
                {% for source_name, source_data in metadata.sources.items() %}
                <div class="source-option {% if source_name == active %}active{% endif %}"
                    onclick="switchSource('{{ source_name }}')">
                    <div class="source-option-header"><span class="source-name">{{ source_name }}</span></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <template id="pool-modal-template">
        <div class="modal-content">
            <span class="close" onclick="closeAddToPoolModal()">&times;</span>
            <h3>Add to Pool</h3>
            <div class="form-group">
                <input type="text" id="poolSearchModal" placeholder="Search pools..."
                    style="width: 100%; padding: 10px; margin-bottom: 15px;">
            </div>
            <div id="poolSelectorList" class="pool-selector-list">
                <div class="loading-spinner">Loading pools...</div>
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn-secondary" onclick="closeAddToPoolModal()">Close</button>
            </div>
        </div>
    </template>

    <template id="single-image-retry-tagging-template">
        <div class="custom-confirm-overlay">
            <div class="custom-confirm-modal" style="max-width: 500px;">
                <h3 style="margin: 0 0 15px 0; color: #87ceeb;">üîÑ Retry Tagging Options</h3>
                <div class="retry-options">
                    <button class="retry-option-btn online-only" data-option="online-only">
                        <div class="retry-option-title">üåê Online Sources Only</div>
                    </button>
                    <button class="retry-option-btn with-fallback" data-option="with-fallback">
                        <div class="retry-option-title">ü§ñ With Local AI Fallback</div>
                    </button>
                </div>
                <div class="button-group">
                    <button class="btn-cancel">Cancel</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/modal.js', v='1.3') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/autocomplete.js', v='1.g') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/tag-editor.js', v='1.7') }}"></script>
    <script src="{{ url_for('static', filename='js/image-viewer.js', v='2.1') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/saucenao-fetch.js', v='2.0') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js', v='1.3') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/system-panel.js', v='2.0') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/source-selector.js', v='1.3') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/image-page.js', v='3.0') }}"></script>
    <script src="{{ url_for('static', filename='js/carousel.js', v='1.3') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pool-manager.js', v='2.0') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/global-uploader.js') }}"></script>
    <script src="{{ url_for('static', filename='js/image-preloader.js') }}"></script>
    <script src="{{ url_for('static', filename='js/animation-player.js', v='1.0') }}"></script>
    <script src="{{ url_for('static', filename='js/family-badge.js', v='1.0') }}"></script>
    <script src="{{ url_for('static', filename='js/favourites.js', v='1.0') }}"></script>

    <!-- Init script for new features -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Sidebar Toggles
            const leftPanel = document.getElementById('sidebarLeft');
            const rightPanel = document.getElementById('sidebarRight');
            const toggleLeft = document.getElementById('toggleLeftBtn');
            const toggleRight = document.getElementById('toggleRightBtn');

            function togglePanel(panel, btn) {
                panel.classList.toggle('collapsed');
                btn.classList.toggle('active', !panel.classList.contains('collapsed'));
                // Save preference
                const side = panel.id === 'sidebarLeft' ? 'left' : 'right';
                localStorage.setItem(`sidebar-${side}-open`, !panel.classList.contains('collapsed'));
            }

            // Restore state
            if (localStorage.getItem('sidebar-left-open') === 'false') leftPanel.classList.add('collapsed');
            else toggleLeft.classList.add('active'); // Default open

            if (localStorage.getItem('sidebar-right-open') === 'false') rightPanel.classList.add('collapsed');
            else toggleRight.classList.add('active'); // Default open

            toggleLeft.addEventListener('click', () => togglePanel(leftPanel, toggleLeft));
            toggleRight.addEventListener('click', () => togglePanel(rightPanel, toggleRight));

            // Focus Mode
            const focusBtn = document.getElementById('focusBtn');
            const headerFocusBtn = document.getElementById('headerFocusBtn');
            const focusExitBtn = document.getElementById('focusExitBtn');

            function toggleFocusMode() {
                document.body.classList.toggle('focus-mode');
            }

            focusBtn.addEventListener('click', toggleFocusMode);
            headerFocusBtn.addEventListener('click', toggleFocusMode);
            focusExitBtn.addEventListener('click', () => document.body.classList.remove('focus-mode'));

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                if (e.key === 'f' || e.key === 'F') {
                    toggleFocusMode();
                }
                if (e.key === 'Escape' && document.body.classList.contains('focus-mode')) {
                    document.body.classList.remove('focus-mode');
                }
                if (e.key === '[') togglePanel(leftPanel, toggleLeft);
                if (e.key === ']') togglePanel(rightPanel, toggleRight);
            });

            // Floating Bar Logic (e.g. Delete, Fav, Layout actions logic is handled by individual scripts usually)
            // But we need to bind the new buttons to existing functions

            // Example: Bind floating Delete button to existing logic if it exists
            const deleteBtn = document.getElementById('floatingDeleteBtn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    // Assuming global function or event exists, otherwise simple confirm
                    if (confirm('Are you sure you want to delete this image?')) {
                        // call API
                        fetch('/api/image/delete', { method: 'POST', body: JSON.stringify({ path: "{{ filepath }}" }) })
                            .then(() => window.location.href = '/');
                    }
                });
            }

            // Init other buttons...
            document.getElementById('floatingEditTagsBtn').addEventListener('click', toggleTagEditor);
            document.getElementById('floatingAddPoolBtn').addEventListener('click', showAddToPoolModal);
        });
    </script>
</body>

</html>