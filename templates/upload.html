<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload Image - {{ app_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css')?v=2 }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css')?v=2 }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css')?v=2 }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css')?v=2 }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/upload.css') }}">
</head>
<body>
    {% include 'header.html' %}
    <div class="container">
        <div class="upload-container panel">
            <h2>Upload Image</h2>
            <form id="upload-form" action="{{ url_for('main.upload_image') }}" method="post" enctype="multipart/form-data">
                <div id="drop-zone">
                    <p>Drag & Drop files here or click to select</p>
                    <p class="text-muted-small">(Images will be processed automatically after upload)</p>
                </div>
                <input type="file" id="file-input" name="file" multiple>
            </form>
            <div id="upload-status"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const uploadForm = document.getElementById('upload-form');
            const uploadStatus = document.getElementById('upload-status');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length) {
                    fileInput.files = files;
                    handleFiles(files);
                }
            });

            fileInput.addEventListener('change', () => {
                handleFiles(fileInput.files);
            });

            function handleFiles(files) {
                if (!files.length) return;
                
                uploadStatus.innerHTML = `Uploading ${files.length} file(s)...`;
                const formData = new FormData();
                for (const file of files) {
                    formData.append('file', file);
                }

                fetch("{{ url_for('main.upload_image') }}", {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        uploadStatus.innerHTML = `<span class="text-success">${data.message}</span>`;
                        // If the server sent a redirect URL, go there after a delay
                        if (data.redirect_url) {
                            setTimeout(() => { window.location.href = data.redirect_url; }, 1500);
                        }
                    } else {
                        uploadStatus.innerHTML = `<span class="text-danger">Error: ${data.error}</span>`;
                    }
                })
                .catch(err => {
                    uploadStatus.innerHTML = `<span class="text-danger">Upload failed. See console for details.</span>`;
                    console.error('Upload error:', err);
                });
            }
        });
    </script>
</body>
</html>