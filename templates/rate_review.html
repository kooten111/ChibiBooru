<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rate Images - {{ app_name }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rating.css') + '?v=2' }}">
</head>
<body>
    <div class="rate-container">
        <a href="{{ url_for('main.home') }}" class="back-link">‚Üê Back to Home</a>

        <div class="rate-review-header">
            <div class="rate-review-title">Rate Images</div>
            <div class="rate-progress" id="rateProgress">Loading...</div>
        </div>

        <div class="rate-filters">
            <label>
                <input type="radio" name="filter" value="unrated" checked id="filterUnrated">
                Only Unrated
            </label>
            <label>
                <input type="radio" name="filter" value="ai_predicted" id="filterAI">
                Only AI-Predicted
            </label>
            <label>
                <input type="radio" name="filter" value="all" id="filterAll">
                All Images
            </label>
        </div>

        <div class="image-display" id="imageDisplay">
            <div class="loading-state" id="loadingState">
                Loading images...
            </div>
        </div>

        <div class="keyboard-hints">
            <strong>Keyboard Shortcuts:</strong>
            <kbd>1</kbd> General &nbsp;
            <kbd>2</kbd> Sensitive &nbsp;
            <kbd>3</kbd> Questionable &nbsp;
            <kbd>4</kbd> Explicit &nbsp;
            <kbd>‚Üí</kbd> or <kbd>N</kbd> Next &nbsp;
            <kbd>‚Üê</kbd> or <kbd>P</kbd> Previous &nbsp;
            <kbd>S</kbd> Skip
        </div>
    </div>

    <script>
        let currentImages = [];
        let currentIndex = 0;
        let currentFilter = 'unrated';

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger if user is typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch(e.key) {
                case '1':
                    setRating('rating:general');
                    break;
                case '2':
                    setRating('rating:sensitive');
                    break;
                case '3':
                    setRating('rating:questionable');
                    break;
                case '4':
                    setRating('rating:explicit');
                    break;
                case 'n':
                case 'N':
                case 'ArrowRight':
                    nextImage();
                    break;
                case 'p':
                case 'P':
                case 'ArrowLeft':
                    previousImage();
                    break;
                case 's':
                case 'S':
                    skipImage();
                    break;
            }
        });

        // Filter change handlers
        document.querySelectorAll('input[name="filter"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentFilter = e.target.value;
                currentIndex = 0;
                loadImages();
            });
        });

        async function loadImages() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('imageDisplay').innerHTML = '<div class="loading-state">Loading images...</div>';

            try {
                const response = await fetch('/api/rate/images?filter=' + currentFilter);
                const data = await response.json();

                currentImages = data.images || [];
                currentIndex = 0;

                if (currentImages.length === 0) {
                    document.getElementById('imageDisplay').innerHTML =
                        '<div class="no-images-state">No images to rate! üéâ</div>';
                } else {
                    displayCurrentImage();
                }
            } catch (error) {
                console.error('Error loading images:', error);
                document.getElementById('imageDisplay').innerHTML =
                    '<div class="no-images-state">Error loading images: ' + error.message + '</div>';
            }
        }

        function displayCurrentImage() {
            if (currentImages.length === 0) {
                document.getElementById('imageDisplay').innerHTML =
                    '<div class="no-images-state">No images to rate! üéâ</div>';
                return;
            }

            const image = currentImages[currentIndex];
            const progress = `Image ${currentIndex + 1} / ${currentImages.length}`;
            document.getElementById('rateProgress').textContent = progress;

            const filepath = image.filepath || image.path; // Support both old and new API
            const isVideo = filepath.endsWith('.mp4') || filepath.endsWith('.webm');
            const videoType = filepath.endsWith('.webm') ? 'video/webm' : 'video/mp4';
            const mediaTag = isVideo
                ? `<video controls autoplay loop><source src="/static/images/${filepath}" type="${videoType}"></video>`
                : `<img src="/static/images/${filepath}" alt="Image to rate">`;

            let aiSuggestion = '';
            if (image.ai_rating && image.ai_confidence) {
                const ratingName = image.ai_rating.split(':')[1];
                const confidence = Math.round(image.ai_confidence * 100);
                aiSuggestion = `
                    <div class="ai-suggestion">
                        <strong>AI Suggestion:</strong> ${ratingName} (${confidence}% confidence)
                    </div>
                `;
            }

            const tags = (image.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('');

            document.getElementById('imageDisplay').innerHTML = `
                ${mediaTag}
                <div class="image-info">
                    ${aiSuggestion}
                    <div class="image-tags">
                        ${tags}
                    </div>
                    <div class="rating-buttons">
                        <button class="rating-btn rating-btn-general" onclick="setRating('rating:general')">
                            General<br><small>(1)</small>
                        </button>
                        <button class="rating-btn rating-btn-sensitive" onclick="setRating('rating:sensitive')">
                            Sensitive<br><small>(2)</small>
                        </button>
                        <button class="rating-btn rating-btn-questionable" onclick="setRating('rating:questionable')">
                            Questionable<br><small>(3)</small>
                        </button>
                        <button class="rating-btn rating-btn-explicit" onclick="setRating('rating:explicit')">
                            Explicit<br><small>(4)</small>
                        </button>
                    </div>
                    <div class="navigation-buttons">
                        <button class="nav-btn" onclick="previousImage()" ${currentIndex === 0 ? 'disabled' : ''}>
                            ‚Üê Previous (P)
                        </button>
                        <button class="nav-btn" onclick="skipImage()">
                            Skip (S)
                        </button>
                        <button class="nav-btn nav-btn-primary" onclick="nextImage()" ${currentIndex >= currentImages.length - 1 ? 'disabled' : ''}>
                            Next (N / ‚Üí)
                        </button>
                    </div>
                </div>
            `;
        }

        async function setRating(rating) {
            const image = currentImages[currentIndex];

            try {
                const response = await fetch('/api/rate/set', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_id: image.id,
                        rating: rating
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Move to next image
                    nextImage();
                } else {
                    showNotification('Error setting rating: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error setting rating:', error);
                showNotification('Error setting rating: ' + error.message, 'error');
            }
        }

        function nextImage() {
            if (currentIndex < currentImages.length - 1) {
                currentIndex++;
                displayCurrentImage();
            } else {
                // Reload images to get new ones
                loadImages();
            }
        }

        function previousImage() {
            if (currentIndex > 0) {
                currentIndex--;
                displayCurrentImage();
            }
        }

        function skipImage() {
            nextImage();
        }

        // Load images on page load
        loadImages();
    </script>
    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script type="module">
        import { showNotification } from "{{ url_for('static', filename='js/utils/notifications.js') }}";
        window.showNotification = showNotification;
    </script>
    </div>
</body>
</html>
