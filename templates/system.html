<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>System Settings - {{ app_name }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components-bundle.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/page-layout.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/system.css') + '?v=2' }}">
</head>

<body>
    <div id="global-drop-zone" class="global-drop-zone">
        <div class="drop-zone-content">
            <div class="drop-zone-icon">üì§</div>
            <div class="drop-zone-text">Drop images to upload</div>
        </div>
    </div>

    {% include 'header.html' %}

    <div class="page-container page-container-full">
        <!-- System Header with Navigation and Status Pills -->
        <header class="system-header">
            <div class="system-header-left">
                <h1 class="system-title">System</h1>
                <nav class="system-nav">
                    <button class="system-nav-btn active" data-section="overview">
                        <span class="nav-icon">üìä</span>
                        Overview
                    </button>
                    <button class="system-nav-btn" data-section="settings">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        Settings
                    </button>
                </nav>
            </div>
            <div class="system-status-bar" id="systemStatusBar">
                <!-- Status pills populated by JavaScript -->
                <div class="status-pill">
                    <span class="status-label">Monitor</span>
                    <span class="status-value">-</span>
                </div>
                <div class="status-pill">
                    <span class="status-label">Images</span>
                    <span class="status-value">-</span>
                </div>
                <div class="status-pill">
                    <span class="status-label">Unprocessed</span>
                    <span class="status-value">-</span>
                </div>
                <div class="status-pill">
                    <span class="status-label">Tagged</span>
                    <span class="status-value">-</span>
                </div>
                <!-- Secret status/button -->
                <div id="secretSection" class="secret-header-section"></div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="system-main">


            <!-- Overview Section (default) -->
            <div class="system-section active" id="overview-section">
                <div class="overview-grid">
                    <!-- Left Column: Action Cards -->
                    <div class="overview-left-column">
                        <!-- Quick Actions Card -->
                        <section class="system-card">
                            <h2 class="card-title">Quick Actions</h2>
                            <div class="quick-actions-grid">
                                <button class="quick-action quick-action-blue" onclick="systemScanImages(event)">
                                    <span class="quick-action-icon">üîç</span>
                                    <span>Scan Images</span>
                                </button>
                                <button class="quick-action quick-action-green" onclick="systemReloadData(event)">
                                    <span class="quick-action-icon">‚Üª</span>
                                    <span>Reload Data</span>
                                </button>
                                <button class="quick-action quick-action-purple"
                                    onclick="systemGenerateThumbnails(event)">
                                    <span class="quick-action-icon">üñºÔ∏è</span>
                                    <span>Gen Thumbnails</span>
                                </button>
                            </div>
                        </section>

                        <!-- Monitor Card -->
                        <section class="system-card">
                            <div class="card-header">
                                <h2 class="card-title">Monitor</h2>
                                <button id="monitorToggleBtn" class="monitor-btn monitor-btn-start">‚ñ∂ Start</button>
                            </div>
                            <div class="monitor-stats" id="monitorStats">
                                <div class="monitor-stat">
                                    <span class="monitor-label">Interval</span>
                                    <span class="monitor-value">-</span>
                                </div>
                                <div class="monitor-stat">
                                    <span class="monitor-label">Last Check</span>
                                    <span class="monitor-value">-</span>
                                </div>
                                <div class="monitor-stat">
                                    <span class="monitor-label">Processed</span>
                                    <span class="monitor-value">-</span>
                                </div>
                            </div>
                        </section>

                        <!-- Collection Stats Card -->
                        <section class="system-card">
                            <h2 class="card-title">Collection</h2>
                            <div class="collection-grid" id="collectionStats">
                                <div class="collection-stat">
                                    <span class="collection-value">-</span>
                                    <span class="collection-label">Total</span>
                                </div>
                                <div class="collection-stat">
                                    <span class="collection-value">-</span>
                                    <span class="collection-label">Tagged</span>
                                </div>
                                <div class="collection-stat">
                                    <span class="collection-value">-</span>
                                    <span class="collection-label">Rated</span>
                                </div>
                                <div class="collection-stat collection-warning">
                                    <span class="collection-value">-</span>
                                    <span class="collection-label">Pending</span>
                                </div>
                            </div>
                        </section>

                        <!-- Maintenance Actions -->
                        <section class="system-card actions-card">
                            <h2 class="card-title">üõ†Ô∏è Maintenance</h2>
                            <div class="actions-list">
                                <button class="action-btn" onclick="systemReindexDatabase(event)">
                                    <span class="action-icon">‚ö°</span>
                                    <div class="action-text">
                                        <span class="action-label">Optimize DB</span>
                                        <span class="action-desc">VACUUM & REINDEX</span>
                                    </div>
                                </button>
                                <button class="action-btn" onclick="systemDatabaseHealthCheck(event)">
                                    <span class="action-icon">üè•</span>
                                    <div class="action-text">
                                        <span class="action-label">Health Check</span>
                                        <span class="action-desc">Find inconsistencies</span>
                                    </div>
                                </button>
                                <button class="action-btn" onclick="systemCleanOrphans(event)">
                                    <span class="action-icon">üßπ</span>
                                    <div class="action-text">
                                        <span class="action-label">Clean Orphans</span>
                                        <span class="action-desc">Remove dead entries</span>
                                    </div>
                                </button>
                                <button class="action-btn" onclick="systemDeduplicate(event)">
                                    <span class="action-icon">üîÑ</span>
                                    <div class="action-text">
                                        <span class="action-label">Deduplicate</span>
                                        <span class="action-desc">Find duplicates</span>
                                    </div>
                                </button>
                                <button class="action-btn" onclick="systemGenerateHashes(event)">
                                    <span class="action-icon">üîë</span>
                                    <div class="action-text">
                                        <span class="action-label">Gen Hashes</span>
                                        <span class="action-desc">Compute perceptual hashes</span>
                                    </div>
                                </button>
                                <button class="action-btn" onclick="systemRecountTags(event)">
                                    <span class="action-icon">üìä</span>
                                    <div class="action-text">
                                        <span class="action-label">Recount Tags</span>
                                        <span class="action-desc">Update tag counts</span>
                                    </div>
                                </button>
                                <button class="action-btn" onclick="systemRecategorizeTags(event)">
                                    <span class="action-icon">üè∑Ô∏è</span>
                                    <div class="action-text">
                                        <span class="action-label">Recategorize Tags</span>
                                        <span class="action-desc">Move to correct categories</span>
                                    </div>
                                </button>
                                <button class="action-btn" onclick="systemRebuildCategorized(event)">
                                    <span class="action-icon">üî®</span>
                                    <div class="action-text">
                                        <span class="action-label">Rebuild Categorized</span>
                                        <span class="action-desc">Refresh cache</span>
                                    </div>
                                </button>
                                <button class="action-btn" onclick="systemApplyMergedSources(event)">
                                    <span class="action-icon">üîó</span>
                                    <div class="action-text">
                                        <span class="action-label">Apply Source Merge</span>
                                        <span class="action-desc">Apply merge setting</span>
                                    </div>
                                </button>
                                <button class="action-btn" onclick="systemFindBrokenImages(event)">
                                    <span class="action-icon">üîç</span>
                                    <div class="action-text">
                                        <span class="action-label">Find Broken Images</span>
                                        <span class="action-desc">Find missing data</span>
                                    </div>
                                </button>
                                <button class="action-btn" onclick="systemUpscaleSmallImages(event)">
                                    <span class="action-icon">üñºÔ∏è</span>
                                    <div class="action-text">
                                        <span class="action-label">Upscale Small Images</span>
                                        <span class="action-desc">Uses settings thresholds</span>
                                    </div>
                                </button>
                                <button class="action-btn" onclick="systemConvertUpscaledFormat(event)">
                                    <span class="action-icon">üîÑ</span>
                                    <div class="action-text">
                                        <span class="action-label">Convert Upscale Format</span>
                                        <span class="action-desc">Convert to configured format</span>
                                    </div>
                                </button>
                            </div>
                        </section>

                        <!-- Dangerous Actions -->
                        <section class="system-card danger-card">
                            <h2 class="card-title danger-title">‚ö†Ô∏è Dangerous</h2>
                            <p class="warning-text">These actions can take a long time and may be irreversible</p>
                            <div class="actions-list">
                                <button class="action-btn danger-btn" onclick="systemRebuildTags(event)">
                                    <span class="action-icon">üî®</span>
                                    <div class="action-text">
                                        <span class="action-label">Rebuild Tags</span>
                                        <span class="action-desc">Recreate from metadata</span>
                                    </div>
                                </button>
                                <button class="action-btn danger-btn" onclick="systemReprocessImages(event)">
                                    <span class="action-icon">üîÑ</span>
                                    <div class="action-text">
                                        <span class="action-label">Reprocess Images</span>
                                        <span class="action-desc">Retag or find sources</span>
                                    </div>
                                </button>
                                <button class="action-btn danger-btn" onclick="systemClearImpliedTags(event)">
                                    <span class="action-icon">üóëÔ∏è</span>
                                    <div class="action-text">
                                        <span class="action-label">Clear Implied</span>
                                        <span class="action-desc">Remove implied tags</span>
                                    </div>
                                </button>
                            </div>
                        </section>
                    </div>

                    <!-- Right Column: Activity Log -->
                    <div class="overview-right-column">
                        <section class="system-card logs-card">
                            <div class="card-header">
                                <h2 class="card-title">Activity Log</h2>
                                <button class="expand-btn" id="logsExpandBtn">‚ñ≤</button>
                            </div>
                            <div class="logs-container-overview" id="systemLogsOverview">
                                <div class="log-entry info">No recent activity</div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="system-section" id="settings-section">
                <div class="settings-container">
                    <div class="settings-header">
                        <input type="text" id="settingsSearch" class="settings-search-input"
                            placeholder="Search settings..." />
                        <div class="settings-actions">
                            <button id="reloadConfigBtn" class="btn-secondary">Reload Config</button>
                            <button id="saveSettingsBtn" class="btn-primary">Save Changes</button>
                        </div>
                    </div>
                    <div id="settingsCategories" class="settings-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>


        </main>
    </div>

    <!-- Hidden elements for backwards compatibility -->
    <div id="systemStatus" style="display: none;"></div>
    <div id="systemLogs" class="system-logs" style="display: none;"></div>

    <!-- Secret Input Templates -->
    <template id="secret-required-template">
        <button class="secret-header-btn secret-required" onclick="showSecretModal()">
            <span class="secret-icon">üîê</span>
            <span class="secret-text">Set Secret</span>
        </button>
    </template>

    <template id="secret-configured-template">
        <button class="secret-header-btn secret-configured" onclick="clearSystemSecret(event)">
            <span class="secret-icon">üîì</span>
            <span class="secret-text">Secret ‚úì</span>
        </button>
    </template>

    <!-- Secret Input Modal -->
    <div id="secretModal" class="modal-overlay" style="display: none;">
        <div class="modal-content secret-modal">
            <h3>Enter System Secret</h3>
            <p>Enter the system secret to access system actions and logs.</p>
            <form onsubmit="event.preventDefault(); saveSystemSecret(); closeSecretModal(); return false;">
                <div class="secret-input-group">
                    <input type="password" id="secretInput" class="filter-input" placeholder="Enter system secret..."
                        autocomplete="off">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeSecretModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <template id="upscale-small-modal-template">
        <div class="custom-confirm-overlay">
            <div class="custom-confirm-modal upscale-modal">
                <h3>Upscale Small Images</h3>
                <p>Set thresholds, preview queue size, then start bulk upscaling.</p>

                <div class="upscale-threshold-row">
                    <label class="upscale-row-header" for="upscaleUseFileSize">
                        <span class="upscale-row-label">File size (KB)</span>
                        <input type="checkbox" id="upscaleUseFileSize">
                    </label>
                    <input type="number" id="upscaleMaxFileSizeKb" class="filter-input" min="1" step="1" placeholder="Max KB">
                </div>

                <div class="upscale-threshold-row">
                    <label class="upscale-row-header" for="upscaleUseMegapixels">
                        <span class="upscale-row-label">Megapixels (MP)</span>
                        <input type="checkbox" id="upscaleUseMegapixels">
                    </label>
                    <input type="number" id="upscaleMaxMegapixels" class="filter-input" min="0.01" step="0.01" placeholder="Max MP">
                </div>

                <div class="upscale-threshold-row">
                    <label class="upscale-row-header" for="upscaleUseDimensions">
                        <span class="upscale-row-label">Dimensions (width OR height)</span>
                        <input type="checkbox" id="upscaleUseDimensions">
                    </label>
                    <div class="upscale-dimension-grid">
                        <input type="number" id="upscaleMaxWidth" class="filter-input" min="1" step="1" placeholder="Max width">
                        <input type="number" id="upscaleMaxHeight" class="filter-input" min="1" step="1" placeholder="Max height">
                    </div>
                </div>

                <div class="upscale-threshold-row">
                    <label class="upscale-row-header" for="upscaleExcludeUpscaled">
                        <span class="upscale-row-label">Exclude already upscaled images</span>
                        <input type="checkbox" id="upscaleExcludeUpscaled">
                    </label>
                </div>

                <div id="upscalePreviewStatus" class="warning-text upscale-preview-status">Run preview to see how many images will be queued.</div>

                <div class="button-group upscale-button-group">
                    <button class="btn-secondary" id="upscalePreviewBtn">Preview Queue</button>
                    <button class="btn-primary" id="upscaleQueueBtn" disabled>Queue Upscales</button>
                    <button class="btn-cancel" id="upscaleCancelBtn">Cancel</button>
                </div>
            </div>
        </div>
    </template>

    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pages/system.js') + '?v=4' }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/global-uploader.js') }}"></script>
</body>

</html>