<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Settings - {{ app_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components-bundle.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/page-layout.css') + '?v=1' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/system.css') + '?v=1' }}">
</head>
<body>
    <div id="global-drop-zone" class="global-drop-zone">
        <div class="drop-zone-content">
            <div class="drop-zone-icon">üì§</div>
            <div class="drop-zone-text">Drop images to upload</div>
        </div>
    </div>

    {% include 'header.html' %}

    <div class="page-container page-container-full">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-left">
                <h1 class="page-title">
                    <span class="page-title-icon">‚öôÔ∏è</span>
                    System Settings
                </h1>
            </div>
        </div>

        <!-- Tabs -->
        <div class="system-tabs-container">
        <div class="system-tabs">
            <button class="system-tab active" data-tab="settings">
                <span class="tab-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </button>
            <button class="system-tab" data-tab="status">
                <span class="tab-icon">üìä</span>
                <span>Status</span>
            </button>
            <button class="system-tab" data-tab="actions">
                <span class="tab-icon">üîß</span>
                <span>Actions</span>
            </button>
            <button class="system-tab" data-tab="logs">
                <span class="tab-icon">üìã</span>
                <span>Logs</span>
            </button>
        </div>
        </div>

        <!-- Tab Content -->
        <div class="system-content">
            <!-- Settings Tab -->
            <div class="system-tab-content active" id="settings-tab">
                <div class="settings-container">
                    <div class="settings-header">
                        <h2>Configuration Settings</h2>
                        <div class="settings-actions">
                            <button id="saveSettingsBtn" class="btn btn-primary">Save All Changes</button>
                            <button id="reloadConfigBtn" class="btn btn-secondary">Reload Config</button>
                        </div>
                    </div>
                    <div class="settings-search">
                        <input type="text" id="settingsSearch" class="filter-input" placeholder="Search settings...">
                    </div>
                    <div id="settingsCategories" class="settings-categories">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Status Tab -->
            <div class="system-tab-content" id="status-tab">
                <div class="status-container">
                    <h2>System Status</h2>
                    <div id="systemStatus" class="system-status-grid">
                        <div class="status-loading">Loading status...</div>
                    </div>
                </div>
            </div>

            <!-- Actions Tab -->
            <div class="system-tab-content" id="actions-tab">
                <div class="actions-container">
                    <h2>System Actions</h2>
                    
                    <div class="secret-section" id="secretSection">
                        <!-- Fallback content - will be replaced by JavaScript -->
                        <div class="secret-input-section">
                            <h3>System Secret Required</h3>
                            <p>Enter the system secret (RELOAD_SECRET from your .env file) to access system actions and logs.</p>
                            <div class="secret-input-group">
                                <input type="password" id="secretInput" class="filter-input" placeholder="Enter system secret..." autocomplete="off">
                                <button class="btn btn-primary" onclick="if(window.saveSystemSecret) window.saveSystemSecret(); else alert('Please wait for page to load');">Save</button>
                            </div>
                        </div>
                    </div>

                    <div class="actions-section" id="systemActionsSection" style="display: none;">
                        <div class="settings-group">
                            <h3>Quick Actions</h3>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Scan & Process New Images</span>
                                    <span class="settings-desc">Find and process new images in the ingest directory.</span>
                                </div>
                                <button class="btn btn-primary" onclick="systemScanImages(event)">Scan</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Reload Data</span>
                                    <span class="settings-desc">Reload data from the database.</span>
                                </div>
                                <button class="btn btn-success" onclick="systemReloadData(event)">Reload</button>
                            </div>
                        </div>

                        <div class="settings-group">
                            <h3>Monitor Control</h3>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Background Monitor</span>
                                    <span class="settings-desc">Automatically scan for new images.</span>
                                </div>
                                <button id="monitorToggleBtn" class="btn btn-success">‚ñ∂Ô∏è Start Monitor</button>
                            </div>
                        </div>

                        <div class="settings-group">
                            <h3>Tag & Metadata Management</h3>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Recount Tags</span>
                                    <span class="settings-desc">Update tag counts based on current usage.</span>
                                </div>
                                <button class="btn btn-primary" onclick="systemRecountTags(event)">Recount</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Recategorize Tags</span>
                                    <span class="settings-desc">Move general tags to correct categories.</span>
                                </div>
                                <button class="btn btn-primary" onclick="systemRecategorizeTags(event)">Recategorize</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Rebuild Categorized Tags</span>
                                    <span class="settings-desc">Refresh the cache of categorized tags.</span>
                                </div>
                                <button class="btn btn-primary" onclick="systemRebuildCategorized(event)">Rebuild</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Apply Source Merge Setting</span>
                                    <span class="settings-desc">Apply the current merge setting to all images.</span>
                                </div>
                                <button class="btn btn-success" onclick="systemApplyMergedSources(event)">Apply</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Retry Local Tagging</span>
                                    <span class="settings-desc">Re-run tagging for images that only have local tags.</span>
                                </div>
                                <button class="btn btn-warning" onclick="systemBulkRetryTagging(event)">Retry</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Rescan All with Local Tagger</span>
                                    <span class="settings-desc">Run the local AI tagger on every image.</span>
                                </div>
                                <button class="btn btn-warning" onclick="systemBulkRetagLocal(event)">Rescan All</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Clear Implied Tags</span>
                                    <span class="settings-desc">Remove all tags added by implications.</span>
                                </div>
                                <button class="btn btn-warning" onclick="systemClearImpliedTags(event)">Clear</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Find Broken Images</span>
                                    <span class="settings-desc">Find and cleanup images with missing tags, hashes, or embeddings.</span>
                                </div>
                                <button class="btn btn-warning" onclick="systemFindBrokenImages(event)">Scan</button>
                            </div>
                        </div>

                        <div class="settings-group">
                            <h3>Database Maintenance</h3>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Optimize Database</span>
                                    <span class="settings-desc">Run VACUUM and REINDEX to reclaim space.</span>
                                </div>
                                <button class="btn btn-info" onclick="systemReindexDatabase(event)">Run</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Database Health Check</span>
                                    <span class="settings-desc">Scan for and fix common database inconsistencies.</span>
                                </div>
                                <button class="btn btn-info" onclick="systemDatabaseHealthCheck(event)">Check</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Generate Thumbnails</span>
                                    <span class="settings-desc">Create missing thumbnails for all images.</span>
                                </div>
                                <button class="btn btn-primary" onclick="systemGenerateThumbnails(event)">Generate</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Generate Image Hashes</span>
                                    <span class="settings-desc">Compute perceptual hashes for visual similarity.</span>
                                </div>
                                <button class="btn btn-primary" onclick="systemGenerateHashes(event)">Generate</button>
                            </div>
                        </div>

                        <div class="settings-group danger-zone">
                            <h3>Advanced / Danger Zone</h3>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Clean Orphan Metadata</span>
                                    <span class="settings-desc">Remove database entries for files that no longer exist.</span>
                                </div>
                                <button class="btn btn-danger" onclick="systemCleanOrphans(event)">Clean</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Deduplicate Images</span>
                                    <span class="settings-desc">Find and remove duplicate images based on hash.</span>
                                </div>
                                <button class="btn btn-danger" onclick="systemDeduplicate(event)">Deduplicate</button>
                            </div>
                            <div class="settings-item">
                                <div class="settings-info">
                                    <span class="settings-label">Rebuild Database</span>
                                    <span class="settings-desc">Wipe the database and rebuild it from file metadata. IRREVERSIBLE.</span>
                                </div>
                                <button class="btn btn-danger" onclick="systemRebuildTags(event)">Rebuild</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div class="system-tab-content" id="logs-tab">
                <div class="logs-container">
                    <h2>Activity Log</h2>
                    <div class="system-logs" id="systemLogs">
                        <div class="log-entry info">No recent activity</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secret Input Templates -->
    <template id="secret-required-template">
        <div class="secret-input-section">
            <h3>System Secret Required</h3>
            <p>Enter the system secret to access system actions and logs.</p>
            <div class="secret-input-group">
                <input type="password" id="secretInput" class="filter-input" placeholder="Enter system secret...">
                <button class="btn btn-primary" onclick="saveSystemSecret()">Save</button>
            </div>
        </div>
    </template>

    <template id="secret-configured-template">
        <div class="secret-configured-section">
            <h3>System Secret Configured</h3>
            <button class="btn btn-secondary" onclick="clearSystemSecret(event)">Change Secret</button>
        </div>
    </template>

    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/system-panel.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pages/system.js') + '?v=1' }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/global-uploader.js') }}"></script>
</body>
</html>
