<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Dashboard - {{ app_name }}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/system-dashboard.css') }}">
</head>

<body class="system-dashboard-page">
    {% include 'header.html' %}

    <div class="dashboard-container">
        <!-- Status Cards Row -->
        <div class="status-cards-row" id="statusCardsRow">
            <div class="status-card">
                <div class="status-card-icon">‚öôÔ∏è</div>
                <div class="status-card-content">
                    <div class="status-card-label">Monitor Status</div>
                    <div class="status-card-value" id="monitorStatusValue">Loading...</div>
                </div>
                <div class="status-indicator" id="monitorIndicator"></div>
            </div>

            <div class="status-card">
                <div class="status-card-icon">üñºÔ∏è</div>
                <div class="status-card-content">
                    <div class="status-card-label">Total Images</div>
                    <div class="status-card-value" id="totalImagesValue">-</div>
                    <div class="status-card-subtext" id="unprocessedSubtext">-</div>
                </div>
            </div>

            <div class="status-card">
                <div class="status-card-icon">üè∑Ô∏è</div>
                <div class="status-card-content">
                    <div class="status-card-label">Total Tags</div>
                    <div class="status-card-value" id="totalTagsValue">-</div>
                    <div class="status-card-subtext" id="uncategorizedSubtext">-</div>
                </div>
            </div>

            <div class="status-card">
                <div class="status-card-icon">üíæ</div>
                <div class="status-card-content">
                    <div class="status-card-label">Storage</div>
                    <div class="status-card-value" id="storageValue">-</div>
                    <div class="status-card-subtext">Images + Thumbnails</div>
                </div>
            </div>

            <div class="status-card">
                <div class="status-card-icon">‚ù§Ô∏è</div>
                <div class="status-card-content">
                    <div class="status-card-label">Health</div>
                    <div class="status-card-value" id="healthValue">-</div>
                    <div class="status-card-subtext" id="healthSubtext">-</div>
                </div>
                <div class="status-indicator" id="healthIndicator"></div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="dashboard-columns">
            <!-- Left Column: Actions -->
            <div class="dashboard-left">
                <!-- Secret Section -->
                <div id="secretSection" class="secret-section"></div>

                <!-- Monitor Control -->
                <div class="action-panel" id="monitorControlPanel">
                    <h3>Monitor Control</h3>
                    <button id="monitorToggleBtn" class="btn btn-primary">
                        Loading...
                    </button>
                    <p class="panel-description">Automatically scans for new images at regular intervals</p>
                </div>

                <!-- Running Tasks -->
                <div class="action-panel" id="runningTasksPanel" style="display: none;">
                    <h3>Running Tasks</h3>
                    <div id="runningTasksList" class="running-tasks-list"></div>
                </div>

                <!-- Quick Actions -->
                <div class="action-panel">
                    <h3>Quick Actions</h3>
                    <div class="action-grid">
                        <div class="action-card safe">
                            <div class="action-card-header">
                                <span class="action-icon">üîç</span>
                                <span class="action-title">Scan & Process</span>
                                <span class="risk-badge safe">Safe</span>
                            </div>
                            <p class="action-description">Find and process new images in the directory</p>
                            <div class="action-meta">
                                <span class="time-estimate">~30-60s</span>
                            </div>
                            <button class="btn btn-primary" onclick="actionScanImages(event)">Run Scan</button>
                        </div>

                        <div class="action-card safe">
                            <div class="action-card-header">
                                <span class="action-icon">‚Üª</span>
                                <span class="action-title">Reload Data</span>
                                <span class="risk-badge safe">Safe</span>
                            </div>
                            <p class="action-description">Refresh tag counts and image cache from database</p>
                            <div class="action-meta">
                                <span class="time-estimate">~5-10s</span>
                            </div>
                            <button class="btn btn-success" onclick="actionReloadData(event)">Reload</button>
                        </div>
                    </div>
                </div>

                <!-- Routine Maintenance -->
                <div class="action-panel collapsible">
                    <h3 class="collapsible-header" onclick="toggleSection('routineMaintenance')">
                        <span class="toggle-icon">‚ñº</span>
                        Routine Maintenance
                    </h3>
                    <div class="collapsible-content" id="routineMaintenance">
                        <div class="action-grid">
                            <div class="action-card safe">
                                <div class="action-card-header">
                                    <span class="action-icon">üñºÔ∏è</span>
                                    <span class="action-title">Generate Thumbnails</span>
                                    <span class="risk-badge safe">Safe</span>
                                </div>
                                <p class="action-description">Create missing thumbnails for all images</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~1-5 min</span>
                                </div>
                                <button class="btn btn-primary" onclick="actionGenerateThumbnails(event)">Generate</button>
                            </div>

                            <div class="action-card safe">
                                <div class="action-card-header">
                                    <span class="action-icon">üî¢</span>
                                    <span class="action-title">Generate Hashes</span>
                                    <span class="risk-badge safe">Safe</span>
                                </div>
                                <p class="action-description">Compute perceptual hashes for similarity detection</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~5-10 min</span>
                                </div>
                                <button class="btn btn-primary" onclick="actionGenerateHashes(event)">Generate</button>
                            </div>

                            <div class="action-card safe">
                                <div class="action-card-header">
                                    <span class="action-icon">‚ö°</span>
                                    <span class="action-title">Optimize Database</span>
                                    <span class="risk-badge safe">Safe</span>
                                </div>
                                <p class="action-description">Run VACUUM and REINDEX to improve performance</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~30s</span>
                                </div>
                                <button class="btn btn-info" onclick="actionOptimizeDatabase(event)">Optimize</button>
                            </div>

                            <div class="action-card safe">
                                <div class="action-card-header">
                                    <span class="action-icon">üè•</span>
                                    <span class="action-title">Health Check</span>
                                    <span class="risk-badge safe">Safe</span>
                                </div>
                                <p class="action-description">Scan for and fix database inconsistencies</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~10-30s</span>
                                </div>
                                <button class="btn btn-info" onclick="actionHealthCheck(event)">Check</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tag Management -->
                <div class="action-panel collapsible">
                    <h3 class="collapsible-header" onclick="toggleSection('tagManagement')">
                        <span class="toggle-icon">‚ñº</span>
                        Tag Management
                    </h3>
                    <div class="collapsible-content" id="tagManagement">
                        <div class="action-grid">
                            <div class="action-card safe">
                                <div class="action-card-header">
                                    <span class="action-icon">üîÑ</span>
                                    <span class="action-title">Rebuild Categorized</span>
                                    <span class="risk-badge safe">Safe</span>
                                </div>
                                <p class="action-description">Refresh categorized tags cache for faster display</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~1-2 min</span>
                                </div>
                                <button class="btn btn-primary" onclick="actionRebuildCategorized(event)">Rebuild</button>
                            </div>

                            <div class="action-card safe">
                                <div class="action-card-header">
                                    <span class="action-icon">üìã</span>
                                    <span class="action-title">Recategorize Tags</span>
                                    <span class="risk-badge safe">Safe</span>
                                </div>
                                <p class="action-description">Move general tags to correct categories</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~30s</span>
                                </div>
                                <button class="btn btn-primary" onclick="actionRecategorizeTags(event)">Recategorize</button>
                            </div>

                            <div class="action-card safe">
                                <div class="action-card-header">
                                    <span class="action-icon">üî¢</span>
                                    <span class="action-title">Recount Tags</span>
                                    <span class="risk-badge safe">Safe</span>
                                </div>
                                <p class="action-description">Update tag counts based on current usage</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~10s</span>
                                </div>
                                <button class="btn btn-primary" onclick="actionRecountTags(event)">Recount</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Tagging -->
                <div class="action-panel collapsible">
                    <h3 class="collapsible-header" onclick="toggleSection('bulkTagging')">
                        <span class="toggle-icon">‚ñº</span>
                        Bulk Tagging
                    </h3>
                    <div class="collapsible-content" id="bulkTagging">
                        <div class="action-grid">
                            <div class="action-card caution">
                                <div class="action-card-header">
                                    <span class="action-icon">üåê</span>
                                    <span class="action-title">Retry Online Tagging</span>
                                    <span class="risk-badge caution">Caution</span>
                                </div>
                                <p class="action-description">Retry locally-tagged images with online sources</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~5-30 min</span>
                                </div>
                                <button class="btn btn-warning" onclick="actionBulkRetryTagging(event)">Retry</button>
                            </div>

                            <div class="action-card caution">
                                <div class="action-card-header">
                                    <span class="action-icon">ü§ñ</span>
                                    <span class="action-title">Rescan with Local AI</span>
                                    <span class="risk-badge caution">Caution</span>
                                </div>
                                <p class="action-description">Re-run local AI tagger on all images (slow)</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~10-60 min</span>
                                </div>
                                <button class="btn btn-warning" onclick="actionBulkRetagLocal(event)">Rescan</button>
                            </div>

                            <div class="action-card safe">
                                <div class="action-card-header">
                                    <span class="action-icon">üîÄ</span>
                                    <span class="action-title">Apply Merged Sources</span>
                                    <span class="risk-badge safe">Safe</span>
                                </div>
                                <p class="action-description">Merge tags from multiple sources (Pixiv + Local)</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~1-5 min</span>
                                </div>
                                <button class="btn btn-success" onclick="actionApplyMergedSources(event)">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced / Danger Zone -->
                <div class="action-panel collapsible danger-zone">
                    <h3 class="collapsible-header" onclick="toggleSection('dangerZone')">
                        <span class="toggle-icon">‚ñº</span>
                        ‚ö†Ô∏è Advanced / Danger Zone
                    </h3>
                    <div class="collapsible-content" id="dangerZone">
                        <div class="action-grid">
                            <div class="action-card danger">
                                <div class="action-card-header">
                                    <span class="action-icon">üóëÔ∏è</span>
                                    <span class="action-title">Clean Orphans</span>
                                    <span class="risk-badge danger">Danger</span>
                                </div>
                                <p class="action-description">Remove database entries for deleted files</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~10-30s</span>
                                </div>
                                <button class="btn btn-danger" onclick="actionCleanOrphans(event)">Clean</button>
                            </div>

                            <div class="action-card danger">
                                <div class="action-card-header">
                                    <span class="action-icon">üîç</span>
                                    <span class="action-title">Deduplicate</span>
                                    <span class="risk-badge danger">Danger</span>
                                </div>
                                <p class="action-description">Find and remove duplicate images by hash</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~1-5 min</span>
                                </div>
                                <button class="btn btn-danger" onclick="actionDeduplicate(event)">Deduplicate</button>
                            </div>

                            <div class="action-card danger">
                                <div class="action-card-header">
                                    <span class="action-icon">üí•</span>
                                    <span class="action-title">Rebuild Database</span>
                                    <span class="risk-badge danger">Danger</span>
                                </div>
                                <p class="action-description">Wipe DB and rebuild from files (IRREVERSIBLE)</p>
                                <div class="action-meta">
                                    <span class="time-estimate">~5-15 min</span>
                                </div>
                                <button class="btn btn-danger" onclick="actionRebuildDatabase(event)">Rebuild</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Info -->
            <div class="dashboard-right">
                <!-- Activity Log -->
                <div class="info-panel">
                    <div class="panel-header">
                        <h3>Activity Log</h3>
                        <div class="log-filters">
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="error">Errors</button>
                            <button class="filter-btn" data-filter="warning">Warnings</button>
                            <button class="filter-btn" data-filter="success">Success</button>
                        </div>
                    </div>
                    <div id="activityLog" class="activity-log">
                        <div class="log-entry info">No recent activity</div>
                    </div>
                </div>

                <!-- System Info -->
                <div class="info-panel">
                    <h3>System Info</h3>
                    <div class="system-info-grid">
                        <div class="info-item">
                            <span class="info-label">Last Scan:</span>
                            <span class="info-value" id="lastScanInfo">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Scan Interval:</span>
                            <span class="info-value" id="scanIntervalInfo">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Total Processed:</span>
                            <span class="info-value" id="totalProcessedInfo">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">DB Size:</span>
                            <span class="info-value" id="dbSizeInfo">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Thumbnails:</span>
                            <span class="info-value" id="thumbDirSizeInfo">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <template id="secret-configured-template">
        <div class="secret-configured">
            <span class="secret-configured-text">‚úì System secret configured</span>
            <button class="btn btn-danger btn-sm" onclick="clearSystemSecret(event)">
                Change Secret
            </button>
        </div>
    </template>

    <template id="secret-required-template">
        <div class="secret-required">
            <h4>System Secret Required</h4>
            <p>Enter the RELOAD_SECRET from your environment variables.</p>
            <div class="secret-input-group">
                <input type="password" id="secretInput" placeholder="Enter system secret..." class="secret-input">
                <button class="btn btn-success" onclick="saveSystemSecret()">
                    Save Secret
                </button>
            </div>
        </div>
    </template>

    <script type="module" src="{{ url_for('static', filename='js/pages/system-dashboard.js') }}"></script>
</body>

</html>
