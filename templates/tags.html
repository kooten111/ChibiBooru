<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ app_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') + '?v=2' }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') + '?v=2' }}">
</head>
<body>
    <div id="global-drop-zone" class="global-drop-zone">
        <div class="drop-zone-content">
            <div class="drop-zone-icon">üì§</div>
            <div class="drop-zone-text">Drop images to upload</div>
        </div>
    </div>

    {% include 'header.html' %}

    <div class="container">
        <div class="tags-browser-header">
            <h2>Tag Browser</h2>
        </div>

        <!-- Collapsible Stats Sections -->
        <div class="tags-stats-sections">
            <!-- Overview Section -->
            <div class="collapsible-section">
                <button class="section-header" data-section="overview">
                    <span class="section-icon">üìä</span>
                    <span class="section-title">Collection Overview</span>
                    <span class="section-arrow">‚ñº</span>
                </button>
                <div class="section-content" id="overview-content">
                    <div class="stats-grid">
                        <a href="{{ url_for('main.home') }}" class="link-unstyled">
                            <div class="stat-card">
                                <div class="stat-card-number">{{ stats.total }}</div>
                                <div class="stat-card-label">Total Images</div>
                            </div>
                        </a>
                        <a href="{{ url_for('main.home', query='metadata:found') }}" class="link-unstyled">
                            <div class="stat-card success">
                                <div class="stat-card-number">{{ stats.with_metadata }}</div>
                                <div class="stat-card-label">With Metadata</div>
                            </div>
                        </a>
                        <a href="{{ url_for('main.home', query='metadata:missing') }}" class="link-unstyled">
                            <div class="stat-card warning">
                                <div class="stat-card-number">{{ stats.without_metadata }}</div>
                                <div class="stat-card-label">Missing Metadata</div>
                            </div>
                        </a>
                        <div class="stat-card">
                            <div class="stat-card-number">{{ stats.total_tags }}</div>
                            <div class="stat-card-label">Unique Tags</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-number">{{ stats.avg_tags_per_image }}</div>
                            <div class="stat-card-label">Avg Tags/Image</div>
                        </div>
                    </div>
                </div>
            </div>

            {% if stats.source_breakdown %}
            <!-- Sources Section -->
            <div class="collapsible-section">
                <button class="section-header" data-section="sources">
                    <span class="section-icon">üåê</span>
                    <span class="section-title">Source Distribution</span>
                    <span class="section-arrow">‚ñº</span>
                </button>
                <div class="section-content" id="sources-content">
                    <div class="stats-grid">
                        {% for source, count in stats.source_breakdown.items() %}
                        <a href="{{ url_for('main.home', query='source:' + source) }}" class="link-unstyled">
                            <div class="stat-card">
                                <div class="stat-card-number">{{ count }}</div>
                                <div class="stat-card-label">{{ source|capitalize }}</div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if stats.top_tags %}
            <!-- Top Tags Section -->
            <div class="collapsible-section">
                <button class="section-header" data-section="top-tags">
                    <span class="section-icon">üèÜ</span>
                    <span class="section-title">Most Popular Tags</span>
                    <span class="section-arrow">‚ñº</span>
                </button>
                <div class="section-content" id="top-tags-content">
                    <div class="top-tags-list">
                        {% for tag, count in stats.top_tags %}
                        <a href="{{ url_for('main.home', query=tag) }}" class="tag-link">
                            <span class="tag-name">{{ tag }}</span>
                            <span class="tag-count">{{ count }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if stats.category_counts %}
            <!-- Categories Section -->
            <div class="collapsible-section">
                <button class="section-header" data-section="categories">
                    <span class="section-icon">üè∑Ô∏è</span>
                    <span class="section-title">Tag Categories</span>
                    <span class="section-arrow">‚ñº</span>
                </button>
                <div class="section-content" id="categories-content">
                    <div class="category-breakdown">
                        {% for category, count in stats.category_counts.items() %}
                        <a href="{{ url_for('main.home', query='category:' + category) }}" class="link-unstyled">
                            <div class="category-card {{ category }}">
                                <div class="category-number">{{ count }}</div>
                                <div class="category-label">{{ category|capitalize }}</div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if random_tags %}
            <!-- Explore Section -->
            <div class="collapsible-section">
                <button class="section-header" data-section="explore">
                    <span class="section-icon">üé≤</span>
                    <span class="section-title">Random Tags</span>
                    <span class="section-arrow">‚ñº</span>
                </button>
                <div class="section-content" id="explore-content">
                    <div class="top-tags-list">
                        {% for tag, count in random_tags %}
                        <a href="{{ url_for('main.home', query=tag) }}" class="tag-link">
                            <span class="tag-name">{{ tag }}</span>
                            <span class="tag-count">{{ count }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Tag Search and Filter -->
        <div class="tags-search-section">
            <input type="text" id="tagSearchInput" placeholder="Search for tags...">
        </div>

        <div class="category-filter-bar">
            {% set category_counts = {} %}
            {% for tag in all_tags %}
                {% if category_counts.update({tag.category: category_counts.get(tag.category, 0) + 1}) %}{% endif %}
            {% endfor %}

            <button class="category-filter-btn active" data-category="all">
                All <span class="category-count">({{ all_tags|length }})</span>
            </button>
            <button class="category-filter-btn character" data-category="character">
                Character <span class="category-count">({{ category_counts.get('character', 0) }})</span>
            </button>
            <button class="category-filter-btn copyright" data-category="copyright">
                Copyright <span class="category-count">({{ category_counts.get('copyright', 0) }})</span>
            </button>
            <button class="category-filter-btn artist" data-category="artist">
                Artist <span class="category-count">({{ category_counts.get('artist', 0) }})</span>
            </button>
            <button class="category-filter-btn species" data-category="species">
                Species <span class="category-count">({{ category_counts.get('species', 0) }})</span>
            </button>
            <button class="category-filter-btn meta" data-category="meta">
                Meta <span class="category-count">({{ category_counts.get('meta', 0) }})</span>
            </button>
            <button class="category-filter-btn general" data-category="general">
                General <span class="category-count">({{ category_counts.get('general', 0) }})</span>
            </button>
        </div>

        <div class="visible-count-display" id="visibleTagCount">
            Loading tags...
        </div>

        <div class="tags-list-container" id="tagsListContainer">
            <!-- Tags will be loaded dynamically via JavaScript -->
        </div>

        <div class="loading-indicator hidden" id="loadingIndicator" style="text-align: center; padding: 20px; color: #888;">
            Loading more tags...
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tags.js') }}"></script>
    <script src="{{ url_for('static', filename='js/system-panel.js') }}"></script>
    <script src="{{ url_for('static', filename='js/global-uploader.js') }}"></script>
</body>
</html>